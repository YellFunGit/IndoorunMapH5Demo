function ArrayList(){this.count=0,this.head=new ArrayListNode(null),this.tail=new ArrayListNode(null),this.head.next=this.tail,this.tail.prev=this.head}function ArrayListNode(t){this.next=null,this.prev=null,this.value=t}function ArrayListIter(t,i){this.head=t,this.tail=i,this.cursor=t}function IndexMinPQ(t){this.size=t,this.count=0,this.pq=new Array(t+1),this.qp=new Array(t+1),this.keys=new Array(t+1);for(var i=0;i<=this.size;i++)this.qp[i]=-1,this.keys[i]=Number.MAX_VALUE}function DodecahedronMesh(t,i){this._init(t,i)}function HexahedronMesh(t,i){this._init(t,i)}function IcosahedronMesh(t,i){this._init(t,i)}function MeshBuffer(t){this.gl=t,this.attributes={}}function OctahedronMesh(t,i){this._init(t,i)}function TetrahedronMesh(t,i){this._init(t,i)}function RawPanorama(t,i){this.gl=t,this.region=i,this.cubeVBO=null,this.cubeSize=0,this.cubeMap=null,this._initCube(),this.modelMat=YFM.Math.Matrix.rotate3d(90,1,0,0)}function Floor(t,i,e,r,s,o,a,h,n,u){this.loaded=!1,this.gl=t,this.id=i,this.deflection=null!=r?r:0,this.region=s,this.index=o,this.loadListener=a,this.mapWidth=0,this.mapHeight=0,this.vOffset=0,this.unitHeight=h,this.wallHeight=n,this.isUnitExtrude=u,this.regUnit=/^unit/,this.regWall=/^wall/,this.regIcon=/^icon/g,this.unitExtrude=new FloorExtrude(t,this.unitHeight),this.wallExtrude=new FloorExtrude(t,this.wallHeight),this.quickPolygon=new FloorQuickPolygon(t,h+2),this.quadTree=null,this.icons=null,this.models=null,this.markers=new FloorMarkers(this.gl,this.region,this),this.quickIcons=new FloorQuickIcons(this.gl,this.region,this),this.dummyUnitList=[],this.BBCheck=-1;var l=this;if(null===this.loadListener)l._load_svg(l,e);else{var c=new XMLHttpRequest;c.open("GET",e,!0),c.responseType="text",c.onload=function(t){200==this.status?(console.log("-ajax request ok"),l._load_svg(l,this.response),l.loadListener.onLoadFinish(l)):(l.loadListener.onLoadFailed(l,this.status),console.log("-ajax error:%d",this.status))},c.send()}}function FloorExtrude(t,i){this.gl=t,this.height=i,this.extrudeTopVBO=null,this.extrudeTopSize=0,this.extrudeTopVarray=[],this.extrudeSideVBO=null,this.extrudeSideSize=0,this.extrudeSideVarray=[],this.borderVBO=null,this.borderSize=0,this.borderVarray=[],this.borderNormal=YFM.Math.Vector.vec(0,0,1),this.loaded=!1}function FloorIconPlus(t,i,e){this.gl=t,this.region=i,this.floor=e,this.quadTree=new FloorQuadTree(e,100),this._makeVBO()}function FloorIcons(t,i,e){this.gl=t,this.region=i,this.floor=e,this.quadTree=new FloorQuadTree(e,100),this.iconTex=null;var r=[];r.push(YFM.Math.Vector.pos(-1,-1,0)),r.push(YFM.Math.Vector.pos(1,-1,0)),r.push(YFM.Math.Vector.pos(1,1,0)),r.push(YFM.Math.Vector.pos(-1,1,0));var s,o=[];for(s=0;s<16;s++)this._calcTexCoords(o,r,s);this.quadVBO=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.quadVBO),this.gl.bufferData(this.gl.ARRAY_BUFFER,YFM.Math.flatten(o,3),this.gl.STATIC_DRAW),this.quadBufferSize=o.length/2}function FloorMarkers(t,i,e){this.gl=t,this.region=i,this.floor=e,this.markerArray=[],this.markerIMinPQ=new IndexMinPQ(32),this.markerSorted=[],this.light=YFM.Math.Vector.vec(.5,.5,1),this.orgPos=YFM.Math.Vector.pos(0,0,0),null===FloorMarkers.prototype.quadVBO&&this._initQuad(t)}function FloorModels(t,i,e,r){this.gl=t,this.region=i,this.floor=e,this.vPitch=r,this.quadTree=new FloorQuadTree(e,r)}function FloorQuickIcons(t,i,e,r){this.gl=t,this.region=i,this.floor=e,this.height=r||10,this.tex=null,this.texName=null,this.pointsVBO=null,this.pointsSize=0,this.pointsVarray=[]}function FloorQuickPolygon(t,i){this.gl=t,this.height=i||12,this.quickPolygonVBO=null,this.quickPolygonSize=0,this.quickPolygonVarray=[],this.loaded=!1}function AnimationMgr(t,i,e,r){this.region=t,this.camera=i,this.touchMgr=e,this.listener=r,this.seq=new ArrayList,this.mover=new Mover,this.mover.setMaxForce(16),this.mover.setMaxSpeed(16),this.current=null}function Animation(t,i,e){this.tag=t,this.type=i,this.frame=e,this.step=0}function Region(t,i,e,r,s,o,a){this.id=t,this.matRegion=YFM.Math.Matrix.mat(),this.unitHeight=s||20,this.wallHeight=o||20,void 0===a&&(this.isUnitExtrude=!0),this.glCanvas=i,this.gl=YFM.WebGL.setupWebGL(i),this.gl.viewport(0,0,i.width,i.height),this.gl.clearColor(.9,.9,.9,1),YFM.gGL=this.gl,this.hh=i.height/2,this.hw=i.width/2,this.tqct=new TextBlockQuickCheckTree(e.width,e.height),this.txtCanvas=e,this.ctx2d=e.getContext("2d"),this.ctx2d.font="24px Microsoft YaHei",this.ctx2d.fillStyle="#FF0000",this.ctx2d.textAlign="center",this.ctx2d.textBaseline="middle",this.fontHeight=this._determineFontHeight("font: "+this.ctx2d.font+";"),this.camera=new DeviceOrientationCamera,this.camera.setPerspective(60,i.width/i.height,60,2e4),this.camera.setLookOffset(0,0,-400),this.orthMat=YFM.Math.Matrix.orthographic(-i.width/2,i.width/2,-i.height/2,i.height/2,-1,1),this.renderParam={projMat:null,viewMat:null,vrMat:null,bivrMat:null,pvrMat:null},this.listener=r,this.floors=[],this.baseColorShader=new BaseColorProgram(this.gl),this.basePhongShader=new BasePhongProgram(this.gl),this.selectColorShader=new SelectColorProgram(this.gl),this.regionPhongShader=new RegionPhongProgram(this.gl),this.billboardIconShader=new BillboardIconProgram(this.gl),this.marker2DShader=new Marker2DProgram(this.gl),this.color2DShader=new Color2DProgram(this.gl),this.pointSpiritShader=new PointSpiritProgram(this.gl),this.panoramaShader=new RawPanoramaProgram(this.gl),this.modelPhongShader=new ModelPhongProgram(this.gl),this.ssrShader=new SSRProgram(this.gl,this),this.maxSize=0,this.vPitch=0,this.displayFloorIndex=-1,this.azimuth=0;var h=this;this.touchMgr=new RegionTouchMgr(this.camera,e,this.ctx2d,this,{onClick:function(t,i){h.listener&&h.listener.onClick&&h.listener.onClick(t,i)},onDClick:function(t,i){h.listener&&h.listener.onDClick&&h.listener.onDClick(t,i)},on2FClick:function(t,i){h.listener&&h.listener.on2FClick&&h.listener.on2FClick(t,i)},onLongPressUp:function(t,i){h.listener&&h.listener.onLongPressUp&&h.listener.onLongPressUp(t,i)},onScroll:function(t,i){h.listener&&h.listener.onScroll&&h.listener.onScroll(t,i)}}),this.animMgr=new AnimationMgr(this,this.camera,this.touchMgr,{onAnimStart:function(t){h.listener&&h.listener.onAnimStart(t)},onAnimFinish:function(t){h.listener&&h.listener.onAnimFinish(t)},onAnimCancle:function(t){h.listener&&h.listener.onAnimCancel(t)}}),this.panorama=new RawPanorama(this.gl,this),this.locMarker=new RegionLocMarker(this.gl,20,2152900137,3992977408,this),this.frustum=new FrustumWorldSpace,this.route=new SSRoute(this),this.texturePool=new TexturePool(this.gl),this.extrudeLightNormal=YFM.Math.Vector.normalize(YFM.Math.Vector.vec(.5,.5,1)),this.extrudeLightOver=YFM.Math.Vector.normalize(YFM.Math.Vector.vec(0,1,1)),this.extrudeLight=this.extrudeLightNormal,this.modelLight=YFM.Math.Vector.normalize(YFM.Math.Vector.vec(-1,-1,1)),this.overlook=!1,this.drawUnitTextAlways=!1,this.drawAllUnit=!1,this.customFloorHeight=null,this.status=YFM.Map.STATUS_TOUCH,this.listener&&this.listener.onStatusChange(this.status)}function RegionLocMarker(t,i,e,r,s){var o=YFM.Math.Vector,a=YFM.WebGL.Color;this.gl=t,this.size=i,this.faceColor=o.vec(a.hexColorRed(e),a.hexColorGreen(e),a.hexColorBlue(e),a.hexColorAlpha(e)),this.lineColor=o.vec(a.hexColorRed(r),a.hexColorGreen(r),a.hexColorBlue(r),a.hexColorAlpha(r)),this.region=s,this.waveRadius=o.vec(12,12),this.waveMax=48,this.waveMin=12,this.waveStep=(this.waveMax-this.waveMin)/56,this.locMarkerTexName=null,this.locMarker=null,this.regionLoc=YFM.Math.Vector.pos(0,0,0),this.floorLoc={floor:-1,x:0,y:0},this.anim={floor:0,dist:.1,flag:!1,mover:new Mover(0,0,0),target:null},this._init(t,i)}function RegionTouchMgr(t,i,e,r,s){function o(t){if(h.enable)switch(t.preventDefault(),h._updateEventLayerPos(t),t.type){case"touchstart":h.strategy.touchDown(t);break;case"touchmove":h.strategy.touchMove(t);break;case"touchend":h.strategy.touchUp(t);break;case"touchcancel":h.strategy.touchCancel(t)}}function a(t){if(h.enable)switch(t.preventDefault(),t.type){case"mousedown":h._updateEventLayerPos(t),h.strategy_desktop.mouseDown(t);break;case"mouseup":h._updateEventLayerPos(t),h.strategy_desktop.mouseUp(t);break;case"mouseleave":h._updateEventLayerPos(t),h.strategy_desktop.mouseLeave(t);case"mousemove":h._updateEventLayerPos(t),h.strategy_desktop.mouseMove(t);break;case"mousewheel":h._updateEventLayerPos(t),h.strategy_desktop.mouseWheel(t);break;case"keypress":h.strategy_desktop.keyPress(t)}}this.hangUp=!1,this.camera=t,this.canvas=i,this.ctx2d=e,this.region=r,this.listener=s,this.touchFloorIndex=-1,this.focusFloorDirty=!0,this.enable=!0,this.isMobile=this._isMobileBrowser(),this.uiScaleRate=1,this.overlook=!1,this.longPressFlag=!1,this.touchRec={savedmat:YFM.Math.Matrix.matClone(r._getRegionMat()),pitchCnt:0,degree:0,screenSpacing:0,viewSpacing:0,radius0x:0,radius0y:0,layer0x:0,layer0y:0,layer1x:0,layer1y:0,dy0:0,dy1:0,start0x:0,start0y:0,start1x:0,start1y:0,pre0y:0,pre1y:0,midX:0,midY:0},this.planeRec={planeHeight:0,midpos:null,start0:null,start1:null,prev:null,translateX:0,translateY:0,firstAngle:0},this.viewZoom={max:3e3,min:150};var h=this;this.strategy_desktop={timeStampPrev:0,timeStampCur:0,clickFlag:!1,pitchLock:!1,rotateLock:!1,zoomLock:!1,zoomTarget:null,deltaPitch:0,deltaAngle:0,mousePressed:!1,mouseDown:function(t){this.timeStampPrev=this.timeStampCur,this.timeStampCur=(new Date).getTime(),h.planeRec.planeHeight=h._touch_plane_height(h.touchRec.layer0x,h.touchRec.layer0y),h.touchRec.savedmat=YFM.Math.Matrix.matClone(h.region._getRegionMat()),h.planeRec.start0=h._pos_in_world_space(h.touchRec.layer0x,h.touchRec.layer0y),h.planeRec.translateX=0,h.planeRec.translateY=0,this.mousePressed=!0,this.rotateLock=!1,this.pitchLock=!1,this.zoomLock=!1},mouseUp:function(t){var i=(new Date).getTime(),e=h.planeRec.translateX,r=h.planeRec.translateY;if(!(this.rotateLock||this.pitchLock||this.zoomLock)){if(this.clickFlag){var s=i-this.timeStampPrev;e*e+r*r<100&&s<200&&h._onDClick(h.touchRec.layer0x,h.touchRec.layer0y),this.clickFlag=!1}else{var o=i-this.timeStampCur;if(e*e+r*r<100)if(o<100){this.clickFlag=!0;var a=this;setTimeout(function(){a.clickFlag&&(a.clickFlag=!1,h._onClick(h.touchRec.layer0x,h.touchRec.layer0y))},200)}else o>800&&h._onLongPressUp(h.touchRec.layer0x,h.touchRec.layer0y)}this.mousePressed=!1,this.deltaAngle=0,this.deltaPitch=0}},mouseLeave:function(t){this.mousePressed=!1,this.deltaAngle=0,this.deltaPitch=0},mouseMove:function(t){if(h.enable&&(this.mousePressed&&YFM.Map.STATUS_TOUCH!==h.region.getStatus()&&h.region.setStatus(YFM.Map.STATUS_TOUCH),this.mousePressed&&!this.pitchLock&&!this.rotateLock&&!this.zoomLock)){var i=h._pos_in_world_space(h.touchRec.layer0x,h.touchRec.layer0y);h.planeRec.translateX=i[0]-h.planeRec.start0[0],h.planeRec.translateY=i[1]-h.planeRec.start0[1];var e=YFM.Math.Matrix.postTranslate(h.touchRec.savedmat,h.planeRec.translateX,h.planeRec.translateY,0);if(h.region.displayFloorIndex===h.touchFloorIndex&&h._mapConstraint(h.camera.getPVMat(),e))return;h.region._setRegionMat(e),h._onScroll(h.planeRec.translateX,h.planeRec.translateY),h.focusFloorDirty=!0}},mouseWheel:function(t){if(h.enable&&(this.zoomLock||(this.zoomLock=!0),this.zoomLock)){var i=-t.wheelDelta/2;h.planeRec.planeHeight=h._touch_plane_height(h.touchRec.layer0x,h.touchRec.layer0y);var e=h._world_to_view(h._pos_in_world_space(h.touchRec.layer0x,h.touchRec.layer0y)),r=YFM.Math.Vector.pos(0,0,0),s=YFM.Math.Vector.sub(r,e),o=YFM.Math.Vector.normalize(s),a=h.camera.getLookOffset();i>0?YFM.Math.Vector.norm3(a)>=h.viewZoom.max&&(i=0):i<0&&(0===h.touchFloorIndex||h.region.displayFloorIndex===h.touchFloorIndex)&&YFM.Math.Vector.norm3(s)<=h.viewZoom.min&&(i=0),YFM.Math.Vector.scaleTo(o,i),YFM.Math.Vector.subTo(a,a,o),h.camera.setLookOffset(a[0],a[1],a[2]),h.focusFloorDirty=!0}},keyPress:function(t){if(h.enable&&this.mousePressed){var i=!1,e=!1;if("a"===t.key?(this.deltaAngle+=1,i=!0):"d"===t.key?(this.deltaAngle-=1,i=!0):"w"==t.key?(this.deltaPitch=-1,e=!0):"s"==t.key&&(this.deltaPitch=1,e=!0),!this.rotateLock&&i&&(this.rotateLock=!0,h.touchRec.savedmat=YFM.Math.Matrix.matClone(h.region._getRegionMat()),h.planeRec.start0=h._pos_in_world_space(h.touchRec.layer0x,h.touchRec.layer0y),this.deltaAngle=0),this.rotateLock){var r=YFM.Math.Matrix.postRotateXY(h.touchRec.savedmat,this.deltaAngle,h.planeRec.start0[0],h.planeRec.start0[1]);h.region._setRegionMat(r),h.focusFloorDirty=!0}if(!this.pitchLock&&e){var s=h.planeRec.start0=h._pos_in_world_space(h.touchRec.layer0x,h.touchRec.layer0y);h.camera.resetLookOffsetTan(),h.region.lookAtWorldLoc(s[0],s[1],s[2]),this.pitchLock=!0}if(this.pitchLock){var o=h.camera.getPitch();(o+=this.deltaPitch)<=-45&&this.deltaPitch<0?o=-45:o>=0&&this.deltaPitch>0?(o=0,h.overlook||(h.region._onOverlook(!0),h.overlook=!0)):o<=0&&this.deltaPitch<0&&h.overlook&&(h.region._onOverlook(!1),h.overlook=!1),h.camera.setPitch(o),h.focusFloorDirty=!0}}}},this.strategy_none={name:"none",timeStampPrev:0,timeStampCur:0,clickFlag:!1,twoFingerClickFlag:!1,timeStampTwoFinger:0,mouseDown:function(t){h._onMouseDown(h.touchRec.layer0x,h.touchRec.layer0y)},touchDown:function(t){if(this.timeStampPrev=this.timeStampCur,this.timeStampCur=(new Date).getTime(),h.longPressFlag=!1,1==t.touches.length)h.planeRec.planeHeight=h._touch_plane_height(h.touchRec.layer0x,h.touchRec.layer0y),h.hangUp=!1,h.touchRec.savedmat=YFM.Math.Matrix.matClone(h.region._getRegionMat()),h.touchRec.start0x=h.touchRec.layer0x,h.touchRec.start0y=h.touchRec.layer0y,h.touchRec.radius0x=t.touches[0].radiusX,h.touchRec.radius0y=t.touches[0].radiusY,h.planeRec.prev=h.planeRec.start0=h._pos_in_world_space(h.touchRec.layer0x,h.touchRec.layer0y),h.planeRec.translateX=0,h.planeRec.translateY=0;else if(t.touches.length>1){if(!h.enable)return;this.startTime=t.timeStamp,h.planeRec.planeHeight=h._touch_plane_height(h.touchRec.layer0x,h.touchRec.layer0y),h.hangUp=!1,h.touchRec.savedmat=YFM.Math.Matrix.matClone(h.region._getRegionMat()),h.touchRec.start0x=h.touchRec.layer0x,h.touchRec.start0y=h.touchRec.layer0y,h.touchRec.radius0x=t.touches[0].radiusX,h.touchRec.radius0y=t.touches[0].radiusY,h.planeRec.prev=h.planeRec.start0=h._pos_in_world_space(h.touchRec.layer0x,h.touchRec.layer0y),h.planeRec.translateX=0,h.planeRec.translateY=0,h.touchRec.start1x=h.touchRec.layer1x,h.touchRec.start1y=h.touchRec.layer1y,h.planeRec.start1=h._pos_in_world_space(h.touchRec.layer1x,h.touchRec.layer1y),h.touchRec.screenSpacing=h._spacingScreenSpace(h.touchRec.start0x,h.touchRec.start0y,h.touchRec.start1x,h.touchRec.start1y),h.touchRec.viewSpacing=h._spacingViewSpace(h.touchRec.start0x,h.touchRec.start0y,h.touchRec.start1x,h.touchRec.start1y).spacing,h.planeRec.midpos=h._midpoint(h.touchRec.layer0x,h.touchRec.layer0y,h.touchRec.layer1x,h.touchRec.layer1y),h.planeRec.firstAngle=h._calc_angle(t),h.strategy=h.strategy_multi}},touchMove:function(t){if(h.enable){var i,e;i=h.touchRec.layer0x-h.touchRec.start0x,e=h.touchRec.layer0y-h.touchRec.start0y,1==t.touches.length&&i*i+e*e>100&&(h.strategy=h.strategy_scroll)}},touchUp:function(t){var i=(new Date).getTime();if(this.clickFlag)i-this.timeStampPrev<300&&h._onDClick(h.touchRec.start0x,h.touchRec.start0y),this.clickFlag=!1;else{var e=i-this.timeStampCur;if(e<100){this.clickFlag=!0;var r=this;setTimeout(function(){r.clickFlag&&(r.clickFlag=!1,r.twoFingerClickFlag?r.twoFingerClickFlag=!1:h._onClick(h.touchRec.start0x,h.touchRec.start0y))},300)}else e>800&&(h.longPressFlag||h._onLongPressUp(h.touchRec.start0x,h.touchRec.start0y))}0==t.touches.length&&(h.hangUp=!1)},touchCancel:function(t){h.hangUp=!1}},this.strategy_multi={name:"multi",mouseDown:function(t){h._onMouseDown(h.touchRec.layer0x,h.touchRec.layer0y)},touchDown:function(t){},touchMove:function(t){h.touchRec.pitchCnt=0,h.strategy=h.strategy_rotate},touchUp:function(t){h.hangUp=!1,(new Date).getTime()-h.strategy_none.timeStampCur<100&&(h.touchRec.screenSpacing<300&&h._on2FClick(h.touchRec.start0x,h.touchRec.start0y),h.strategy_none.twoFingerClickFlag=!0),h.strategy=h.strategy_none},touchCancel:function(t){h.strategy=h.strategy_none,h.hangUp=!1}},this.strategy_scroll={name:"scroll",mouseDown:function(t){h._onMouseDown(h.touchRec.layer0x,h.touchRec.layer0y)},touchDown:function(t){t.touches.length>1&&(h.touchRec.savedmat=YFM.Math.Matrix.matClone(h.region._getRegionMat()),h.touchRec.start0x=h.touchRec.layer0x,h.touchRec.start0y=h.touchRec.layer0y,h.touchRec.start1x=h.touchRec.layer1x,h.touchRec.start1y=h.touchRec.layer1y,h.touchRec.screenSpacing=h._spacingScreenSpace(h.touchRec.layer0x,h.touchRec.layer0y,h.touchRec.layer1x,h.touchRec.layer1y),h.touchRec.viewSpacing=h._spacingViewSpace(h.touchRec.layer0x,h.touchRec.layer0y,h.touchRec.layer1x,h.touchRec.layer1y).spacing,h.planeRec.midpos=h._midpoint(h.touchRec.layer0x,h.touchRec.layer0y,h.touchRec.layer1x,h.touchRec.layer1y),h.planeRec.firstAngle=h._calc_angle(t),h.strategy=h.strategy_multi)},touchMove:function(t){YFM.Map.STATUS_TOUCH!==h.region.getStatus()&&h.region.setStatus(YFM.Map.STATUS_TOUCH);var i=h._pos_in_world_space(h.touchRec.layer0x,h.touchRec.layer0y);h.planeRec.translateX=i[0]-h.planeRec.start0[0],h.planeRec.translateY=i[1]-h.planeRec.start0[1],h.planeRec.prev=i;var e=YFM.Math.Matrix.postTranslate(h.touchRec.savedmat,h.planeRec.translateX,h.planeRec.translateY,0);if(h.region.displayFloorIndex===h.touchFloorIndex){var r,s,o,a,n,u,l,c,M=YFM.Math.Matrix,g=YFM.Math.Vector;r=g.pos(0,0,-1),s=g.pos(0,0,1),n=M.mul(h.camera.getPVMat(),h.region.matRegion),u=M.invert(n),o=M.mulVec(u,r),a=M.mulVec(u,s),o[0]/=o[3],o[1]/=o[3],o[2]/=o[3],o[3]/=o[3],a[0]/=a[3],a[1]/=a[3],a[2]/=a[3],a[3]/=a[3],l=YFM.Math.Line.linePP(o,a),n=M.mul(h.camera.getPVMat(),e),u=M.invert(n),o=M.mulVec(u,r),a=M.mulVec(u,s),o[0]/=o[3],o[1]/=o[3],o[2]/=o[3],o[3]/=o[3],a[0]/=a[3],a[1]/=a[3],a[2]/=a[3],a[3]/=a[3],c=YFM.Math.Line.linePP(o,a);var d=h.region.floors[h.touchFloorIndex],p=d.intersectionLine(l);if(d.intersectionLine(c)<p)return}h.region._setRegionMat(e),h._onScroll(h.planeRec.translateX,h.planeRec.translateY),h.focusFloorDirty=!0},touchUp:function(t){(new Date).getTime(),h.strategy_none.timeStampCur;h.hangUp=!1,h.strategy=h.strategy_none,t.touches.length},touchCancel:function(t){h.hangUp=!1,h.strategy=h.strategy_none}},this.strategy_rotate={name:"rotate",mouseDown:function(t){},touchDown:function(t){},touchMove:function(t){h.camera.getPVMat();if(!(h.hangUp||t.touches.length<2)){if(YFM.Map.STATUS_TOUCH!==h.region.getStatus()){var i=h._spacingScreenSpace(h.touchRec.layer0x,h.touchRec.layer0y,h.touchRec.layer1x,h.touchRec.layer1y),e=h.touchRec.screenSpacing-i,r=-h.camera.getLookOffsetNormal();return(r+=e/20)>h.viewZoom.max?r=h.viewZoom.max:r<h.viewZoom.min&&(r=h.viewZoom.min),void h.camera.setLookOffset(0,0,-r)}var s=h.touchRec.layer0y-h.touchRec.start0y;if(s*(h.touchRec.layer1y-h.touchRec.start1y)>0){var e=s/256,o=h.camera.getPitch();(o+=e)<=-45&&e<0?o=-45:o>=0&&e>0?(o=0,h.overlook||(h.region._onOverlook(!0),h.overlook=!0)):o<=0&&e<0&&h.overlook&&(h.region._onOverlook(!1),h.overlook=!1),h.camera.getPitch(),h.camera.setPitch(o)}if(!((i=h._spacingScreenSpace(h.touchRec.layer0x,h.touchRec.layer0y,h.touchRec.layer1x,h.touchRec.layer1y))<200)){var a=h._spacingViewSpace(h.touchRec.layer0x,h.touchRec.layer0y,h.touchRec.layer1x,h.touchRec.layer1y),n=h._calc_angle(t)-h.planeRec.firstAngle,u=YFM.Math.Matrix.postRotateXY(h.touchRec.savedmat,n,h.planeRec.midpos[0],h.planeRec.midpos[1],!0),l=(h.touchRec.viewSpacing-a.spacing)/2;l<0&&a.z<0&&a.z>-20&&(l=-30);var c=h._world_to_view(h.planeRec.midpos),M=YFM.Math.Vector.pos(0,0,0),g=YFM.Math.Vector.sub(M,c),e=YFM.Math.Vector.normalize(g),d=h.camera.getLookOffset();l>0?YFM.Math.Vector.norm3(d)>=h.viewZoom.max&&(l=0):l<0&&(0===h.touchFloorIndex||h.region.displayFloorIndex===h.touchFloorIndex)&&YFM.Math.Vector.norm3(g)<=h.viewZoom.min&&(l=0),YFM.Math.Vector.scaleTo(e,l);var p=YFM.Math.Vector.sub(d,e);h.camera.setLookOffset(p[0],p[1],p[2]),h.region._setRegionMat(u),h.focusFloorDirty=!0}}},touchUp:function(t){t.touches.length>1?h.hangUp=!0:t.touches.length>=0?(h.hangUp=!1,h.strategy=h.strategy_none,h.longPressFlag=!0,h.touchRec.savedmat=YFM.Math.Matrix.matClone(h.region._getRegionMat()),h.touchRec.start0x=h.touchRec.layer0x,h.touchRec.start0y=h.touchRec.layer0y,h.planeRec.prev=h.planeRec.start0=h._pos_in_world_space(h.touchRec.layer0x,h.touchRec.layer0y),h.planeRec.translateX=0,h.planeRec.translateY=0,(new Date).getTime()-h.strategy_none.timeStampCur<100&&(h.touchRec.screenSpacing<300&&h._on2FClick(h.touchRec.start0x,h.touchRec.start0y),h.strategy_none.twoFingerClickFlag=!0)):h.strategy=h.strategy_none},touchCancel:function(t){h.hangUp=!1,h.strategy=h.strategy_none}},this.strategy=this.strategy_none,this.isMobile?(i.addEventListener("touchstart",o,!1),i.addEventListener("touchmove",o,!1),i.addEventListener("touchend",o,!1),i.addEventListener("touchcancel",o,!1)):(document.onkeypress=a,i.addEventListener("mousedown",a,!1),i.addEventListener("mouseup",a,!1),i.addEventListener("mousemove",a,!1),i.addEventListener("mouseleave",a,!1),i.addEventListener("mousewheel",a,!1))}function SSRoute(t){this.region=t,this.time=0,this.width=8,this.stepLen=128,this.dataLoad=!1,this.rotateLeft=YFM.Math.Matrix.rotateXY(90,0,0),this.rotateRight=YFM.Math.Matrix.rotateXY(-90,0,0),this.routeHeight=30,this.displayFloor=-1,this.polylineZ=null,this.handledPts=null,this.routeData=null,this.light=YFM.Math.Vector.vec(0,0,1),this.tailSize=this.width,this.tailColor=YFM.Math.Vector.pos(YFM.WebGL.Color.hexColorRed(47925),YFM.WebGL.Color.hexColorGreen(47925),YFM.WebGL.Color.hexColorBlue(47925)),this.updateNSFlag=!0,this.naviStatus={projection:null,miniOffset:0,validate:!1,projDist:0,goalDist:0,globalDist:0,serialDist:0,nextSerialDist:0,azimuth:0,sug:YFM.Map.Navigate.Suggestion.NONE,nextSug:YFM.Map.Navigate.NextSuggestion.NONE},this._initTail()}function RouteSeg(t,i,e){this.start=t,this.end=i,this.floor=e,this.segVec=YFM.Math.Vector.sub(this.end,this.start),this.lenSQ=YFM.Math.Vector.dot3(this.segVec,this.segVec),this.len=Math.sqrt(this.lenSQ),this.azimuth=this._makeAzimuth(),this.followLen=0}function FloorRoute(t,i,e){this.floor=t,this.region=i,this.route=e,this.segList=[],this.posList=[],this.lastPos=null,this.box=null,this.lastSegVec=null}function Euler(t,i,e,r){this.x=t||0,this.y=i||0,this.z=e||0,this.order=r||Euler.DefaultOrder}function Quaternion(t,i,e,r){this.x=t||0,this.y=i||0,this.z=e||0,this.w=void 0!==r?r:1}function PlanePolygon(t){this.barrier=[],this.plane=this._makePlanePts(t)}function Mover(t,i,e){this.mass=this.DEFAULT_MASS,this.maxForce=this.DEFAULT_MAX_FORCE,this.maxSpeed=this.DEFAULT_MAX_SPEED,this.location=YFM.Math.Vector.pos(t||0,i||0,e||0),this.velocity=YFM.Math.Vector.vec(0,0,0),this.acceleration=YFM.Math.Vector.vec(0,0,0)}function FloorQuadTree(t,i){this.floor=t,this.root=new FloorQuadNode(null,t,0,t.mapWidth,0,t.mapHeight,i,"0",0),this.objMap={}}function FloorQuadNode(t,i,e,r,s,o,a,h,n){this.parentNode=t,this.floor=i,this.xmin=e,this.xmax=r,this.ymin=s,this.ymax=o,this.height=a,this.mask=h,this.level=n;var u,l,c,M,g=[];u=i.floorPos2Region(e,s),l=i.floorPos2Region(r,s),c=i.floorPos2Region(r,o),M=i.floorPos2Region(e,o),g.push(YFM.Math.Vector.pos(u[0],u[1],u[2]-100)),g.push(YFM.Math.Vector.pos(l[0],l[1],l[2]-100)),g.push(YFM.Math.Vector.pos(c[0],c[1],c[2]-100)),g.push(YFM.Math.Vector.pos(M[0],M[1],M[2]-100)),g.push(YFM.Math.Vector.pos(u[0],u[1],u[2]+a)),g.push(YFM.Math.Vector.pos(l[0],l[1],l[2]+a)),g.push(YFM.Math.Vector.pos(c[0],c[1],c[2]+a)),g.push(YFM.Math.Vector.pos(M[0],M[1],M[2]+a)),this.obb=new OBB(g),this.objectList=[],this.children=new Array(null,null,null,null),this.splited=!1}function FrustumWorldSpace(){this.near=YFM.Math.Vector.vec(),this.far=YFM.Math.Vector.vec(),this.left=YFM.Math.Vector.vec(),this.right=YFM.Math.Vector.vec(),this.top=YFM.Math.Vector.vec(),this.bottom=YFM.Math.Vector.vec()}function OBB(t){this.isOBB=!0;var i,e;i=YFM.Math.Matrix.covariance3x3(t),e=YFM.Math.Matrix.eig3x3(i),this.t=YFM.Math.Vector.vec(e.vec[0],e.vec[1],e.vec[2]),this.s=YFM.Math.Vector.vec(e.vec[3],e.vec[4],e.vec[5]),this.r=YFM.Math.Vector.vec(e.vec[6],e.vec[7],e.vec[8]),this._calc_bounding(t)}function TextBlockQuickCheckTree(t,i){this.root=new AABBNode(this,"0",0,0,t,i),this.blockPool=[],this.blockList=[]}function AABBNode(t,i,e,r,s,o){this.tree=t,this.mask=i,this.rect=[e,r,s,o],this.objList=[],this.level<2&&this._splite()}function MtlItem(){this.Ns=32,this.Ka=YFM.Math.Vector.pos(),this.Kd=YFM.Math.Vector.pos(),this.Ks=YFM.Math.Vector.pos(),this.mapKd=null}function ObjModel(t){this.region=t,this.floor=null,this.obb=null,this.gl=t.gl,this.objects=[],this.texturePool=t.texturePool,this.modelMatrix=YFM.Math.Matrix.mat(),this.baseUrl=null,this.hasMaterials=!1,this.materials={}}function CameraRaw(){this.dirty=!0,this.mat_base_view=YFM.Math.Matrix.mat(),this.mat_t_view=YFM.Math.Matrix.mat(),this.mat_r_view=YFM.Math.Matrix.mat(),this.mat_view=YFM.Math.Matrix.mat(),this.mat_projection=YFM.Math.Matrix.mat(),this.mat_pv=YFM.Math.Matrix.mat(),this.mat_ipv=YFM.Math.Matrix.mat(),this.mat_iv=YFM.Math.Matrix.mat()}function DeviceOrientationCamera(){this.dirty=!0,this.mat_base_view=YFM.Math.Matrix.mat(),this.mat_t_view=YFM.Math.Matrix.mat(),this.mat_view=YFM.Math.Matrix.mat(),this.mat_projection=YFM.Math.Matrix.mat(),this.mat_pv=YFM.Math.Matrix.mat(),this.mat_ipv=YFM.Math.Matrix.mat(),this.mat_iv=YFM.Math.Matrix.mat(),this.quaternion=new Quaternion,this.pitchEnable=!0,this.pitch=this.DEFAULT_PITCH,this.lookAt=YFM.Math.Vector.vec(0,0,0),this.lookOffset=YFM.Math.Vector.vec(0,0,-400),this.zee=YFM.Math.Vector.vec(0,0,1),this.q0=new Quaternion(Math.sqrt(.5),0,0,Math.sqrt(.5)),this.q1=new Quaternion(-Math.sqrt(.5),0,0,Math.sqrt(.5)),this.q2=new Quaternion,this.enabled=!1,this.deviceOrientation=null,this.screenOrientation=0,this.roll=0,this.alphaOffsetAngle=0;var t=this,i=function(i){t.deviceOrientation=i,t.dirty=!0},e=function(){t.screenOrientation=window.orientation||0};this.connect=function(){window.addEventListener("deviceorientation",i,!1),window.addEventListener("orientationchange",e,!1),t.enabled=!0,t.pitchEnable=!1,t.dirty=!0},this.disconnect=function(){window.removeEventListener("orientationchange",e,!1),window.removeEventListener("deviceorientation",i,!1),t.enabled=!1,t.deviceOrientation=null,t.pitchEnable=!0,t.quaternion=new Quaternion,t.dirty=!0,t.roll=0},this.ldsN=4,this.ldsIndex=0,this.rgss=[],this.rgss.push(YFM.Math.Vector.vec(0,.25)),this.rgss.push(YFM.Math.Vector.vec(.5,0)),this.rgss.push(YFM.Math.Vector.vec(.75,.5)),this.rgss.push(YFM.Math.Vector.vec(.25,.75))}function BaseColorProgram(t){this.init=!1,this.gl=t,this.program=YFM.WebGL.makeShader(t,this.vshader,this.fshader),this.aPosition=t.getAttribLocation(this.program,"aPosition"),this.aColor=t.getAttribLocation(this.program,"aColor"),this.uModelMat=t.getUniformLocation(this.program,"uModelMat"),this.uFloorMat=t.getUniformLocation(this.program,"uFloorMat"),this.uRegionMat=t.getUniformLocation(this.program,"uRegionMat"),this.uViewMat=t.getUniformLocation(this.program,"uViewMat"),this.uProjectionMat=t.getUniformLocation(this.program,"uProjectionMat"),this.uMapHeight=t.getUniformLocation(this.program,"uMapHeight")}function BasePhongProgram(t){this.init=!1,this.gl=t,this.program=YFM.WebGL.makeShader(t,this.vshader,this.fshader),this.aPosition=t.getAttribLocation(this.program,"aPosition"),this.aColor=t.getAttribLocation(this.program,"aColor"),this.aNormal=t.getAttribLocation(this.program,"aNormal"),this.uModelMat=t.getUniformLocation(this.program,"uModelMat"),this.uFloorMat=t.getUniformLocation(this.program,"uFloorMat"),this.uRegionMat=t.getUniformLocation(this.program,"uRegionMat"),this.uViewMat=t.getUniformLocation(this.program,"uViewMat"),this.uProjectionMat=t.getUniformLocation(this.program,"uProjMat"),this.uNormalMat=t.getUniformLocation(this.program,"uNormalMat"),this.uMapHeight=t.getUniformLocation(this.program,"uMapHeight"),this.uLightPos=t.getUniformLocation(this.program,"uLightPos"),this.uLighting=t.getUniformLocation(this.program,"uLighting")}function BillboardIconProgram(t){this.init=!1,this.gl=t,this.program=YFM.WebGL.makeShader(t,this.vshader,this.fshader),this.aPosition=t.getAttribLocation(this.program,"aPosition"),this.aTexCoord=t.getAttribLocation(this.program,"aTexCoord"),this.uTex=t.getUniformLocation(this.program,"uTex"),this.uModelMat=t.getUniformLocation(this.program,"uModelMat"),this.uRegionMat=t.getUniformLocation(this.program,"uRegionMat"),this.uiViewMat=t.getUniformLocation(this.program,"uiViewMat"),this.uViewMat=t.getUniformLocation(this.program,"uViewMat"),this.uProjectionMat=t.getUniformLocation(this.program,"uProjMat")}function Color2DProgram(t){this.init=!1,this.gl=t,this.program=YFM.WebGL.makeShader(t,this.vshader,this.fshader),this.aPosition=t.getAttribLocation(this.program,"aPosition"),this.uColor=t.getUniformLocation(this.program,"uColor"),this.uModelMat=t.getUniformLocation(this.program,"uModelMat"),this.uProjectionMat=t.getUniformLocation(this.program,"uProjMat")}function Marker2DProgram(t){this.init=!1,this.gl=t,this.program=YFM.WebGL.makeShader(t,this.vshader,this.fshader),this.aPosition=t.getAttribLocation(this.program,"aPosition"),this.aTexCoord=t.getAttribLocation(this.program,"aTexCoord"),this.uTex=t.getUniformLocation(this.program,"uTex"),this.uModelMat=t.getUniformLocation(this.program,"uModelMat"),this.uProjectionMat=t.getUniformLocation(this.program,"uProjMat")}function ModelPhongProgram(t){this.init=!1,this.gl=t,this.program=YFM.WebGL.makeShader(t,this.vshader,this.fshader),this.aPosition=t.getAttribLocation(this.program,"aPosition"),this.aNormal=t.getAttribLocation(this.program,"aNormal"),this.aTexCoord=t.getAttribLocation(this.program,"aTexCoord"),this.uNs=t.getUniformLocation(this.program,"uNs"),this.uKa=t.getUniformLocation(this.program,"uKa"),this.uKd=t.getUniformLocation(this.program,"uKd"),this.uKs=t.getUniformLocation(this.program,"uKs"),this.uTexFlag=t.getUniformLocation(this.program,"uTexFlag"),this.uTex=t.getUniformLocation(this.program,"uTex"),this.uColorFlag=t.getUniformLocation(this.program,"uColorFlag"),this.uColor=t.getUniformLocation(this.program,"uColor"),this.uModelMat=t.getUniformLocation(this.program,"uModelMat"),this.uFloorMat=t.getUniformLocation(this.program,"uFloorMat"),this.uRegionMat=t.getUniformLocation(this.program,"uRegionMat"),this.uViewMat=t.getUniformLocation(this.program,"uViewMat"),this.uProjectionMat=t.getUniformLocation(this.program,"uProjMat"),this.uNormalMat=t.getUniformLocation(this.program,"uNormalMat"),this.uLightPos=t.getUniformLocation(this.program,"uLightPos"),this.defaultNs=32,this.defaultColor=YFM.Math.Vector.pos(1,1,1),this.defaultKa=YFM.Math.Vector.pos(.3,.3,.3),this.defaultKd=YFM.Math.Vector.pos(1,1,1),this.defaultKs=YFM.Math.Vector.pos(.1,.1,.1)}function PointSpiritProgram(t){this.init=!1,this.gl=t,this.program=YFM.WebGL.makeShader(t,this.vshader,this.fshader),this.aPosition=t.getAttribLocation(this.program,"aPosition"),this.uTex=t.getUniformLocation(this.program,"uTex"),this.uRegionMat=t.getUniformLocation(this.program,"uRegionMat"),this.uViewMat=t.getUniformLocation(this.program,"uViewMat"),this.uProjectionMat=t.getUniformLocation(this.program,"uProjMat")}function RawPanoramaProgram(t){this.init=!1,this.gl=t,this.program=YFM.WebGL.makeShader(t,this.vshader,this.fshader),this.aPosition=t.getAttribLocation(this.program,"aPosition"),this.uModelMat=t.getUniformLocation(this.program,"uModelMat"),this.uViewMat=t.getUniformLocation(this.program,"uViewMat"),this.uProjectionMat=t.getUniformLocation(this.program,"uProjectionMat"),this.uTexMap=t.getUniformLocation(this.program,"uTexMap")}function RegionPhongProgram(t){this.init=!1,this.gl=t,this.program=YFM.WebGL.makeShader(t,this.vshader,this.fshader),this.aPosition=t.getAttribLocation(this.program,"aPosition"),this.aNormal=t.getAttribLocation(this.program,"aNormal"),this.uColor=t.getUniformLocation(this.program,"uColor"),this.uModelMat=t.getUniformLocation(this.program,"uModelMat"),this.uRegionMat=t.getUniformLocation(this.program,"uRegionMat"),this.uViewMat=t.getUniformLocation(this.program,"uViewMat"),this.uProjectionMat=t.getUniformLocation(this.program,"uProjMat"),this.uNormalMat=t.getUniformLocation(this.program,"uNormalMat"),this.uLightPos=t.getUniformLocation(this.program,"uLightPos")}function SSRProgram(t,i){this.gl=t,this.program=YFM.WebGL.makeShader(t,this.vshader,this.fshader),this.aPosition=t.getAttribLocation(this.program,"aPosition"),this.aTexCoord=t.getAttribLocation(this.program,"aTexCoord"),this.aLineDist=t.getAttribLocation(this.program,"aLineDist"),this.uTime=t.getUniformLocation(this.program,"uTime"),this.uHH=t.getUniformLocation(this.program,"uHH"),this.uHW=t.getUniformLocation(this.program,"uHW"),this.uTotalLen=t.getUniformLocation(this.program,"uTotalLen"),this.uNaviArg=t.getUniformLocation(this.program,"uNaviArg"),this.uTranFlag=t.getUniformLocation(this.program,"uTranFlag"),this.uLimitFlag=t.getUniformLocation(this.program,"uLimitFlag"),this.uLimitMin=t.getUniformLocation(this.program,"uLimitMin"),this.uLimitMax=t.getUniformLocation(this.program,"uLimitMax"),this.useProgram(),this.setHH(i.hh),this.setHW(i.hw)}function SelectColorProgram(t){this.init=!1,this.gl=t,this.program=YFM.WebGL.makeShader(t,this.vshader,this.fshader),this.aPosition=t.getAttribLocation(this.program,"aPosition"),this.uModelMat=t.getUniformLocation(this.program,"uModelMat"),this.uRegionMat=t.getUniformLocation(this.program,"uRegionMat"),this.uViewMat=t.getUniformLocation(this.program,"uViewMat"),this.uProjectionMat=t.getUniformLocation(this.program,"uProjectionMat"),this.uColor=t.getUniformLocation(this.program,"uColor")}function TexturePool(t){this.gl=t,this.pool={}}function TextureWrap(t,i,e){this.name=t,this.url=i,this.img=e,this.w=0,this.h=0}function VAttribs(t){this.gl=t,this.attributes={}}var YFM={};ArrayList.prototype={constructor:ArrayList,getIter:function(){return new ArrayListIter(this.head,this.tail)},size:function(){return this.count},addHigh:function(t){var i=new ArrayListNode(t);i.prev=this.tail.prev,i.next=this.tail,this.tail.prev.next=i,this.tail.prev=i,this.count+=1},addLow:function(t){var i=new ArrayListNode(t);i.prev=this.head,i.next=this.head.next,this.head.next.prev=i,this.head.next=i,this.count+=1},clean:function(){this.count=0,this.head=new ArrayListNode(null),this.tail=new ArrayListNode(null),this.head.next=this.tail,this.tail.prev=this.head},remove:function(t){var i,e,r;if(t<-this.count||t>this.count-1)i=null;else if(t>=0){for(r=0,e=this.head.next;r<t;r++)e=e.next;i=e.value,e.prev.next=e.next,e.next.prev=e.prev,this.count-=1}else if(t<0){for(r=t,e=this.tail.prev;r<0;r++)e=e.prev;i=e.value,e.prev.next=e.next,e.next.prev=e.prev,this.count-=1}return i},removeHigh:function(){var t;return this.count>=1?(t=this.tail.prev.value,this.tail.prev.prev.next=this.tail,this.tail.prev=this.tail.prev.prev,this.count-=1):t=null,t},removeLow:function(){var t;return this.count>=1?(t=this.head.next.value,this.head.next.next.prev=this.head,this.head.next=this.head.next.next,this.count-=1):t=null,t},get:function(t){var i,e,r;if(t<-this.count||t>this.count-1)throw new Error("Access out of range");if(t>=0){for(r=0,e=this.head.next;r<t;r++)e=e.next;i=e.value}else if(t<0){for(r=t,e=this.tail.prev;r<0;r++)e=e.prev;i=e.value}return i},put:function(t,i){var e,r;if(t<-this.count||t>this.count-1)throw new Error("Access out of range");if(t>=0){for(r=0,e=this.head.next;r<t;r++)e=e.next;e.value=i}else if(t<0){for(r=t,e=this.tail.prev;r<0;r++)e=e.prev;e.value=i}}},ArrayListIter.prototype={constructor:ArrayListIter,hasNext:function(){return this.cursor.next!=this.tail},getNext:function(){var t=this.cursor.next.value;return this.cursor=this.cursor.next,t}},IndexMinPQ.prototype={constructor:IndexMinPQ,clean:function(){this.count=0;for(var t=0;t<=this.size;t++)this.qp[t]=-1,this.keys[t]=Number.MAX_VALUE},setSize:function(t){var i,e;if((i=t-this.size)<0)for(e=i;e<0;e++)this.pq.pop(),this.qp.pop(),this.keys.pop();else if(i>0)for(e=0;e<i;e++)this.pq.push(null),this.qp.push(null),this.keys.push(null);this.size=t,this.clean()},getSize:function(){return this.size},getCount:function(){return this.count},changeKey:function(t,i){if(t<0||t>this.size)throw new Error("IndexMinPQ.changeKey, out of range index:"+t);if(!this.contains(t))throw new Error("IndexMinPQ.changeKey, do not contains index:"+t);this.keys[t]=i,this._swim(this.qp[t]),this._sink(this.qp[t])},decreaseKey:function(t,i){if(t<0||t>this.size)throw new Error("IndexMinPQ.decreaseKey, out of range index:"+t);if(!this.contains(t))throw new Error("IndexMinPQ.decreaseKey, do not contains index:"+t);if(this.keys[t]<=i)throw new Error("IndexMinPQ.decreaseKey, key[i] <= key");this.keys[t]=i,this._swim(this.qp[t])},increaseKey:function(t,i){if(t<0||t>this.size)throw new Error("IndexMinPQ.increaseKey, out of range index:"+t);if(!this.contains(t))throw new Error("IndexMinPQ.increaseKey, do not contains index:"+t);if(this.keys[t]>=i)throw new Error("IndexMinPQ.increaseKey, key[i] <= key");this.keys[t]=i,this._swim(this.qp[t])},deleteMin:function(){if(this.count<=0)throw new Error("IndexMinPQ.deleteMin, empty content");var t;return t=this.pq[1],this._exch(1,this.count),this.count-=1,this._sink(1),this.qp[t]=-1,this.keys[this.pq[this.count+1]]=Number.MAX_VALUE,this.pq[this.count+1]=-1,t},delete:function(t){if(t<0||t>this.size)throw new Error("IndexMinPQ.delete, out of range index:"+t);if(!this.contains(t))throw new Error("IndexMinPQ.delete, do not contains index:"+t);var i=qp[t];this._exch(i,this.count),this.count-=1,this._swim(i),this._sink(i),this.keys[t]=Number.MAX_VALUE,this.qp[t]=-1},contains:function(t){if(t<0||t>this.size)throw new Error("IndexMinPQ.countains, out of range index:"+t);return-1!==this.qp[t]},isEmpty:function(){return 0===this.count},keyOf:function(t){if(t<0||t>this.size)throw new Error("IndexMinPQ.keyOf, out of range index:"+t);if(!this.contains(t))throw new Error("IndexMinPQ.keyOf, do not contains index:"+t);return this.keys[t]},minIndex:function(){if(this.count<=0)throw new Error("IndexMinPQ.minIndex, empty content");return this.pq[1]},minKey:function(){if(this.count<=0)throw new Error("IndexMinPQ.minKey, empty content");return this.keys[this.pq[1]]},indexAt:function(t){if(t<0||t>this.count)throw new Error("IndexMinPQ.indexAt, out of range pos:"+t);return this.pq[t+1]},insert:function(t,i){if(t<0||t>this.size)throw new Error("IndexMinPQ.insert, out of range index:"+t);if(this.contains(t))throw new Error("IndexMinPQ.insert, do contains index:"+t);this.count+=1,this.qp[t]=this.count,this.pq[this.count]=t,this.keys[t]=i,this._swim(this.count)},_exch:function(t,i){if(t<0||t>this.size)throw new Error("IndexMinPQ._exch, out of range i:"+t);if(i<0||i>this.size)throw new Error("IndexMinPQ._exch, out of range j:"+i);var e=this.pq[t];this.pq[t]=this.pq[i],this.pq[i]=e,this.qp[this.pq[t]]=t,this.qp[this.pq[i]]=i},_greater:function(t,i){if(t<0||t>this.size)throw new Error("IndexMinPQ._greater, out of range i:"+t);if(i<0||i>this.size)throw new Error("IndexMinPQ._greater, out of range j:"+i);return this.keys[this.pq[t]]>this.keys[this.pq[i]]},_sink:function(t){var i;if(t<0||t>this.size)throw new Error("IndexMinPQ._sink, out of range k:"+t);for(;2*t<=this.count&&((i=2*t)<this.count&&this._greater(i,i+1)&&i++,this._greater(t,i));)this._exch(t,i),t=i},_swim:function(t){if(t<0||t>this.size)throw new Error("IndexMinPQ._swin, out of range k:"+t);for(;t>1;){var i=Math.round(t/2);if(!this._greater(i,t))break;this._exch(t,i),t=i}}},YFM.Map={},YFM.Map.STATUS_TOUCH=0,YFM.Map.STATUS_SENSOR=1,YFM.Map.STATUS_NAVIGATE=2,YFM.Map.STATUS_TRACE=3,YFM.Map.Navigate={},YFM.Map.Navigate.Suggestion={NONE:"none",FRONT:"front",LEFT:"left",BACKWARD:"backward",RIGHT:"right"},YFM.Map.Navigate.NextSuggestion={NONE:"none",FRONT:"front",LEFT:"left",RIGHT:"right",ARRIVE:"arrive"},YFM.Math={clamp:function(t,i,e){return Math.max(i,Math.min(e,t))},map:function(t,i,e,r,s){return r+(t-i)/(e-i)*(s-r)},deg2Radian:function(t){return 2*t*Math.PI/360},radian2Deg:function(t){return 360*t/(2*Math.PI)},flatten:function(t,i){var e,r=t.length,s=!1;Array.isArray(t[0])&&(s=!0,null==i?(r*=t[0].length,e=t[0].length):(r*=i,e=i));var o=new Float32Array(r);if(s)for(var a=0,h=0;h<t.length;++h)for(var n=0;n<e;++n)o[a++]=t[h][n];else for(h=0;h<t.length;++h)o[h]=t[h];return o},argumentsToArray:function(t){return[].concat.apply([],Array.prototype.slice.apply(t))},floatEquals:function(t,i){return Math.abs(t-i)<=1e-5||(Math.abs(t)>Math.abs(i)?Math.abs((t-i)/t):Math.abs((t-i)/i))<=1e-8},floatNotZero:function(t){return Math.abs(t)>1e-20},vf2str:function(t,i){for(var e="[ ",r=t.length,s=0;s<r;s++)e+=t[s].toFixed(i),e+=", ";return e+="]"},lerp:function(t,i,e){return t+(i-t)*e}},DodecahedronMesh.prototype={constructor:DodecahedronMesh,getMeshVBO:function(){return this.meshVBO},getMeshBufSize:function(){return this.meshBufSize},_init:function(t,i){this.mesh=[],this._dodecahedron(i),this.meshVBO=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.meshVBO),t.bufferData(t.ARRAY_BUFFER,YFM.Math.flatten(this.mesh,3),t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null),this.meshBufSize=this.mesh.length/2,this.mesh=null},_dodecahedron:function(t){var i=(1+Math.sqrt(5))/2,e=1/i,r=[];r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-1,-1,-1))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-1,-1,1))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-1,1,-1))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-1,1,1))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(1,-1,-1))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(1,-1,1))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(1,1,-1))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(1,1,1))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,-e,-i))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,-e,i))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,e,-i))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,e,i))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-e,-i,0))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-e,i,0))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(e,-i,0))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(e,i,0))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-i,0,-e))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(i,0,-e))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-i,0,e))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(i,0,e))),this._divideTriangle(r[3],r[11],r[7],t),this._divideTriangle(r[3],r[7],r[15],t),this._divideTriangle(r[3],r[15],r[13],t),this._divideTriangle(r[7],r[19],r[17],t),this._divideTriangle(r[7],r[17],r[6],t),this._divideTriangle(r[7],r[6],r[15],t),this._divideTriangle(r[17],r[4],r[8],t),this._divideTriangle(r[17],r[8],r[10],t),this._divideTriangle(r[17],r[10],r[6],t),this._divideTriangle(r[8],r[0],r[16],t),this._divideTriangle(r[8],r[16],r[2],t),this._divideTriangle(r[8],r[2],r[10],t),this._divideTriangle(r[0],r[12],r[1],t),this._divideTriangle(r[0],r[1],r[18],t),this._divideTriangle(r[0],r[18],r[16],t),this._divideTriangle(r[6],r[10],r[2],t),this._divideTriangle(r[6],r[2],r[13],t),this._divideTriangle(r[6],r[13],r[15],t),this._divideTriangle(r[2],r[16],r[18],t),this._divideTriangle(r[2],r[18],r[3],t),this._divideTriangle(r[2],r[3],r[13],t),this._divideTriangle(r[18],r[1],r[9],t),this._divideTriangle(r[18],r[9],r[11],t),this._divideTriangle(r[18],r[11],r[3],t),this._divideTriangle(r[4],r[14],r[12],t),this._divideTriangle(r[4],r[12],r[0],t),this._divideTriangle(r[4],r[0],r[8],t),this._divideTriangle(r[11],r[9],r[5],t),this._divideTriangle(r[11],r[5],r[19],t),this._divideTriangle(r[11],r[19],r[7],t),this._divideTriangle(r[19],r[5],r[14],t),this._divideTriangle(r[19],r[14],r[4],t),this._divideTriangle(r[19],r[4],r[17],t),this._divideTriangle(r[1],r[12],r[14],t),this._divideTriangle(r[1],r[14],r[5],t),this._divideTriangle(r[1],r[5],r[9],t)},_divideTriangle:function(t,i,e,r){if(r>0){var s=YFM.Math.Vector.mix(t,i,.5),o=YFM.Math.Vector.mix(t,e,.5),a=YFM.Math.Vector.mix(i,e,.5);s=YFM.Math.Vector.normalize(s),o=YFM.Math.Vector.normalize(o),a=YFM.Math.Vector.normalize(a),this._divideTriangle(t,s,o,r-1),this._divideTriangle(s,i,a,r-1),this._divideTriangle(a,e,o,r-1),this._divideTriangle(s,a,o,r-1)}else this._triangle(t,i,e)},_triangle:function(t,i,e){var r=YFM.Math.Vector.sub(i,t),s=YFM.Math.Vector.sub(e,i),o=YFM.Math.Vector.normalize(YFM.Math.Vector.cross(r,s));this.mesh.push(t),this.mesh.push(o),this.mesh.push(i),this.mesh.push(o),this.mesh.push(e),this.mesh.push(o)}},HexahedronMesh.prototype={constructor:HexahedronMesh,getMeshVBO:function(){return this.meshVBO},getMeshBufSize:function(){return this.meshBufSize},_init:function(t,i){this.mesh=[],this._hexahedron(i),this.meshVBO=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.meshVBO),t.bufferData(t.ARRAY_BUFFER,YFM.Math.flatten(this.mesh,3),t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null),this.meshBufSize=this.mesh.length/2,this.mesh=null},_hexahedron:function(t){var i=[],e=Math.sqrt(2)/2;i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,1,-e))),i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(1,0,-e))),i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,-1,-e))),i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-1,0,-e))),i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,1,e))),i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(1,0,e))),i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,-1,e))),i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-1,0,e))),this._divideTriangle(i[0],i[1],i[3],t),this._divideTriangle(i[3],i[1],i[2],t),this._divideTriangle(i[4],i[7],i[5],t),this._divideTriangle(i[5],i[7],i[6],t),this._divideTriangle(i[7],i[3],i[6],t),this._divideTriangle(i[6],i[3],i[2],t),this._divideTriangle(i[6],i[2],i[5],t),this._divideTriangle(i[5],i[2],i[1],t),this._divideTriangle(i[4],i[5],i[0],t),this._divideTriangle(i[0],i[5],i[1],t),this._divideTriangle(i[7],i[4],i[0],t),this._divideTriangle(i[0],i[3],i[7],t)},_divideTriangle:function(t,i,e,r){if(r>0){var s=YFM.Math.Vector.mix(t,i,.5),o=YFM.Math.Vector.mix(t,e,.5),a=YFM.Math.Vector.mix(i,e,.5);s=YFM.Math.Vector.normalize(s),o=YFM.Math.Vector.normalize(o),a=YFM.Math.Vector.normalize(a),this._divideTriangle(t,s,o,r-1),this._divideTriangle(s,i,a,r-1),this._divideTriangle(a,e,o,r-1),this._divideTriangle(s,a,o,r-1)}else this._triangle(t,i,e)},_triangle:function(t,i,e){var r=YFM.Math.Vector.sub(i,t),s=YFM.Math.Vector.sub(e,i),o=YFM.Math.Vector.normalize(YFM.Math.Vector.cross(r,s));this.mesh.push(t),this.mesh.push(o),this.mesh.push(i),this.mesh.push(o),this.mesh.push(e),this.mesh.push(o)}},IcosahedronMesh.prototype={constructor:IcosahedronMesh,getMeshVBO:function(){return this.meshVBO},getMeshBufSize:function(){return this.meshBufSize},_init:function(t,i){this.mesh=[],this._icosahedron(i),this.meshVBO=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.meshVBO),t.bufferData(t.ARRAY_BUFFER,YFM.Math.flatten(this.mesh,3),t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null),this.meshBufSize=this.mesh.length/2,this.mesh=null},_icosahedron:function(t){var i=(1+Math.sqrt(5))/2,e=[];e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-1,i,0))),e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(1,i,0))),e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-1,-i,0))),e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(1,-i,0))),e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,-1,i))),e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,1,i))),e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,-1,-i))),e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,1,-i))),e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(i,0,-1))),e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(i,0,1))),e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-i,0,-1))),e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-i,0,1))),this._divideTriangle(e[0],e[11],e[5],t),this._divideTriangle(e[0],e[5],e[1],t),this._divideTriangle(e[0],e[1],e[7],t),this._divideTriangle(e[0],e[7],e[10],t),this._divideTriangle(e[0],e[10],e[11],t),this._divideTriangle(e[1],e[5],e[9],t),this._divideTriangle(e[5],e[11],e[4],t),this._divideTriangle(e[11],e[10],e[2],t),this._divideTriangle(e[10],e[7],e[6],t),this._divideTriangle(e[7],e[1],e[8],t),this._divideTriangle(e[3],e[9],e[4],t),this._divideTriangle(e[3],e[4],e[2],t),this._divideTriangle(e[3],e[2],e[6],t),this._divideTriangle(e[3],e[6],e[8],t),this._divideTriangle(e[3],e[8],e[9],t),this._divideTriangle(e[4],e[9],e[5],t),this._divideTriangle(e[2],e[4],e[11],t),this._divideTriangle(e[6],e[2],e[10],t),this._divideTriangle(e[8],e[6],e[7],t),this._divideTriangle(e[9],e[8],e[1],t)},_divideTriangle:function(t,i,e,r){if(r>0){var s=YFM.Math.Vector.mix(t,i,.5),o=YFM.Math.Vector.mix(t,e,.5),a=YFM.Math.Vector.mix(i,e,.5);s=YFM.Math.Vector.normalize(s),o=YFM.Math.Vector.normalize(o),a=YFM.Math.Vector.normalize(a),this._divideTriangle(t,s,o,r-1),this._divideTriangle(s,i,a,r-1),this._divideTriangle(a,e,o,r-1),this._divideTriangle(s,a,o,r-1)}else this._triangle(t,i,e)},_triangle:function(t,i,e){var r=YFM.Math.Vector.sub(i,t),s=YFM.Math.Vector.sub(e,i),o=YFM.Math.Vector.normalize(YFM.Math.Vector.cross(r,s));this.mesh.push(t),this.mesh.push(o),this.mesh.push(i),this.mesh.push(o),this.mesh.push(e),this.mesh.push(o)}},YFM.Mesh={},YFM.Mesh.CATEGORY_TETRHEDRON="tetrahedron",YFM.Mesh.CATEGORY_HEXADEDRON="hexahedron",YFM.Mesh.CATEGORY_OCTAHEDRON="octahedron",YFM.Mesh.CATEGORY_DODECAHEDRON="dodecahedron",YFM.Mesh.CATEGORY_ICOSAHEDRON="icosahedron",YFM.Mesh.CATEGORY_SPHERE="SPHERE",MeshBuffer.prototype={constructor:MeshBuffer,addAttribute:function(t,i,e,r){var s=this.gl,o=new Float32Array(i),a=s.createBuffer();s.bindBuffer(s.ARRAY_BUFFER,a),s.bufferData(s.ARRAY_BUFFER,o,s.STATIC_DRAW),s.bindBuffer(s.ARRAY_BUFFER,null),this.attributes[t]={vbo:a,size:e,length:i.length/e}},getAttribute:function(t){return this.attributes[t]}},OctahedronMesh.prototype={constructor:OctahedronMesh,getMeshVBO:function(){return this.meshVBO},getMeshBufSize:function(){return this.meshBufSize},_init:function(t,i){this.mesh=[],this._octahedron(i),this.meshVBO=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.meshVBO),t.bufferData(t.ARRAY_BUFFER,YFM.Math.flatten(this.mesh,3),t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null),this.meshBufSize=this.mesh.length/2,this.mesh=null},_octahedron:function(t){var i=[];i.push(YFM.Math.Vector.pos(1,0,0)),i.push(YFM.Math.Vector.pos(-1,0,0)),i.push(YFM.Math.Vector.pos(0,1,0)),i.push(YFM.Math.Vector.pos(0,-1,0)),i.push(YFM.Math.Vector.pos(0,0,1)),i.push(YFM.Math.Vector.pos(0,0,-1)),this._divideTriangle(i[0],i[2],i[4],t),this._divideTriangle(i[0],i[4],i[3],t),this._divideTriangle(i[0],i[3],i[5],t),this._divideTriangle(i[0],i[5],i[2],t),this._divideTriangle(i[1],i[2],i[5],t),this._divideTriangle(i[1],i[5],i[3],t),this._divideTriangle(i[1],i[3],i[4],t),this._divideTriangle(i[1],i[4],i[2],t)},_divideTriangle:function(t,i,e,r){if(r>0){var s=YFM.Math.Vector.mix(t,i,.5),o=YFM.Math.Vector.mix(t,e,.5),a=YFM.Math.Vector.mix(i,e,.5);s=YFM.Math.Vector.normalize(s),o=YFM.Math.Vector.normalize(o),a=YFM.Math.Vector.normalize(a),this._divideTriangle(t,s,o,r-1),this._divideTriangle(s,i,a,r-1),this._divideTriangle(a,e,o,r-1),this._divideTriangle(s,a,o,r-1)}else this._triangle(t,i,e)},_triangle:function(t,i,e){var r=YFM.Math.Vector.sub(i,t),s=YFM.Math.Vector.sub(e,i),o=YFM.Math.Vector.normalize(YFM.Math.Vector.cross(r,s));this.mesh.push(t),this.mesh.push(o),this.mesh.push(i),this.mesh.push(o),this.mesh.push(e),this.mesh.push(o)}},TetrahedronMesh.prototype={constructor:TetrahedronMesh,getMeshVBO:function(){return this.meshVBO},getMeshBufSize:function(){return this.meshBufSize},_init:function(t,i){this.mesh=[],this._tetrahedron(i),this.meshVBO=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.meshVBO),t.bufferData(t.ARRAY_BUFFER,YFM.Math.flatten(this.mesh,3),t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null),this.meshBufSize=this.mesh.length/2,this.mesh=null},_tetrahedron:function(t){var i=[];i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(1,1,1))),i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-1,-1,1))),i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-1,1,-1))),i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(1,-1,-1))),this._divideTriangle(i[2],i[1],i[0],t),this._divideTriangle(i[0],i[3],i[2],t),this._divideTriangle(i[1],i[3],i[0],t),this._divideTriangle(i[2],i[3],i[1],t)},_divideTriangle:function(t,i,e,r){if(r>0){var s=YFM.Math.Vector.mix(t,i,.5),o=YFM.Math.Vector.mix(t,e,.5),a=YFM.Math.Vector.mix(i,e,.5);s=YFM.Math.Vector.normalize(s),o=YFM.Math.Vector.normalize(o),a=YFM.Math.Vector.normalize(a),this._divideTriangle(t,s,o,r-1),this._divideTriangle(s,i,a,r-1),this._divideTriangle(a,e,o,r-1),this._divideTriangle(s,a,o,r-1)}else this._triangle(t,i,e)},_triangle:function(t,i,e){var r=YFM.Math.Vector.sub(i,t),s=YFM.Math.Vector.sub(e,i),o=YFM.Math.Vector.normalize(YFM.Math.Vector.cross(r,s));this.mesh.push(t),this.mesh.push(o),this.mesh.push(i),this.mesh.push(o),this.mesh.push(e),this.mesh.push(o)}},RawPanorama.prototype={constructor:RawPanorama,render:function(t,i){null!==this.cubeMap&&(this.gl.enable(this.gl.CULL_FACE),this.gl.frontFace(this.gl.CW),this.gl.enable(this.gl.DEPTH_TEST),this.gl.depthFunc(this.gl.LEQUAL),t.setModelMatrix(YFM.Math.Matrix.mul(i,this.modelMat)),t.bindTexture(this.cubeMap),t.drawTriangles(this.cubeVBO,this.cubeSize),this.gl.disable(this.gl.DEPTH_TEST),this.gl.frontFace(this.gl.CCW),this.gl.disable(this.gl.CULL_FACE))},setCubeTex:function(t,i,e,r,s,o){var a={imgList:new Array(6),imgCount:0},h=this;a.imgList[0]=new Image,a.imgList[0].onload=function(){h._handleTextureLoaded(0,a)},a.imgList[0].src=t,a.imgList[1]=new Image,a.imgList[1].onload=function(){h._handleTextureLoaded(1,a)},a.imgList[1].src=i,a.imgList[2]=new Image,a.imgList[2].onload=function(){h._handleTextureLoaded(2,a)},a.imgList[2].src=e,a.imgList[3]=new Image,a.imgList[3].onload=function(){h._handleTextureLoaded(3,a)},a.imgList[3].src=r,a.imgList[4]=new Image,a.imgList[4].onload=function(){h._handleTextureLoaded(4,a)},a.imgList[4].src=s,a.imgList[5]=new Image,a.imgList[5].onload=function(){h._handleTextureLoaded(5,a)},a.imgList[5].src=o},_initCube:function(){var t=this.gl,i=[],e=[YFM.Math.Vector.pos(-5e3,-5e3,5e3),YFM.Math.Vector.pos(-5e3,5e3,5e3),YFM.Math.Vector.pos(5e3,5e3,5e3),YFM.Math.Vector.pos(5e3,-5e3,5e3),YFM.Math.Vector.pos(-5e3,-5e3,-5e3),YFM.Math.Vector.pos(-5e3,5e3,-5e3),YFM.Math.Vector.pos(5e3,5e3,-5e3),YFM.Math.Vector.pos(5e3,-5e3,-5e3)];this._quad(e,i,1,0,3,2),this._quad(e,i,2,3,7,6),this._quad(e,i,3,0,4,7),this._quad(e,i,6,5,1,2),this._quad(e,i,4,5,6,7),this._quad(e,i,5,4,0,1),this.cubeVBO=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.cubeVBO),t.bufferData(t.ARRAY_BUFFER,YFM.Math.flatten(i,3),t.STATIC_DRAW),this.cubeSize=i.length},_quad:function(t,i,e,r,s,o){i.push(t[e]),i.push(t[r]),i.push(t[s]),i.push(t[e]),i.push(t[s]),i.push(t[o])},_makeCubeTex:function(t,i,e,r,s,o){var a=this.gl;null!==this.cubeMap&&a.deleteTexture(this.cubeMap),this.cubeMap=a.createTexture(),a.bindTexture(a.TEXTURE_CUBE_MAP,this.cubeMap),a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,t),a.texImage2D(a.TEXTURE_CUBE_MAP_NEGATIVE_X,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,r),a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_Y,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,i),a.texImage2D(a.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,s),a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_Z,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,e),a.texImage2D(a.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,o),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_MAG_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_MIN_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE)},_handleTextureLoaded:function(t,i){i.imgCount+=1,6==i.imgCount&&this._makeCubeTex(i.imgList[0],i.imgList[1],i.imgList[2],i.imgList[3],i.imgList[4],i.imgList[5])}},YFM.WebGL=function(){var t=function(t){return'<table style="background-color: #8CE; width: 100%; height: 100%;"><tr><td align="center"><div style="display: table-cell; vertical-align: middle;"><div style="">'+t+"</div></div></td></tr></table>"},i=function(t,i){for(var e=["webgl","experimental-webgl","webkit-3d","moz-webgl"],r=null,s=0;s<e.length;++s){try{r=t.getContext(e[s],i)}catch(t){}if(r)break}return r};return{create3DContext:i,setupWebGL:function(e,r){function s(i){var r=e.parentNode;r&&(r.innerHTML=t(i))}if(!window.WebGLRenderingContext)return s('This page requires a browser that supports WebGL.<br/><a href="http://get.webgl.org">Click here to upgrade your browser.</a>'),null;var o=i(e,r);return o||s('It doesn\'t appear your computer can support WebGL.<br/><a href="http://get.webgl.org/troubleshooting/">Click here for more information.</a>'),o},makeShader:function(t,i,e){var r,s;if(r=t.createShader(t.VERTEX_SHADER),t.shaderSource(r,i),t.compileShader(r),!t.getShaderParameter(r,t.COMPILE_STATUS))return a="Vertex shader failed to compile.  The error log is:<pre>"+t.getShaderInfoLog(r)+"</pre>",alert(a),-1;if(s=t.createShader(t.FRAGMENT_SHADER),t.shaderSource(s,e),t.compileShader(s),!t.getShaderParameter(s,t.COMPILE_STATUS))return a="Fragment shader failed to compile.  The error log is:<pre>"+t.getShaderInfoLog(s)+"</pre>",alert(a),-1;var o=t.createProgram();if(t.attachShader(o,r),t.attachShader(o,s),t.linkProgram(o),!t.getProgramParameter(o,t.LINK_STATUS)){var a="Shader program failed to link.  The error log is:<pre>"+t.getProgramInfoLog(o)+"</pre>";return alert(a),-1}return o}}}(),YFM.WebGL.Color=function(){var t=function(t){return((16711680&t)>>16)/255},i=function(t){return((65280&t)>>8)/255},e=function(t){return(255&t)/255};return{hexColorRed:t,hexColorGreen:i,hexColorBlue:e,hexColorAlpha:function(t){return((4278190080&t)>>>24)/255},randomHexRGB:function(){return 4278190080|Math.floor(255*Math.random())<<16|Math.floor(255*Math.random())<<8|Math.floor(255*Math.random())},getRGBVec:function(r){return YFM.Math.Vector.pos(t(r),i(r),e(r))}}}(),window.requestAnimFrame=function(t,i){window.setTimeout(t,1e3/30)},Floor.prototype={constructor:Floor,getSize:function(){return this.loaded?this.mapSize:null},getAspect:function(){return{w:this.mapWidth,h:this.mapHeight}},isLoaded:function(){return this.loaded},setVOffset:function(t,i){var e=t*i;YFM.Math.Matrix.setTranslateZ(this.floorMat,e),this.penddingVOffset=null;var r=[];r.push(YFM.Math.Vector.pos(0,0,e)),r.push(YFM.Math.Vector.pos(this.mapWidth,0,e)),r.push(YFM.Math.Vector.pos(this.mapWidth,this.mapHeight,e)),r.push(YFM.Math.Vector.pos(0,this.mapHeight,e)),this.planePolygon=new PlanePolygon(r),this.icons=new FloorIcons(this.gl,this.region,this),this.iconPlus=new FloorIconPlus(this.gl,this.region,this),this.quadTree=new FloorQuadTree(this,100),this.models=new FloorModels(this.gl,this.region,this,t/3),this.vOffset=e},insertUnit:function(t){for(var i=0,e=t.pts.length;i<e;i++)t.pts[i][1]=this.mapHeight-t.pts[i][1];var r=YFM.Math.Vector.pos(t.pts[0][0],t.pts[0][1],this.unitHeight);t.pts.push(r);var s=new OBB(t.pts),o=YFM.Math.Vector.pos(s.center[0],this.mapHeight-s.center[1],s.center);s.transform(this.floorMat),this.quadTree.insertObjectOBBCenter(t,s,o)},insertIcon:function(t,i,e){this.icons.insertIcon(t,i,e,2)},insertIconPlus:function(t,i,e){this.iconPlus.insertIcon(t,i,e,2)},insertModel:function(t,i,e,r,s,o){return t.setFloor(this),t.setModelMatrix(YFM.Math.Matrix.postTranslate(YFM.Math.Matrix.postRotate3d(YFM.Math.Matrix.postRotate3d(YFM.Math.Matrix.scale(e,0,0,0),90,1,0,0),i,0,0,1),r,this.mapHeight-s,o)),this.models.insertModel(t)},removeModel:function(t){return this.models.removeModel(t)},searchModel:function(t,i){return null!=this.models?this.models.rayCheck(t,i):[]},searchUnit:function(t,i){return null!=this.quadTree?this.quadTree.rayCheckOBB(t,i):[]},searchIcon:function(t,i,e){return null!=this.icons?this.icons.rayCheck(t,i,e):[]},searchIconPlus:function(t,i){return null!=this.iconPlus?this.iconPlus.rayCheck(t,i):[]},intersectionLine:function(t){return null==this.planePolygon?1024:this.planePolygon.intersectionLine(t,this.floorMat)},floorPos2Region:function(t,i){var e;return e=YFM.Math.Vector.pos(t,this.mapHeight-i,0),YFM.Math.Matrix.mulVec(this.floorMat,e)},getFloorMat:function(){return this.floorMat},frustumCheck:function(t){return null==this.quadTree?-1:this.quadTree.frustumCheck(t)},renderBase:function(t,i){this.loaded&&(t.setMapHeight(this.mapHeight),t.setFloorMatrix(this.floorMat),t.setModelMatrix(YFM.Math.Matrix.mat()),this.gl.enable(this.gl.DEPTH_TEST),this.gl.depthFunc(this.gl.ALWAYS),this.trianglesSize&&t.drawTriangles(this.trianglesVBO,this.trianglesSize),this.borderSize&&t.drawLines(this.borderVBO,this.borderSize),this.gl.disable(this.gl.DEPTH_TEST))},renderExtrude:function(t,i,e,r){if(this.loaded){t.setMapHeight(this.mapHeight),t.setFloorMatrix(this.floorMat),t.setLightPos(e);var s=YFM.Math.Matrix.mul(i,this.floorMat),o=YFM.Math.Matrix.transpose(s),a=YFM.Math.Matrix.invert(o);t.setNormalMatrix(a),r?(t.setModelMatrix(YFM.Math.Matrix.mat()),this.unitExtrude.render(t,r),this.wallExtrude.render(t,r)):(t.setModelMatrix(YFM.Math.Matrix.translate(0,0,1-this.unitHeight)),this.unitExtrude.render(t,r),t.setModelMatrix(YFM.Math.Matrix.translate(0,0,1-this.wallHeight)),this.wallExtrude.render(t,r)),this.quickPolygon.render(t)}},renderModels:function(t,i,e,r){this.models.renderModels(t,i,e,r)},renderIcons:function(t,i){this.icons.renderIcons(t,i),this.iconPlus.renderIcons(t,i)},renderMarkers:function(t,i,e,r,s){this.markers.render(t,i,e,r,s)},renderQuickIcons:function(t){this.quickIcons.render(t)},renderUnit:function(t,i){if(this.loaded)if(this.region.drawAllUnit)this.quadTree.render(t,this._renderUnit,this,1024);else{var e=this.quadTree.getContainLevel(t);this.quadTree.render(t,this._renderUnit,this,e)}},_renderUnit:function(t,i){var e;e=t.pos.isOBB?i.region.regionPos2Screen(t.center):i.region.regionPos2Screen(t.pos);var r,s,o,a;if(!t.obj.block){var h=i.region.ctx2d.measureText(t.obj.text);t.obj.block={hw:(h.width+4)/2,hh:i.region.fontHeight/2}}r=e[0]-t.obj.block.hw,s=e[1]-t.obj.block.hh,o=e[0]+t.obj.block.hw,a=e[1]+t.obj.block.hh,i.region.tqct.check(r,s,o,a)||i.region._drawText(t.obj.text,e[0],e[1])},_load_svg:function(t,i){var e=t.gl,r=[],s=[],o=(new DOMParser).parseFromString(i,"image/svg+xml");t._read_svg(o.documentElement,r,s),t.trianglesSize=r.length/2,t.borderSize=s.length/2,t.trianglesVBO=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,t.trianglesVBO),e.bufferData(e.ARRAY_BUFFER,YFM.Math.flatten(r,3),e.STATIC_DRAW),t.borderVBO=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,t.borderVBO),e.bufferData(e.ARRAY_BUFFER,YFM.Math.flatten(s,3),e.STATIC_DRAW),t.floorMat=YFM.Math.Matrix.translate(-t.mapWidth/2,-t.mapHeight/2,0),t.floorMat=YFM.Math.Matrix.postRotate3d(t.floorMat,-t.deflection,0,0,1);var a=[],h=YFM.Math.Vector.pos(YFM.WebGL.Color.hexColorRed(4294935808),YFM.WebGL.Color.hexColorGreen(4294935808),YFM.WebGL.Color.hexColorBlue(4294935808));a.push(YFM.Math.Vector.pos(0,0,0)),a.push(h),a.push(YFM.Math.Vector.pos(t.mapWidth,0,0)),a.push(h),a.push(YFM.Math.Vector.pos(t.mapWidth,0,0)),a.push(h),a.push(YFM.Math.Vector.pos(t.mapWidth,t.mapHeight,0)),a.push(h),a.push(YFM.Math.Vector.pos(t.mapWidth,t.mapHeight,0)),a.push(h),a.push(YFM.Math.Vector.pos(0,t.mapHeight,0)),a.push(h),a.push(YFM.Math.Vector.pos(0,t.mapHeight,0)),a.push(h),a.push(YFM.Math.Vector.pos(0,0,0)),a.push(h),t.dummyVBO=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,t.dummyVBO),e.bufferData(e.ARRAY_BUFFER,YFM.Math.flatten(a,3),e.STATIC_DRAW),t.unitExtrude.buildExtrude(),t.wallExtrude.buildExtrude(),t.loaded=!0},_read_svg:function(t,i,e){this.mapWidth=parseInt(t.getAttribute("width")),this.mapHeight=parseInt(t.getAttribute("height")),this.mapSize=Math.sqrt(this.mapWidth*this.mapWidth,this.mapHeight*this.mapHeight),console.log("Floor<%s> read svg width:%d, height:%d",this.id,this.mapWidth,this.mapHeight);for(var r=0;r<t.childNodes.length;r++){var s=t.childNodes.item(r);"g"==s.nodeName&&this._read_group(s,i,e)}},_read_group:function(t,i,e,r){var s=t.getAttribute("id"),o=0;if(!this.regIcon.test(s)){r?o=r:this.regUnit.test(s)?o=1:this.regWall.test(s)&&(o=2);for(var a=0;a<t.childNodes.length;a++){var h=t.childNodes.item(a);1==h.nodeType&&("g"==h.nodeName?this._read_group(h,i,e,o):this._read_obj(h,i,e,o))}}},_pos2:function(t,i){var e=[];return e.push(t),e.push(i),e.push(1),e},_multVec3:function(t,i){var e,r,s,o=[];return e=i[0],r=i[1],s=i[2],o.push(e*t[0]+r*t[3]+s*t[6]),o.push(e*t[1]+r*t[4]+s*t[7]),o.push(e*t[2]+r*t[5]+s*t[8]),o},_read_obj:function(t,i,e,r){if("rect"==t.nodeName){var s=t.getAttribute("fill"),o=t.getAttribute("stroke"),a=parseFloat(t.getAttribute("width")),h=parseFloat(t.getAttribute("height")),n=parseFloat(t.getAttribute("x"))||0,u=parseFloat(t.getAttribute("y"))||0,l=[],c=this._parseMatrix(t.getAttribute("transform"));if(null!=c){var M=this._multVec3(c,this._pos2(n,u)),g=this._multVec3(c,this._pos2(n+a,u)),d=this._multVec3(c,this._pos2(n+a,u+h)),p=this._multVec3(c,this._pos2(n,u+h));l.push(M[0]),l.push(M[1]),l.push(g[0]),l.push(g[1]),l.push(d[0]),l.push(d[1]),l.push(p[0]),l.push(p[1])}else l.push(n),l.push(u),l.push(n+a),l.push(u),l.push(n+a),l.push(u+h),l.push(n),l.push(u+h);this._add_shape(t,l,s,o,i,e,r)}else if("polygon"==t.nodeName){var s=t.getAttribute("fill"),o=t.getAttribute("stroke"),l=t.getAttribute("points");this._add_shape(t,l,s,o,i,e,r)}},_add_shape:function(t,i,e,r,s,o,a){var h,n,u,l,c,M,g=new ArrayList,d=[];if((h=null!=r&&"none"!=r)&&(r=r.replace("#",""),n=((c=parseInt(r,16))>>16&255)/255,u=(c>>8&255)/255,l=(255&c)/255,M=YFM.Math.Vector.vec(n,u,l)),!(i instanceof Array)){for(var p=[],f=i.replace(/\s+/," ").split(" "),m=0;m<f.length;m++){var v=f[m].split(","),F=parseFloat(v[0]),x=parseFloat(v[1]);isNaN(F)||isNaN(x)||(p.push(F),p.push(x))}i=p}for(var _=i.length/2,m=0;m<_;m++){var F=i[2*m+0],x=i[2*m+1];1===a&&(F,x);var Y=YFM.Math.Vector.vec(F,x,0,1);if(d.push(Y),g.addHigh(Y),h){var R,y;m==_-1?(R=i[0],y=i[1]):(R=i[2*(m+1)+0],y=i[2*(m+1)+1]),1===a&&this.isUnitExtrude?this.unitExtrude.addBorder(YFM.Math.Vector.pos(F,x,0),YFM.Math.Vector.pos(R,y,0),M):2===a?this.wallExtrude.addBorder(YFM.Math.Vector.pos(F,x,0),YFM.Math.Vector.pos(R,y,0),M):(o.push(YFM.Math.Vector.vec(F,x,0,1)),o.push(M),o.push(YFM.Math.Vector.vec(R,y,0,1)),o.push(M))}}"none"!=e&&(e=e.replace("#",""),n=((c=parseInt(e,16))>>16&255)/255,u=(c>>8&255)/255,l=(255&c)/255,this._triangulate_cut_ear(t,n,u,l,d,g,s,a))},_parseMatrix:function(t){if(null==t)return null;var i=t.slice(7,-1).split(" ");if(i.length<6)return null;for(var e=[],r=0;r<i.length;r++)e.push(parseFloat(i[r]));var s=[];return s.push(e[0]),s.push(e[1]),s.push(0),s.push(e[2]),s.push(e[3]),s.push(0),s.push(e[4]),s.push(e[5]),s.push(1),s},_clock_wise:function(t){for(var i=0,e=t.length,r=0;r<e;r++)i+=(t[(r+1)%e][0]-t[r][0])*(t[(r+1)%e][1]+t[r][1]);return i>0},_is_left_turn:function(t,i,e){return(i[0]-t[0])*(e[1]-t[1])-(e[0]-t[0])*(i[1]-t[1])>0},_is_right_turn:function(t,i,e){return(i[0]-t[0])*(e[1]-t[1])-(e[0]-t[0])*(i[1]-t[1])<0},_point_inside:function(t,i,e,r){var s=this._is_left_turn(t,i,r),o=this._is_left_turn(i,e,r),a=this._is_left_turn(e,t,r);if(s&&o&&a)return!0;var h=this._is_right_turn(t,i,r),n=this._is_right_turn(i,e,r),u=this._is_right_turn(e,t,r);return!!(h&&n&&u)},_add_unit_extrude:function(t,i,e){},_triangulate_cut_ear:function(t,i,e,r,s,o,a,h){for(var n,u,i,l,c,M,g,d=this._clock_wise(s),p=YFM.Math.Vector.vec(i,e,r),f=[];o.size()>3;){l=-1,c=!1,M=0;do{if(M++,g=o.size(),M>=g)return console.log("bad input obj:%o",t),1===h&&this.isUnitExtrude?this.unitExtrude.addExtrude(s,f,p):2===h&&this.wallExtrude.addExtrude(s,f,p),!1;if(l++,n=o.get(l%g),u=o.get((l+1)%g),i=o.get((l+2)%g),c=this._is_left_turn(n,u,i)^d)for(var m=o.getIter();m.hasNext();){var v=m.getNext();if(this._point_inside(n,u,i,v)){c=!1;break}}}while(!c);1===h&&this.isUnitExtrude?(f.push(n),f.push(u),f.push(i)):2===h?(f.push(n),f.push(u),f.push(i)):(a.push(n),a.push(p),a.push(u),a.push(p),a.push(i),a.push(p)),o.remove((l+1)%g)}return 3===o.size()&&(1===h&&this.isUnitExtrude?(f.push(o.get(0)),f.push(o.get(1)),f.push(o.get(2))):2===h?(f.push(o.get(0)),f.push(o.get(1)),f.push(o.get(2))):(a.push(o.get(0)),a.push(p),a.push(o.get(1)),a.push(p),a.push(o.get(2)),a.push(p))),1===h&&this.isUnitExtrude?this.unitExtrude.addExtrude(s,f,p):2===h&&this.wallExtrude.addExtrude(s,f,p),!0}},FloorExtrude.prototype={constructor:FloorExtrude,render:function(t,i){this.loaded&&(null!=this.extrudeTopVBO&&(this.gl.enable(this.gl.CULL_FACE),this.gl.enable(this.gl.DEPTH_TEST),this.gl.depthFunc(this.gl.LEQUAL),t.setLighting(1),i&&t.drawTriangles(this.extrudeSideVBO,this.extrudeSideSize),t.drawTriangles(this.extrudeTopVBO,this.extrudeTopSize),this.gl.disable(this.gl.DEPTH_TEST),this.gl.disable(this.gl.CULL_FACE)),null!=this.borderVBO&&0!==this.borderSize&&(t.setLighting(0),this.gl.lineWidth(2),t.drawLines(this.borderVBO,this.borderSize),this.gl.lineWidth(1)))},addBorder:function(t,i,e){t[2]+=this.height,i[2]+=this.height,this.borderVarray.push(t),this.borderVarray.push(e),this.borderVarray.push(this.borderNormal),this.borderVarray.push(i),this.borderVarray.push(e),this.borderVarray.push(this.borderNormal)},addExtrude:function(t,i,e){var r,s,o,a,h=i.length/3,n=t.length,u=YFM.Math.Vector.vec(0,0,1);for(r=0;r<h;r++){var l=[];l.push(i[3*r+0]),l.push(i[3*r+1]),l.push(i[3*r+2]),this._clock_wise_tri(l)?(this.extrudeTopVarray.push(YFM.Math.Vector.pos(l[0][0],l[0][1],l[0][2]+this.height)),this.extrudeTopVarray.push(e),this.extrudeTopVarray.push(u),this.extrudeTopVarray.push(YFM.Math.Vector.pos(l[1][0],l[1][1],l[1][2]+this.height)),this.extrudeTopVarray.push(e),this.extrudeTopVarray.push(u),this.extrudeTopVarray.push(YFM.Math.Vector.pos(l[2][0],l[2][1],l[2][2]+this.height)),this.extrudeTopVarray.push(e),this.extrudeTopVarray.push(u)):(this.extrudeTopVarray.push(YFM.Math.Vector.pos(l[0][0],l[0][1],l[0][2]+this.height)),this.extrudeTopVarray.push(e),this.extrudeTopVarray.push(u),this.extrudeTopVarray.push(YFM.Math.Vector.pos(l[2][0],l[2][1],l[2][2]+this.height)),this.extrudeTopVarray.push(e),this.extrudeTopVarray.push(u),this.extrudeTopVarray.push(YFM.Math.Vector.pos(l[1][0],l[1][1],l[1][2]+this.height)),this.extrudeTopVarray.push(e),this.extrudeTopVarray.push(u))}if(this._clock_wise_pts(t)){for(s=0;s<n-1;s++)o=t[s],a=t[s+1],this._putSideQuad(a,o,e,this.height);o=t[s],a=t[0],this._putSideQuad(a,o,e,this.height)}else{for(s=0;s<n-1;s++)o=t[s],a=t[s+1],this._putSideQuad(o,a,e,this.height);o=t[s],a=t[0],this._putSideQuad(o,a,e,this.height)}},buildExtrude:function(){this.extrudeTopVBO=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.extrudeTopVBO),this.gl.bufferData(this.gl.ARRAY_BUFFER,YFM.Math.flatten(this.extrudeTopVarray,3),this.gl.STATIC_DRAW),this.extrudeTopSize=this.extrudeTopVarray.length/3,this.extrudeTopVarray=[],this.extrudeSideVBO=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.extrudeSideVBO),this.gl.bufferData(this.gl.ARRAY_BUFFER,YFM.Math.flatten(this.extrudeSideVarray,3),this.gl.STATIC_DRAW),this.extrudeSideSize=this.extrudeSideVarray.length/3,this.extrudeSideVarray=[],this.borderVBO=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.borderVBO),this.gl.bufferData(this.gl.ARRAY_BUFFER,YFM.Math.flatten(this.borderVarray,3),this.gl.STATIC_DRAW),this.borderSize=this.borderVarray.length/3,this.borderVarray=[],0!==this.extrudeTopSize||0!==this.extrudeSideSize||0!==this.borderSize?this.loaded=!0:this.loaded=!1},_clock_wise_tri:function(t){var i=0;return i+=(t[1][0]-t[0][0])*(t[1][1]+t[0][1]),i+=(t[2][0]-t[1][0])*(t[2][1]+t[1][1]),(i+=(t[0][0]-t[2][0])*(t[0][1]+t[2][1]))>0},_clock_wise_pts:function(t){for(var i=0,e=t.length,r=0;r<e;r++)i+=(t[(r+1)%e][0]-t[r][0])*(t[(r+1)%e][1]+t[r][1]);return i>0},_putSideQuad:function(t,i,e){var r,s,o,a,h,n=[],u=[];r=YFM.Math.Vector.pos(t[0],t[1],t[2]),s=YFM.Math.Vector.pos(i[0],i[1],i[2]),o=YFM.Math.Vector.pos(i[0],i[1],i[2]+this.height),a=YFM.Math.Vector.pos(t[0],t[1],t[2]+this.height),n.push(r),n.push(o),n.push(s),u.push(r),u.push(a),u.push(o),h=YFM.Math.Vector.normalize(YFM.Math.Vector.cross(YFM.Math.Vector.sub(s,r),YFM.Math.Vector.sub(o,s))),this.extrudeSideVarray.push(n[0]),this.extrudeSideVarray.push(e),this.extrudeSideVarray.push(h),this.extrudeSideVarray.push(n[1]),this.extrudeSideVarray.push(e),this.extrudeSideVarray.push(h),this.extrudeSideVarray.push(n[2]),this.extrudeSideVarray.push(e),this.extrudeSideVarray.push(h),this.extrudeSideVarray.push(u[0]),this.extrudeSideVarray.push(e),this.extrudeSideVarray.push(h),this.extrudeSideVarray.push(u[1]),this.extrudeSideVarray.push(e),this.extrudeSideVarray.push(h),this.extrudeSideVarray.push(u[2]),this.extrudeSideVarray.push(e),this.extrudeSideVarray.push(h)}},FloorIconPlus.prototype={constructor:FloorIconPlus,insertIcon:function(t,i,e,r){this.quadTree.insertObject(t,this.floor.index,i,e,r)},rayCheck:function(t,i){return this.quadTree.rayCheck(t,0,i)},renderIcons:function(t,i){this.shader=i,this.quadTree.render(t,this._renderIcon,this,1024)},_renderIcon:function(t,i){var e=i.region.getTexture(t.obj.tex);if(e){if(i.shader.bindTexture(e.tex),!t.quadVBO){var r=t.obj.rate||1,s=e.w/2,o=e.h/2;t.quadVBO=i._makeVBO(r*s,r*o),t.radiusSQ=s*s+o*o}i.shader.setModelMatrix(YFM.Math.Matrix.translate(t.pos[0],t.pos[1],t.pos[2])),i.shader.drawTriangles(t.quadVBO,6,0)}},_makeVBO:function(t,i){var e=[];e.push(YFM.Math.Vector.pos(-i,-t,0)),e.push(YFM.Math.Vector.pos(i,-t,0)),e.push(YFM.Math.Vector.pos(i,t,0)),e.push(YFM.Math.Vector.pos(-i,t,0));var r=[];r.push(YFM.Math.Vector.vec(0,0)),r.push(YFM.Math.Vector.vec(0,1)),r.push(YFM.Math.Vector.vec(1,1)),r.push(YFM.Math.Vector.vec(1,0));var s=[];s.push(e[0]),s.push(r[0]),s.push(e[1]),s.push(r[1]),s.push(e[2]),s.push(r[2]),s.push(e[0]),s.push(r[0]),s.push(e[2]),s.push(r[2]),s.push(e[3]),s.push(r[3]);var o=this.gl.createBuffer();return this.gl.bindBuffer(this.gl.ARRAY_BUFFER,o),this.gl.bufferData(this.gl.ARRAY_BUFFER,YFM.Math.flatten(s,3),this.gl.STATIC_DRAW),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null),o}},FloorIcons.prototype={constructor:FloorIcons,insertIcon:function(t,i,e,r){this.quadTree.insertObject(t,this.floor.index,i,e,r)},rayCheck:function(t,i,e){return this.quadTree.rayCheck(t,i,e)},renderIcons:function(t,i){if(this.shader=i,null===this.iconTex){var e=this.region.getTexture("pubIcons");null!=e&&(this.iconTex=e.tex)}null!==this.iconTex&&(this.shader.bindTexture(this.iconTex),this.quadTree.render(t,this._renderIcon,this,1024))},_renderIcon:function(t,i){null!==i.iconTex&&(i.shader.setModelMatrix(YFM.Math.Matrix.translate(t.pos[0],t.pos[1],t.pos[2])),i.shader.drawTriangles(i.quadVBO,6,6*t.obj.type))},_calcTexCoords:function(t,i,e){var r,s;r=Math.floor((e-1)/8),s=(e-1)%8;var o=[];o.push(YFM.Math.Vector.pos(1/8*s,1/8*r)),o.push(YFM.Math.Vector.pos(1/8*s,1/8*(r+1))),o.push(YFM.Math.Vector.pos(1/8*(s+1),1/8*(r+1))),o.push(YFM.Math.Vector.pos(1/8*(s+1),1/8*r)),t.push(i[0]),t.push(o[0]),t.push(i[1]),t.push(o[1]),t.push(i[2]),t.push(o[2]),t.push(i[0]),t.push(o[0]),t.push(i[2]),t.push(o[2]),t.push(i[3]),t.push(o[3])}},FloorMarkers.prototype={constructor:FloorMarkers,quadVBO:null,cursor:0,shift:1e4,removeMarker:function(t){for(var i=null,e=!1,r=[],s=0;s<this.markerArray.length;s++)t===this.markerArray[s].id?(e=!0,i=this.markerArray[s]):r.push(this.markerArray[s]);return e&&(this.markerArray=r),i},insertMarker:function(t,i,e){var r=FloorMarkers.prototype.cursor*FloorMarkers.prototype.shift+this.floor.index,s=this.floor.floorPos2Region(i,e);return s[2]+=t.height,t.id=r,t.pos=s,this.markerArray.push(t),FloorMarkers.prototype.cursor++,r},insertTextureMarker:function(t,i,e,r,s,o){var a=this.floor.floorPos2Region(i,e);a[2]+=r;var h=FloorMarkers.prototype.cursor*FloorMarkers.prototype.shift+this.floor.index,n={type:1,id:h,texName:t,tex:null,texSize:YFM.Math.Vector.vec(10,10),envelop:YFM.Math.Vector.vec(0),pos:a,distSQ:0,height:r,offsetX:s,offsetY:o};return this.markerArray.push(n),FloorMarkers.prototype.cursor++,h},insertGeometryMarker:function(t,i,e,r,s,o){var a;if(t===YFM.Mesh.CATEGORY_TETRHEDRON)a=new TetrahedronMesh(this.gl,0);else if(t===YFM.Mesh.CATEGORY_HEXADEDRON)a=new HexahedronMesh(this.gl,0);else if(t===YFM.Mesh.CATEGORY_OCTAHEDRON)a=new OctahedronMesh(this.gl,0);else if(t===YFM.Mesh.CATEGORY_DODECAHEDRON)a=new DodecahedronMesh(this.gl,0);else if(t===YFM.Mesh.CATEGORY_ICOSAHEDRON)a=new IcosahedronMesh(this.gl,0);else{if(t!==YFM.Mesh.CATEGORY_SPHERE)return null;a=new IcosahedronMesh(this.gl,4)}var h=YFM.Math.Vector.pos(YFM.WebGL.Color.hexColorRed(i),YFM.WebGL.Color.hexColorGreen(i),YFM.WebGL.Color.hexColorBlue(i)),n=this.floor.floorPos2Region(r,s);n[2]+=o;var u=FloorMarkers.prototype.cursor*FloorMarkers.prototype.shift+this.floor.index,l={type:0,id:u,mesh:a,angle:0,bounce:0,bstep:e/20,size:e,color:h,height:o,pos:n};return this.markerArray.push(l),FloorMarkers.prototype.cursor++,u},render:function(t,i,e,r,s){var o,a,h,n;this.gl.enable(this.gl.CULL_FACE),this.gl.enable(this.gl.DEPTH_TEST),this.gl.depthFunc(this.gl.LEQUAL);var u=YFM.Math.Matrix.transpose(r),l=YFM.Math.Matrix.invert(u);e.setLightPos(this.light),e.setNormalMatrix(l);var c=YFM.Math.Matrix.invert(r),M=YFM.Math.Matrix.mulVec(c,this.orgPos),g=this.markerIMinPQ.getSize();for(this.markerArray.length>g?this.markerIMinPQ.setSize(Math.floor(1.5*this.markerArray.length)):this.markerArray.length<g/2?this.markerIMinPQ.setSize(this.markerArray.length):this.markerIMinPQ.clean(),a=0;a<this.markerArray.length;a++)o=this.markerArray[a],t.containCheckPoint(o.pos)?0===o.type?this._renderMesh(e,o):1===o.type&&(h=YFM.Math.Vector.distanceSQ(o.pos,M),o.distSQ=h,this.markerIMinPQ.insert(a,h)):o.type;for(this.markerSorted=[],n=this.markerIMinPQ.getCount(),a=0;a<n;a++)this.markerSorted.push(this.markerIMinPQ.deleteMin());for(a=n-1;a>=0;a--)1===(o=this.markerArray[this.markerSorted[a]]).type&&this._renderTex(s,i,o);this.gl.disable(this.gl.DEPTH_TEST),this.gl.disable(this.gl.CULL_FACE)},findMarker:function(t,i){for(var e,r=0;r<this.markerSorted.length;r++)if(e=this.markerArray[this.markerSorted[r]],this._envelopCheck(e.envelop,t,i))return{id:e.id,dist:e.distSQ};return null},_envelopCheck:function(t,i,e){return i>=t[0]&&i<=t[2]&&e>=t[1]&&e<=t[3]},_renderMesh:function(t,i){t.useProgram();var e=YFM.Math.Matrix.scale(i.size,0,0,0);e=YFM.Math.Matrix.postRotateXY(e,i.angle,0,0);var r=YFM.Math.Matrix.postTranslate(e,i.pos[0],i.pos[1],i.pos[2]+i.bounce);t.setModelMatrix(r),t.setColor(i.color);var s=i.mesh.getMeshVBO(),o=i.mesh.getMeshBufSize();t.drawTriangles(s,o,0),i.angle+=1,i.bounce+=i.bstep,(i.bounce>i.size||i.bounce<0)&&(i.bstep=-i.bstep)},_renderTex:function(t,i,e){if(null===e.tex){var r=this.region.getTexture(e.texName);null!==r&&(e.tex=r.tex,e.texSize[0]=r.w/2,e.texSize[1]=r.h/2)}if(null!==e.tex){var s,o,a=YFM.Math.Matrix.mulVec(t,e.pos);s=YFM.gRegion.glCanvas.width/2,o=YFM.gRegion.glCanvas.height/2,a[0]/=a[3],a[1]/=a[3],a[2]/=a[3],a[3]/=a[3],a[0]*=s,a[1]*=o,i.useProgram(),i.bindTexture(e.tex),e.envelop[0]=s+a[0]-e.offsetX-e.texSize[0],e.envelop[1]=o-(a[1]+e.offsetY+e.texSize[1]),e.envelop[2]=s+a[0]+e.offsetX+e.texSize[0],e.envelop[3]=o-(a[1]+e.offsetY-e.texSize[1]);var h=YFM.Math.Matrix.postRotateXY(YFM.Math.Matrix.postTranslate(YFM.Math.Matrix.scaleXYZ(e.texSize,0,0,0),a[0]-e.offsetX,a[1]+e.offsetY,0),this.region.camera.getRoll(),a[0],a[1]);i.setModelMatrix(h),this.gl.depthMask(!1),i.drawTriangles(FloorMarkers.prototype.quadVBO,6,0),this.gl.depthMask(!0)}},_initQuad:function(t){var i=[],e=[],r=[];r.push(YFM.Math.Vector.vec(0,1)),r.push(YFM.Math.Vector.vec(1,1)),r.push(YFM.Math.Vector.vec(1,0)),r.push(YFM.Math.Vector.vec(0,0)),e.push(YFM.Math.Vector.pos(-1,-1,0)),e.push(YFM.Math.Vector.pos(1,-1,0)),e.push(YFM.Math.Vector.pos(1,1,0)),e.push(YFM.Math.Vector.pos(-1,1,0)),i.push(e[0]),i.push(r[0]),i.push(e[1]),i.push(r[1]),i.push(e[2]),i.push(r[2]),i.push(e[0]),i.push(r[0]),i.push(e[2]),i.push(r[2]),i.push(e[3]),i.push(r[3]),FloorMarkers.prototype.quadVBO=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,FloorMarkers.prototype.quadVBO),t.bufferData(t.ARRAY_BUFFER,YFM.Math.flatten(i,3),t.STATIC_DRAW)}},FloorModels.prototype={constructor:FloorModels,removeModel:function(t){return this.quadTree.removeObject(t)},insertModel:function(t){return this.quadTree.insertObjectOBB(t,t.obb)},rayCheck:function(t,i){return this.quadTree.rayCheckOBB(t,i)},renderModels:function(t,i,e,r){this.shader=i,this.vrfMat=YFM.Math.Matrix.mul(e,this.floor.getFloorMat()),i.setFloorMatrix(this.floor.getFloorMat()),i.setLightPos(r),this.gl.enable(this.gl.CULL_FACE),this.gl.enable(this.gl.DEPTH_TEST),this.gl.depthFunc(this.gl.LEQUAL),this.quadTree.render(t,this._renderModel,this,1024),this.gl.disable(this.gl.DEPTH_TEST),this.gl.disable(this.gl.CULL_FACE)},_renderModel:function(t,i){t.obj.render(i.shader,i.vrfMat)}},FloorQuickIcons.prototype={constructor:FloorQuickIcons,render:function(t){if(null!=this.pointsVBO){if(null===this.tex){var i=this.region.getTexture(this.texName);null!==i&&(this.tex=i.tex)}null!==this.tex&&(t.bindTexture(this.tex),t.drawPoints(this.pointsVBO,this.pointsSize))}},setTex:function(t){this.tex=null,this.texName=t},addPoint:function(t,i){var e=this.floor.floorPos2Region(t,i);e[2]+=this.height,this.pointsVarray.push(e)},clean:function(){null!==this.pointsVBO&&this.gl.deleteBuffer(this.pointsVBO),this.pointsVBO=null,this.pointsSize=0,this.pointsVarray=[]},buildPoints:function(){null!==this.pointsVBO&&this.gl.deleteBuffer(this.pointsVBO),this.pointsVBO=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.pointsVBO),this.gl.bufferData(this.gl.ARRAY_BUFFER,YFM.Math.flatten(this.pointsVarray,3),this.gl.STATIC_DRAW),this.pointsSize=this.pointsVarray.length,this.pointsVarray=[]}},FloorQuickPolygon.prototype={constructor:FloorQuickPolygon,render:function(t){this.loaded&&(this.gl.enable(this.gl.CULL_FACE),this.gl.enable(this.gl.DEPTH_TEST),this.gl.depthFunc(this.gl.LEQUAL),t.setLighting(1),t.drawTriangles(this.quickPolygonVBO,this.quickPolygonSize),this.gl.disable(this.gl.DEPTH_TEST),this.gl.disable(this.gl.CULL_FACE))},addQuickPolygon:function(t,i){var e,r=t.length,s=YFM.Math.Vector.vec(0,0,1),o=new ArrayList,a=YFM.WebGL.Color.getRGBVec(i);for(e=0;e<r;e++)o.addHigh(t[e]);var h=this._triangulate_cut_ear(t,o);if(null!==h){var n=h.length/3;for(e=0;e<n;e++){var u=[];u.push(h[3*e+0]),u.push(h[3*e+1]),u.push(h[3*e+2]),this._clock_wise_tri(u)?(this.quickPolygonVarray.push(YFM.Math.Vector.pos(u[0][0],u[0][1],u[0][2]+this.height)),this.quickPolygonVarray.push(a),this.quickPolygonVarray.push(s),this.quickPolygonVarray.push(YFM.Math.Vector.pos(u[1][0],u[1][1],u[1][2]+this.height)),this.quickPolygonVarray.push(a),this.quickPolygonVarray.push(s),this.quickPolygonVarray.push(YFM.Math.Vector.pos(u[2][0],u[2][1],u[2][2]+this.height)),this.quickPolygonVarray.push(a),this.quickPolygonVarray.push(s)):(this.quickPolygonVarray.push(YFM.Math.Vector.pos(u[0][0],u[0][1],u[0][2]+this.height)),this.quickPolygonVarray.push(a),this.quickPolygonVarray.push(s),this.quickPolygonVarray.push(YFM.Math.Vector.pos(u[2][0],u[2][1],u[2][2]+this.height)),this.quickPolygonVarray.push(a),this.quickPolygonVarray.push(s),this.quickPolygonVarray.push(YFM.Math.Vector.pos(u[1][0],u[1][1],u[1][2]+this.height)),this.quickPolygonVarray.push(a),this.quickPolygonVarray.push(s))}}},buildQuickPolygon:function(){this.quickPolygonVarray.length<=0||(this.cleanQuickPolygon(),this.quickPolygonVBO=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.quickPolygonVBO),this.gl.bufferData(this.gl.ARRAY_BUFFER,YFM.Math.flatten(this.quickPolygonVarray,3),this.gl.STATIC_DRAW),this.quickPolygonSize=this.quickPolygonVarray.length/3,this.quickPolygonVarray=[],this.loaded=!0)},cleanQuickPolygon:function(){if(null!==this.quickPolygonVBO){var t=this.quickPolygonVBO,i=this.gl;this.quickPolygonVBO=null,this.loaded=!1,setTimeout(function(){i.deleteBuffer(t)},2e3)}},_clock_wise_tri:function(t){var i=0;return i+=(t[1][0]-t[0][0])*(t[1][1]+t[0][1]),i+=(t[2][0]-t[1][0])*(t[2][1]+t[1][1]),(i+=(t[0][0]-t[2][0])*(t[0][1]+t[2][1]))>0},_clock_wise_pts:function(t){for(var i=0,e=t.length,r=0;r<e;r++)i+=(t[(r+1)%e][0]-t[r][0])*(t[(r+1)%e][1]+t[r][1]);return i>0},_is_left_turn:function(t,i,e){return(i[0]-t[0])*(e[1]-t[1])-(e[0]-t[0])*(i[1]-t[1])>0},_is_right_turn:function(t,i,e){return(i[0]-t[0])*(e[1]-t[1])-(e[0]-t[0])*(i[1]-t[1])<0},_point_inside:function(t,i,e,r){var s=this._is_left_turn(t,i,r),o=this._is_left_turn(i,e,r),a=this._is_left_turn(e,t,r);if(s&&o&&a)return!0;var h=this._is_right_turn(t,i,r),n=this._is_right_turn(i,e,r),u=this._is_right_turn(e,t,r);return!!(h&&n&&u)},_triangulate_cut_ear:function(t,i){for(var e,r,s,o=this._clock_wise_pts(t),a=[];i.size()>3;){var h,n,u=-1,l=0;do{if(l++,n=i.size(),l>=n)return console.log("bad input."),null;if(u++,e=i.get(u%n),r=i.get((u+1)%n),s=i.get((u+2)%n),h=this._is_left_turn(e,r,s)^o)for(var c=i.getIter();c.hasNext();){var M=c.getNext();if(this._point_inside(e,r,s,M)){h=!1;break}}}while(!h);a.push(e),a.push(r),a.push(s),i.remove((u+1)%n)}return 3==i.size()&&(a.push(i.get(0)),a.push(i.get(1)),a.push(i.get(2))),a}},YFM.Map.ANIM_TYPE_PITCH=0,YFM.Map.ANIM_TYPE_LOOKAT=1,YFM.Map.ANIM_TYPE_LOOKDISTANCE=2,YFM.Map.ANIM_TYPE_LOOKAZIMUTH=3,YFM.Map.ANIM_TYPE_ROTATE_MAP=4,YFM.Map.ANIM_DEFAULT_FRAME=12,AnimationMgr.prototype={constructor:AnimationMgr,pitchLimit:80,update:function(){if(null===this.current&&(this.current=this.seq.removeHigh(),null!==this.current&&(this.touchMgr.setEnable(!1),this.listener.onAnimStart(this.current))),null!==this.current){var t=this.current.step/this.current.frame,i=YFM.Math.lerp;switch(this.current.step+=1,this.current.type){case YFM.Map.ANIM_TYPE_PITCH:r=this.current.step==this.current.frame?this.current.to:i(this.current.from,this.current.to,t),this.camera.setPitch(r),this.current.overlook?0!==r&&(this.region._onOverlook(!1),this.current.overlook=!1,this.touchMgr._setOverlook(!1)):0===r&&(this.region._onOverlook(!0),this.current.overlook=!0,this.touchMgr._setOverlook(!0));break;case YFM.Map.ANIM_TYPE_LOOKDISTANCE:s=this.current.step==this.current.frame?this.current.to:i(this.current.from,this.current.to,t),this.camera.setLookOffset(0,0,s),this.camera.resetLookOffsetTan();break;case YFM.Map.ANIM_TYPE_LOOKAZIMUTH:o=this.current.step==this.current.frame?this.current.to:i(this.current.from,this.current.to,t),this.camera.setAzimuth(o);break;case YFM.Map.ANIM_TYPE_ROTATE_MAP:var e=this.current.to/this.current.frame;this.region.postRotate(e);break;case YFM.Map.ANIM_TYPE_LOOKAT:1==this.current.step&&(this.mover.setLocation(this.current.from[0],this.current.from[1],this.current.from[2]),this.camera.resetLookOffsetTan()),this.mover.arrive(this.current.to,2)?(this.current.step=this.current.frame,this.mover.setLocation(this.current.to[0],this.current.to[1],this.current.to[2])):this.mover.update();a=this.mover.getLocation();this.camera.setLookAt(a[0],a[1],a[2]);break;case YFM.Map.ANIM_TYPE_MERGE:if(this.current.pitch){var r;r=this.current.step==this.current.frame?this.current.pitch.to:i(this.current.pitch.from,this.current.pitch.to,t),this.camera.setPitch(r),this.current.overlook?0!==r&&(this.region._onOverlook(!1),this.current.overlook=!1,this.touchMgr._setOverlook(!1)):0===r&&(this.region._onOverlook(!0),this.current.overlook=!0,this.touchMgr._setOverlook(!0))}if(this.current.distance){var s;s=this.current.step==this.current.frame?this.current.distance.to:i(this.current.distance.from,this.current.distance.to,t),this.camera.setLookOffset(0,0,s),this.camera.resetLookOffsetTan()}if(this.current.azimuth){var o;o=this.current.step==this.current.frame?this.current.azimuth.to:i(this.current.azimuth.from,this.current.azimuth.to,t),this.camera.setAzimuth(o)}if(this.current.lookAt){var a;if(this.current.step==this.current.frame)a=this.current.lookAt.to;else{var h=YFM.Math.Vector;a=h.add(this.current.lookAt.from,h.scale(this.current.lookAt.direction,this.current.step*this.current.lookAt.interval))}this.camera.setLookAt(a[0],a[1],a[2])}}this.current.step>=this.current.frame&&(this.listener.onAnimFinish(this.current),this.current=null,this.touchMgr.setEnable(!0))}},animPitch:function(t,i,e,r){var s=YFM.Math.clamp(t,0,AnimationMgr.prototype.pitchLimit),o=i||null,a=e||YFM.Map.ANIM_DEFAULT_FRAME;(r||!1)&&(this.seq.clean(),null!==this.current&&this.listener.onAnimCancel(this.current),this.current=null);var h=new Animation(o,YFM.Map.ANIM_TYPE_PITCH,a);h.from=this.camera.getPitch(),h.to=-s,h.overlook=0===h.from,this.seq.addLow(h)},animLookDistance:function(t,i,e,r){var s=t,o=i||null,a=e||YFM.Map.ANIM_DEFAULT_FRAME;(r||!1)&&(this.seq.clean(),null!==this.current&&this.listener.onAnimCancel(this.current),this.current=null);var h=new Animation(o,YFM.Map.ANIM_TYPE_LOOKDISTANCE,a);h.from=this.camera.getLookOffsetNormal(),h.to=-s,this.seq.addLow(h)},animLookAzimuth:function(t,i,e,r,s){var o=YFM.Math.deg2Radian(t),a=i||null,h=e||!1,n=r||YFM.Map.ANIM_DEFAULT_FRAME;(s||!1)&&(this.seq.clean(),null!==this.current&&this.listener.onAnimCancel(this.current),this.current=null);var u=new Animation(a,YFM.Map.ANIM_TYPE_LOOKAZIMUTH,n);u.from=this.camera.getAzimuth(),u.to=h?-o:u.from-o,this.seq.addLow(u)},animRotateMap:function(t,i,e){var r=i||null;(e||!1)&&(this.seq.clean(),null!==this.current&&this.listener.onAnimCancel(this.current),this.current=null);var s=new Animation(r,YFM.Map.ANIM_TYPE_ROTATE_MAP,24);s.from=0,s.to=t,this.seq.addLow(s)},animLookAt:function(t,i,e){var r=i||null;(e||!1)&&(this.seq.clean(),null!==this.current&&this.listener.onAnimCancel(this.current),this.current=null);var s=new Animation(r,YFM.Map.ANIM_TYPE_LOOKAT,1024);s.from=this.camera.getLookAt(),s.to=t,this.seq.addLow(s)},animMerge:function(t,i,e,r){var s=i||null,o=e||24;(r||!1)&&(this.seq.clean(),null!==this.current&&this.listener.onAnimCancel(this.current),this.current=null);var a=new Animation(s,YFM.Map.ANIM_TYPE_MERGE,o);if((t.pitch||0===t.pitch)&&(a.pitch={},a.pitch.from=this.camera.getPitch(),a.pitch.to=-YFM.Math.clamp(t.pitch,0,AnimationMgr.prototype.pitchLimit),a.pitch.overlook=0===a.from),t.distance&&(a.distance={},a.distance.from=this.camera.getLookOffsetNormal(),a.distance.to=-t.distance),t.azimuth&&(a.azimuth={},a.azimuth.from=this.camera.getAzimuth(),a.abs?a.azimuth.to=-YFM.Math.deg2Radian(t.azimuth):a.azimuth.to=a.azimuth.from-YFM.Math.deg2Radian(t.azimuth)),t.lookAt){var h=YFM.Math.Vector;a.lookAt={},a.lookAt.from=this.camera.getLookAt(),a.lookAt.to=t.lookAt,a.lookAt.direction=h.normalize(h.sub(a.lookAt.to,a.lookAt.from)),a.lookAt.interval=h.distance(a.lookAt.from,a.lookAt.to)/o,this.camera.resetLookOffsetTan()}this.seq.addLow(a)}},Region.prototype={constructor:Region,setCustomFloorHeight:function(t){this.customFloorHeight=t},setClearColor:function(t){this.clearColor=YFM.WebGL.Color.getRGBVec(t)},setAzimuth:function(t){this.azimuth=t},setZoomConstraint:function(t,i){this.touchMgr.setZoomMin(t),this.touchMgr.setZoomMax(i)},setDrawAllUnit:function(t){this.drawAllUnit=t},setTouchEnable:function(t){this.touchMgr.setEnable(t)},locateLaunch:function(){this.locMarker.locateLaunch()},setLocMarkerParam:function(t,i,e,r){this.locMarker.set2DMarkerParam(t,i,e,r)},setAlwaysDrawUnit:function(t){this.drawUnitTextAlways=t},setUIScaleRate:function(t){this.touchMgr.setUIScaleRate(t)},getId:function(){return this.id},startRender:function(){YFM.gRegion=this,YFM.gRegion._grender()},displayFloor:function(t){if(!(t>=0||t<this.floors.length))throw new Error("Rgeion.js [displayFloor] Floor index out of range:"+t);this.displayFloorIndex=t;var i=this.floors[t].getAspect();this.lookAtMapLoc(t,i.w/2,i.h/2),this.route.setDisplayFloor(t)},getFloorZ:function(t){return this.floors[t].vOffset},displayRegion:function(){this.displayFloorIndex=-1,this.route.setDisplayFloor(-1)},setFontType:function(t){this.ctx2d.font=t,this.fontHeight=this._determineFontHeight("font: "+this.ctx2d.font+";")},setFontColor:function(t){this.ctx2d.fillStyle=t},setStatus:function(t){if(t!==this.status){switch(t){case YFM.Map.STATUS_TOUCH:YFM.Map.STATUS_SENSOR===this.status&&this.camera.disconnect(),this.status=t;break;case YFM.Map.STATUS_SENSOR:YFM.Map.STATUS_SENSOR!==this.status&&this.camera.connect(),this.status=t,this.camera.resetLookOffsetTan(),this.locMarker.updateLocation();break;case YFM.Map.STATUS_TRACE:YFM.Map.STATUS_SENSOR===this.status&&this.camera.disconnect(),this.status=t,this.camera.resetLookOffsetTan(),this.locMarker.updateLocation();break;case YFM.Map.STATUS_NAVIGATE:YFM.Map.STATUS_SENSOR===this.status&&this.camera.disconnect(),this.status=t,this.camera.resetLookOffsetTan(),this.locMarker.updateLocation(),this.locMarker.updateLocation()}this.listener&&this.listener.onStatusChange(this.status)}},getStatus:function(){return this.status},addFloorsURL:function(t){var i,e,r,s=this,o={onLoadFinish:function(t){for(var i=!0,e=0;e<s.floors.length;e++)if(!s.floors[e].isLoaded()){i=!1;break}s.listener&&(s.listener.onLoadFinish(t.id,t.index),i&&(s._restructure(),s.listener.onAllFloorLoadFinish())),i&&s.touchMgr.onRegionLoadFinish()},onLoadFailed:function(t){this.listener&&this.listener.onLoadFailed(t.id,t.index)}};for(e=t.length,r=0;r<e;r++)i=t[r],this.floors.push(new Floor(this.gl,i.id,i.url,i.deflection,this,r,o,this.unitHeight,this.wallHeight,this.isUnitExtrude))},addFloorsSVG:function(t){var i,e,r;for(e=t.length,r=0;r<e;r++)i=t[r],this.floors.push(new Floor(this.gl,i.id,i.svg,i.deflection,this,r,null,this.unitHeight,this.wallHeight,this.isUnitExtrude));this._restructure(),this.listener.onAllFloorLoadFinish(),this.touchMgr.onRegionLoadFinish()},addTexture:function(t,i){this.texturePool.addTexture(t,i)},addTextureMip:function(t,i){this.texturePool.addTextureMip(t,i)},getTexture:function(t){return this.texturePool.getTexture(t)},getFloorCount:function(){return this.floors.length},getFloorAspect:function(t){return this.floors[t].getAspect()},getFloorLoc:function(){return this.locMarker.getFloorLoc()},getRegionLoc:function(){return this.locMarker.getRegionLoc()},setNavigateProj:function(t){this.route.setUpdateNSFlag(t)},updateNaviStatus:function(t,i){this.route.updateNaviStatus(t,i)},cleanLocation:function(){this.locMarker.cleanLocation()},setLocation:function(t,i,e){this.locMarker.setLocation(t,i,e)},postTranslate:function(t,i){this.touchMgr.postTranslate(t,i)},postRotate:function(t){this.touchMgr.postRotate(t)},animTo:function(t,i,e){this.locMarker.animTo(t,i,e)},lookAtMapLoc:function(t,i,e){var r=this.floors[t].floorPos2Region(i,e);this.lookAtRegionLoc(r[0],r[1],r[2])},lookAtWorldLoc:function(t,i,e){this.camera.resetLookOffsetTan(),this.camera.setLookAt(t,i,e)},lookAtRegionLoc:function(t,i,e){var r=YFM.Math.Vector.pos(t,i,e),s=YFM.Math.Matrix.mulVec(this.matRegion,r);this.camera.resetLookOffsetTan(),this.camera.setLookAt(s[0],s[1],s[2])},animRotateMap:function(t){this.animMgr.animRotateMap(t)},animLookAt:function(t,i,e,r){var s=this.floors[t].floorPos2Region(i,e),o=YFM.Math.Matrix.mulVec(this.matRegion,s);this.animMgr.animLookAt(o,r)},animLookAtWorld:function(t,i){this.animMgr.animLookAt(t,i)},animLookDistance:function(t,i){this.animMgr.animLookDistance(t,i)},getLookDistance:function(){return-this.camera.getLookOffsetNormal()},animLookAzimuth:function(t,i){this.animMgr.animLookAzimuth(t,i)},animPitch:function(t,i){this.animMgr.animPitch(t,i)},overlookMap:function(){if(-1===this.displayFloorIndex){if(this.obb){var t=this.obb.center,i=YFM.Math.Matrix.mulVec(this.matRegion,t),e=this.obb.hr,r=this.obb.hs,s=this.obb.ht,o=2*Math.sqrt(e*e+r*r+s*s),a=this.obb.r,h=-(c=YFM.Math.Matrix.eulerParamExtractZ(this.matRegion))+(l=this.camera.getAzimuth())+this._makeAzimuth(a);this.animMgr.animMerge({distance:1.8*o,azimuth:YFM.Math.radian2Deg(this._clampMinorArc(h)),lookAt:i},null,48)}}else{var n=this.floors[this.displayFloorIndex],u=n.floorPos2Region(n.mapWidth/2,n.mapHeight/2),i=YFM.Math.Matrix.mulVec(this.matRegion,u),l=this.camera.getAzimuth(),c=YFM.Math.Matrix.eulerParamExtractZ(this.matRegion),h=-c+l+YFM.Math.deg2Radian(n.deflection),M=n.mapWidth>n.mapHeight?n.mapWidth:n.mapHeight;this.animMgr.animMerge({distance:M,azimuth:YFM.Math.radian2Deg(this._clampMinorArc(h)),lookAt:i},null,32)}},getFloorAngle:function(t){var i=this.floors[t],e=this.camera.getAzimuth(),r=-YFM.Math.Matrix.eulerParamExtractZ(this.matRegion)+e+YFM.Math.deg2Radian(i.deflection);return YFM.Math.radian2Deg(this._clampMinorArc(r))},getFloorDeflection:function(t){return this.floors[t].deflection},setRoute:function(t){this.route.setRoute(t)},cleanRoute:function(){this.route.cleanRoute()},overlookRoute:function(t){var i=this.route.getRouteCenter(this.displayFloorIndex);if(null!==i){var e=YFM.Math.Matrix.mulVec(this.matRegion,i),r=this.route.getRouteRAxis(),s=-YFM.Math.Matrix.eulerParamExtractZ(this.matRegion)+this.camera.getAzimuth()+this._makeAzimuth(r);this.animMgr.animMerge({distance:1.8*this.route.getRouteOBBLength(this.displayFloorIndex),azimuth:YFM.Math.radian2Deg(this._clampMinorArc(s)),lookAt:e,pitch:t},null,48)}},getNaviStatus:function(){return this.route.getNaviStatus()},insertUnit:function(t,i){this.floors[i].insertUnit(t)},insertIcon:function(t,i,e,r){this.floors[i].insertIcon(t,e,r)},insertIconPlus:function(t,i,e,r){this.floors[i].insertIconPlus(t,e,r)},insertModel:function(t,i,e,r,s,o,a){return this.floors[t].insertModel(i,e,r,s,o,a)},removeModel:function(t){var i=this._calcModelFloor(t);return this.floors[i].removeModel(t)},setQuickIconTexture:function(t){for(var i=0;i<this.floors.length;i++)this.floors[i].quickIcons.setTex(t)},addQuickPolygon:function(t,i,e){this.floors[t].quickPolygon.addQuickPolygon(i,e)},buildQuickPolygonAll:function(){for(var t=0;t<this.floors.length;t++)this.floors[t].quickPolygon.buildQuickPolygon()},buildQuickPolygonFloor:function(t){this.floors[t].quickPolygon.buildQuickPolygon()},cleanQuickPolygonAll:function(){for(var t=0;t<this.floors.length;t++)this.floors[t].quickPolygon.cleanQuickPolygon()},cleanQuickPolygonFloor:function(t){this.floors[t].quickPolygon.cleanQuickPolygon()},addQuickIcon:function(t,i,e){this.floors[t].quickIcons.addPoint(i,e)},buildQuickIcon:function(t){this.floors[t].quickIcons.buildPoints()},cleanQuickIcon:function(t){this.floors[t].quickIcons.clean()},insertGeometryMarker:function(t,i,e,r,s,o,a){return this.floors[r].markers.insertGeometryMarker(t,i,e,s,o,a)},insertTextureMarker:function(t,i,e,r,s,o,a){return this.floors[i].markers.insertTextureMarker(t,e,r,s,o,a)},removeMarker:function(t){var i=this._calcMarkerFloor(t);return null!==this.floors[i].markers.removeMarker(t)},updateMarkerLocation:function(t,i,e,r){var s=-1,o=this._calcMarkerFloor(t),a=this.floors[o].markers.removeMarker(t);return null!==a&&(s=this.floors[i].markers.insertMarker(a,e,r)),s},searchModel:function(t,i){var e=this.touchMgr.getFocusFloorIndex();if(-1!=e){var r=this.touchMgr.getTouchRayPlus(t,i);return this.floors[e].searchModel(r,!1)}return[]},searchUnit:function(t,i){var e=this.touchMgr.getFocusFloorIndex();if(-1!=e){var r=this.touchMgr.getTouchRayPlus(t,i);return this.floors[e].searchUnit(r,!1)}return[]},searchIcon:function(t,i){var e=this.touchMgr.getFocusFloorIndex();if(-1!=e){var r=this.touchMgr.getTouchRayPlus(t,i);return this.floors[e].searchIcon(r,80,!1)}return[]},searchIconPlus:function(t,i){var e=this.touchMgr.getFocusFloorIndex();if(-1!=e){var r=this.touchMgr.getTouchRayPlus(t,i);return this.floors[e].searchIconPlus(r,!1)}return[]},searchMarker:function(t,i){for(var e=null,r=Number.MAX_VALUE,s=0;s<this.floors.length;s++)if(-1!==this.floors[s].BBCheck){var o=this.floors[s].markers.findMarker(t,i);null!==o&&r>o.dist&&(e=o,r=o.dist)}return null!==e?e.id:-1},getTouchPosMapLoc:function(t,i){return this.touchMgr._screen_to_map(t,i)},getTouchPosWorldLoc:function(t,i){return this.touchMgr._pos_in_world_space(t,i)},regionPos2Screen:function(t){var i=YFM.Math.Matrix.mul(this.camera.getPVMat(),this.matRegion),e=YFM.Math.Matrix.mulVec(i,t);return e[0]/=e[3],e[1]/=e[3],e[2]/=e[3],e[3]/=e[3],e[0]=e[0]*this.hw+this.hw,e[1]=-e[1]*this.hh+this.hh,e},floorPos2RegionPos:function(t,i,e){if(t<0||t>=this.floors.length)throw new Error("floor index out of bounds");return this.floors[t].floorPos2Region(i,e)},_onOverlook:function(t){this.overlook=t,this.extrudeLight=t?this.extrudeLightOver:this.extrudeLightNormal},_getRegionMat:function(){return this.matRegion},_setRegionMat:function(t){this.matRegion=t},_traceLoc:function(t,i,e){var r=YFM.Math.Vector.pos(t,i,e),s=YFM.Math.Matrix.mulVec(this.matRegion,r);if(YFM.Map.STATUS_NAVIGATE===this.status){var o=0,a=this.getNaviStatus();if(a.validate){var h=YFM.Math.Matrix.eulerParamExtractZ(this.matRegion);o=a.azimuth+h}this.camera.setLookAtAzimuth(o,s[0],s[1],s[2])}else this.camera.setLookAt(s[0],s[1],s[2])},_getFloorMat:function(t){if(t<0||t>=this.floors.length)throw new Error("floor index out of bounds");return this.floors[t].getFloorMat()},_intersectionLine:function(t){var i,e,r=[];for(i=this.floors.length,e=0;e<i;e++)r.push(this.floors[e].intersectionLine(t));return r},_render:function(){var t,i;t=this.floors.length,this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT),this.clearColor&&this.gl.clearColor(this.clearColor[0],this.clearColor[1],this.clearColor[2],1),this.animMgr.update(),this._cleanText(),this.tqct.reset(),this.renderParam.projMat=this.camera.getProjectionMat(),this.renderParam.viewMat=this.camera.getViewMat(),this.renderParam.vrMat=YFM.Math.Matrix.mul(this.renderParam.viewMat,this.matRegion),this.renderParam.pvrMat=YFM.Math.Matrix.mul(this.camera.getPVMat(),this.matRegion);var e=YFM.Math.Matrix.matClone(this.renderParam.vrMat);e[12]=0,e[13]=0,e[14]=0;var r=YFM.Math.Matrix.invert(e),s=YFM.Math.Matrix.scale(15,0,0,0);s=YFM.Math.Matrix.postRotate3d(s,this.camera.getRoll()-90,0,0,1),this.renderParam.bivrMat=YFM.Math.Matrix.mul(r,s),this.frustum.update(this.renderParam.pvrMat),this.panoramaShader.useProgram(),this.panoramaShader.setProjectionMatrix(this.renderParam.projMat),this.panoramaShader.setViewMatrix(this.renderParam.viewMat),this.panorama.render(this.panoramaShader,this.matRegion);var o=[];if(-1===this.displayFloorIndex){n=this.touchMgr.getFocusFloorIndex();for(i=0;i<t;i++){var a=this.floors[i].frustumCheck(this.frustum);this.floors[i].BBCheck=a,this._renderFloor(i,a,n),o.push(a)}}else{for(i=0;i<t;i++)this.floors[i].BBCheck=-1;this.floors[this.displayFloorIndex].BBCheck=1,this._renderFloor(this.displayFloorIndex,a,this.displayFloorIndex)}var h=this.frustum.containCheckPoint(this.locMarker.getRegionLoc());if(-1!==this.displayFloorIndex&&this.displayFloorIndex!==this.getFloorLoc().floor&&(h=!1),this.route.render(),h&&(this.marker2DShader.useProgram(),this.marker2DShader.setProjectionMatrix(this.orthMat),this.color2DShader.useProgram(),this.color2DShader.setProjectionMatrix(this.orthMat)),this.locMarker.render(this.color2DShader,this.marker2DShader,h,this.renderParam.pvrMat),-1===this.displayFloorIndex){var n=this.touchMgr.getFocusFloorIndex();for(i=0;i<t;i++)-1!==o[i]&&this._renderFloor2DMarker(i)}else this._renderFloor2DMarker(this.displayFloorIndex)},_getFloorVOffset:function(t){return t*this.vPitch},_renderFloor2DMarker:function(t,i){this.marker2DShader.useProgram(),this.marker2DShader.setProjectionMatrix(this.orthMat),this.regionPhongShader.useProgram(),this.regionPhongShader.setProjectionMatrix(this.renderParam.projMat),this.regionPhongShader.setViewMatrix(this.renderParam.viewMat),this.regionPhongShader.setRegionMatrix(this.matRegion),this.floors[t].renderMarkers(this.frustum,this.marker2DShader,this.regionPhongShader,this.renderParam.vrMat,this.renderParam.pvrMat)},_renderFloor:function(t,i,e){if(-1!=i){this.baseColorShader.useProgram(),this.baseColorShader.setProjectionMatrix(this.renderParam.projMat),this.baseColorShader.setViewMatrix(this.renderParam.viewMat),this.baseColorShader.setRegionMatrix(this.matRegion),this.floors[t].renderBase(this.baseColorShader,this.touchMgr.getTouchFloor()==t);var r=this.overlook;YFM.Map.STATUS_SENSOR===this.status&&(r=!1);var s=!this.overlook;YFM.Map.STATUS_SENSOR===this.status&&(s=!0),this.basePhongShader.useProgram(),this.basePhongShader.setProjectionMatrix(this.renderParam.projMat),this.basePhongShader.setViewMatrix(this.renderParam.viewMat),this.basePhongShader.setRegionMatrix(this.matRegion),this.floors[t].renderExtrude(this.basePhongShader,this.renderParam.vrMat,this.extrudeLight,s),r&&t==e?this.floors[t].renderUnit(this.frustum,this.selectColorShader):this.drawUnitTextAlways&&this.floors[t].renderUnit(this.frustum,this.selectColorShader),this.pointSpiritShader.useProgram(),this.pointSpiritShader.setProjectionMatrix(this.renderParam.projMat),this.pointSpiritShader.setViewMatrix(this.renderParam.viewMat),this.pointSpiritShader.setRegionMatrix(this.matRegion),this.floors[t].renderQuickIcons(this.pointSpiritShader),this.billboardIconShader.useProgram(),this.billboardIconShader.setProjectionMatrix(this.renderParam.projMat),this.billboardIconShader.setViewMatrix(this.renderParam.viewMat),this.billboardIconShader.setRegionMatrix(this.matRegion),this.billboardIconShader.setIViewMatrix(this.renderParam.bivrMat),this.floors[t].renderIcons(this.frustum,this.billboardIconShader),this.modelPhongShader.useProgram(),this.modelPhongShader.setProjectionMatrix(this.renderParam.projMat),this.modelPhongShader.setViewMatrix(this.renderParam.viewMat),this.modelPhongShader.setRegionMatrix(this.matRegion),this.floors[t].renderModels(this.frustum,this.modelPhongShader,this.renderParam.vrMat,this.modelLight)}},_restructure:function(){var t,i,e,r;for(i=0,r=this.floors.length,e=0;e<r;e++)null!=(t=this.floors[e].getSize())&&t>i&&(i=t);for(this.maxSize=i,this.customFloorHeight?this.vPitch=this.customFloorHeight:this.vPitch=i/3,e=0;e<r;e++)this.floors[e].setVOffset(this.vPitch,e);this._makeBuildingOBB();var s=r*this.vPitch,o=Math.sqrt(s*s+i*i);this.touchMgr.setZoomMax(2*o)},_makeBuildingOBB:function(){var t,i,e,r=[],s=this.floors.length;for(t=0;t<s;t++)i=this.floors[t].mapHeight,e=this.floors[t].mapWidth,r.push(this.floorPos2RegionPos(t,0,0)),r.push(this.floorPos2RegionPos(t,e,0)),r.push(this.floorPos2RegionPos(t,0,i)),r.push(this.floorPos2RegionPos(t,e,i));this.obb=new OBB(r)},_grender:function(){YFM.gRegion._render(),requestAnimFrame(YFM.gRegion._grender)},_makeAzimuth:function(t){var i=YFM.Math.Vector.vec(0,1,0),e=YFM.Math.Vector.normalize(t),r=YFM.Math.Vector.dot3(e,i);return Math.acos(r)},_clampMinorArc:function(t){var i=2*Math.PI,e=t%i;return e>0&&e>Math.PI?e-=i:e<0&&e<-Math.PI&&(e+=i),e},_calcMarkerFloor:function(t){return t%FloorMarkers.prototype.shift},_calcModelFloor:function(t){return t%FloorQuadTree.prototype.shift},_drawText:function(t,i,e){this.ctx2d.fillText(t,i,e)},_cleanText:function(){this.ctx2d.clearRect(0,0,this.txtCanvas.width,this.txtCanvas.height)},_determineFontHeight:function(t){var i=document.getElementsByTagName("body")[0],e=document.createElement("div"),r=document.createTextNode("M");e.appendChild(r),e.setAttribute("style",t),i.appendChild(e);var s=e.offsetHeight;return i.removeChild(e),s}},RegionLocMarker.prototype={constructor:RegionLocMarker,locateLaunch:function(){this.waveRadius[0]=this.waveMax,this.waveRadius[1]=this.waveMax},set2DMarkerParam:function(t,i,e,r){var s=YFM.Math.Vector,o=YFM.WebGL.Color;this.locMarkerTexName=t,this.locMarker=null,this.waveColor=s.vec(o.hexColorRed(i),o.hexColorGreen(i),o.hexColorBlue(i),o.hexColorAlpha(i)),this.waveMax=e,this.waveMin=r,this.waveStep=(this.waveMax-this.waveMin)/56},getRegionLoc:function(){return YFM.Math.Vector.vecClone(this.regionLoc)},getFloorLoc:function(){return{floor:this.floorLoc.floor,x:this.floorLoc.x,y:this.floorLoc.y}},getSize:function(){return this.size},updateLocation:function(){-1!==this.floorLoc.floor&&(this.regionLoc=this.region.floorPos2RegionPos(this.floorLoc.floor,this.floorLoc.x,this.floorLoc.y),YFM.Map.STATUS_TOUCH!=this.region.getStatus()&&this.region._traceLoc(this.regionLoc[0],this.regionLoc[1],this.regionLoc[2]),this.region.updateNaviStatus(this.floorLoc,this.regionLoc))},cleanLocation:function(){this.floorLoc.floor=-1,this.floorLoc.x=0,this.floorLoc.y=0},setLocation:function(t,i,e){this.floorLoc.floor=t,this.floorLoc.x=i,this.floorLoc.y=e,this.regionLoc=this.region.floorPos2RegionPos(t,i,e),YFM.Map.STATUS_TOUCH!=this.region.getStatus()&&this.region._traceLoc(this.regionLoc[0],this.regionLoc[1],this.regionLoc[2]),this.region.updateNaviStatus(this.floorLoc,this.regionLoc)},animTo:function(t,i,e){t!=this.floorLoc.floor?(this.anim.flag=!1,this.setLocation(t,i,e)):(this.anim.floor=t,this.anim.flag=!0,this.anim.target=YFM.Math.Vector.pos(i,e,0),this.anim.mover.setLocation(this.floorLoc.x,this.floorLoc.y,0))},render:function(t,i,e,r){if(this._updateAnim(),e&&!(this.floorLoc.floor<0)){if(!this.locMarker&&this.locMarkerTexName){var s=this.region.getTexture(this.locMarkerTexName);null!==s&&(this.locMarker={tex:s.tex,texSize:YFM.Math.Vector.vec(s.w/2,s.h/2)})}if(this.locMarker){var o,a,h,n,u=YFM.Math.Matrix.mulVec(r,this.regionLoc);h=this.region.glCanvas.width/2,n=this.region.glCanvas.height/2,u[0]/=u[3],u[1]/=u[3],u[2]/=u[3],u[3]/=u[3],u[0]*=h,u[1]*=n,this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),o=YFM.Math.Matrix.scaleXYZ(this.waveRadius,0,0,0),a=YFM.Math.Matrix.postTranslate(o,u[0],u[1],0),t.setModelMatrix(a),t.drawTriangles(this.circleVBO,this.waveColor,0,this.circleSize),this.waveRadius[0]>this.waveMin?(this.waveRadius[0]-=this.waveStep,this.waveRadius[1]-=this.waveStep):(this.waveRadius[0]=this.waveMin,this.waveRadius[1]=this.waveMin),i.useProgram(),i.bindTexture(this.locMarker.tex);var l=this.region.getFloorDeflection(this.floorLoc.floor)-(this.region.azimuth+this.region.getFloorAngle(this.floorLoc.floor));o=YFM.Math.Matrix.scaleXYZ(this.locMarker.texSize,0,0,0),o=YFM.Math.Matrix.postTranslate(YFM.Math.Matrix.postRotateXY(o,l,0,0),u[0],u[1],0),i.setModelMatrix(o),i.drawTriangles(this.quadVBO,6,0),this.gl.disable(this.gl.BLEND)}}},_updateAnim:function(){if(this.anim.flag)if(this.anim.mover.arrive(this.anim.target,this.anim.dist))this.anim.flag=!1,this.setLocation(this.anim.floor,this.anim.target[0],this.anim.target[1]);else{this.anim.mover.update();var t=this.anim.mover.getLocation();this.setLocation(this.anim.floor,t[0],t[1])}},_init:function(t,i){var e=YFM.Math.Vector,r=2.5*i,s=[];s.push(e.pos(0,0,0)),s.push(e.pos(0,i,r)),s.push(e.pos(i,0,r)),s.push(e.pos(0,-i,r)),s.push(e.pos(-i,0,r));var o=[];o.push(s[4]),o.push(s[2]),o.push(s[1]),o.push(s[2]),o.push(s[4]),o.push(s[3]),o.push(s[0]),o.push(s[4]),o.push(s[1]),o.push(s[0]),o.push(s[1]),o.push(s[2]),o.push(s[0]),o.push(s[2]),o.push(s[3]),o.push(s[0]),o.push(s[3]),o.push(s[4]),o.push(s[0]),o.push(s[1]),o.push(s[0]),o.push(s[2]),o.push(s[0]),o.push(s[3]),o.push(s[0]),o.push(s[4]),o.push(s[1]),o.push(s[2]),o.push(s[2]),o.push(s[3]),o.push(s[3]),o.push(s[4]),o.push(s[4]),o.push(s[1]),this.trianglesVBO=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.trianglesVBO),t.bufferData(t.ARRAY_BUFFER,YFM.Math.flatten(o,3),t.STATIC_DRAW);var a=[],h=2*Math.PI;a.push(e.pos(0,0,15));for(var n=0;n<h;n+=.1)a.push(e.pos(Math.cos(n),Math.sin(n),15));var u,l,c=[];for(u=1,l=a.length-1;u<l;u++)c.push(a[u]),c.push(a[0]),c.push(a[u+1]);c.push(a[u]),c.push(a[0]),c.push(a[1]),this.circleVBO=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.circleVBO),t.bufferData(t.ARRAY_BUFFER,YFM.Math.flatten(c,3),t.STATIC_DRAW),this.circleSize=c.length;var M=[],g=[],d=[];d.push(YFM.Math.Vector.vec(0,1)),d.push(YFM.Math.Vector.vec(1,1)),d.push(YFM.Math.Vector.vec(1,0)),d.push(YFM.Math.Vector.vec(0,0)),g.push(YFM.Math.Vector.pos(-1,-1,0)),g.push(YFM.Math.Vector.pos(1,-1,0)),g.push(YFM.Math.Vector.pos(1,1,0)),g.push(YFM.Math.Vector.pos(-1,1,0)),M.push(g[0]),M.push(d[0]),M.push(g[1]),M.push(d[1]),M.push(g[2]),M.push(d[2]),M.push(g[0]),M.push(d[0]),M.push(g[2]),M.push(d[2]),M.push(g[3]),M.push(d[3]),this.quadVBO=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.quadVBO),t.bufferData(t.ARRAY_BUFFER,YFM.Math.flatten(M,3),t.STATIC_DRAW)}},RegionTouchMgr.prototype={constructor:RegionTouchMgr,setUIScaleRate:function(t){this.uiScaleRate=t},getViewOffsetMax:function(){return this.viewZoom.max},getViewOffsetMin:function(){return this.viewZoom.min},setEnable:function(t){this.enable=t},onRegionLoadFinish:function(){this.focusFloorDirty=!0},getTouchFloor:function(){return this.touchFloorIndex},getFocusFloorIndex:function(){if(!this.focusFloorDirty)return this.focusFloorIndex;var t,i,e,r,s,o,a=-1;for(e=-1e8,o=-1,s=-1,i=(t=this._floors_collision(this.canvas.width/2,this.canvas.height/2)).length,r=0;r<i;r++)t[r]<0&&t[r]>e&&(e=t[r],o=r),0==t[r]&&(s=r);return s>=0?a=s:o>=0&&(a=o),this.focusFloorIndex=a,this.focusFloorDirty=!1,this.focusFloorIndex},setZoomMax:function(t){this.viewZoom.max=t},setZoomMin:function(t){this.viewZoom.min=t},postTranslate:function(t,i){var e=YFM.Math.Matrix.matClone(this.region._getRegionMat()),r=YFM.Math.Matrix.postTranslate(e,t,i,0);this._mapConstraint(this.camera.getPVMat(),r)||(this.region._setRegionMat(r),this._onScroll(t,i),this.focusFloorDirty=!0)},postRotate:function(t){var i=this._pos_in_world_space(this.region.hw,this.region.hh),e=YFM.Math.Matrix.matClone(this.region._getRegionMat()),r=YFM.Math.Matrix.postRotateXY(e,t,i[0],i[1]);this._mapConstraint(this.camera.getPVMat(),r)||(this.region._setRegionMat(r),this.focusFloorDirty=!0)},getTouchRayPlus:function(t,i){var e,r,s,o,a,h,n,u;return e=t/this.canvas.width*2-1,r=-(i/this.canvas.height*2-1),s=YFM.Math.Vector.pos(e,r,-1),o=YFM.Math.Vector.pos(e,r,1),n=YFM.Math.Matrix.mul(this.camera.getPVMat(),this.region.matRegion),u=YFM.Math.Matrix.invert(n),a=YFM.Math.Matrix.mulVec(u,s),h=YFM.Math.Matrix.mulVec(u,o),a[0]/=a[3],a[1]/=a[3],a[2]/=a[3],a[3]/=a[3],h[0]/=h[3],h[1]/=h[3],h[2]/=h[3],h[3]/=h[3],YFM.Math.Line.linePP(a,h)},_onMouseDown:function(t,i){},_onScroll:function(t,i){null!==this.listener&&this.listener.onScroll(t,i)},_onClick:function(t,i){null!==this.listener&&this.listener.onClick(t,i)},_onDClick:function(t,i){null!==this.listener&&this.listener.onDClick(t,i)},_on2FClick:function(t,i){null!==this.listener&&this.listener.on2FClick(t,i)},_onLongPressUp:function(t,i){null!==this.listener&&this.listener.onLongPressUp(t,i)},_spacingScreenSpace:function(t,i,e,r){var s=e-t,o=r-i;return Math.sqrt(s*s+o*o)},_spacingViewSpace:function(t,i,e,r){var s=this._pos_in_view_space(t,i),o=this._pos_in_view_space(e,r),a=o[0]-s[0],h=o[1]-s[1];return{z:(s[2]+o[2])/2,spacing:Math.sqrt(a*a+h*h)}},_midpoint:function(t,i,e,r){var s,o;return s=(t+e)/2,o=(i+r)/2,this.touchRec.midX=s,this.touchRec.midY=o,this.touchRec.dy0=i-o,this.touchRec.dy1=r-o,this._pos_in_world_space(s,o)},_calc_angle:function(t){var i=this._pos_in_world_space(this.touchRec.layer0x,this.touchRec.layer0y),e=this._pos_in_world_space(this.touchRec.layer1x,this.touchRec.layer1y);return Math.atan2(e[1]-i[1],e[0]-i[0])},_pitch_calc:function(t){return YFM.Math.radian2Deg(YFM.Math.Matrix.eulerParamExtractX(t))},_pitch_detect_continue:function(t){if(t.touches.length<2)return!1;var i,e;return i=this.touchRec.layer0y-this.touchRec.start0y,e=this.touchRec.layer1y-this.touchRec.start1y,i*e>0?this.touchRec.pitchCnt++:this.touchRec.pitchCnt--,this.touchRec.pitchCnt>36},_touch_plane_height:function(t,i){if(-1!==this.region.displayFloorIndex)return this.touchFloorIndex=this.region.displayFloorIndex,this.region._getFloorVOffset(this.region.displayFloorIndex);var e,r,s,o,a,h,n=-1;for(s=-1e8,h=-1,a=-1,r=(e=this._floors_collision(t,i)).length,o=0;o<r;o++)e[o]<0&&e[o]>s&&(s=e[o],h=o),0==e[o]&&(a=o);return a>=0?n=a:h>=0&&(n=h),this.touchFloorIndex=n,this.region._getFloorVOffset(n)},_floors_collision:function(t,i){var e=this.getTouchRayPlus(t,i);return this.region._intersectionLine(e)},_pitch_detect_first:function(t){if(t.touches.length<2)return!1;var i,e,r;return e=mgr.touchRec.layer0y-this.touchRec.midY-this.touchRec.dy0,r=mgr.touchRec.layer1y-this.touchRec.midY-this.touchRec.dy1,this.touchRec.pitchCnt=0,i=!1,e*r>0&&(i=!0),i},_pos_in_world_space:function(t,i){var e,r,s,o,a,h,n,u,l,c;return r=t/this.canvas.width*2-1,s=-(i/this.canvas.height*2-1),o=YFM.Math.Vector.pos(r,s,-1),a=YFM.Math.Vector.pos(r,s,1),u=this.camera.getIPVMat(),h=YFM.Math.Matrix.mulVec(u,o),n=YFM.Math.Matrix.mulVec(u,a),h[0]/=h[3],h[1]/=h[3],h[2]/=h[3],h[3]/=h[3],n[0]/=n[3],n[1]/=n[3],n[2]/=n[3],n[3]/=n[3],c=YFM.Math.Line.linePP(h,n),l=YFM.Math.Plane.plane(0,0,this.planeRec.planeHeight,0,0,1),e=YFM.Math.Plane.intersectionLine(l,c),YFM.Math.Line.getPoint(c,e)},_pos_in_view_space:function(t,i){var e=this._pos_in_world_space(t,i);return this._world_to_view(e)},_world_to_view:function(t){return YFM.Math.Matrix.mulVec(this.camera.getViewMat(),t)},_setOverlook:function(t){this.overlook=t},_screen_to_map:function(t,i){if(this.touchFloorIndex>=0){var e=this._pos_in_world_space(t,i),r=this.region._getFloorMat(this.touchFloorIndex),s=this.region._getRegionMat(),o=YFM.Math.Matrix.mul(s,r),a=YFM.Math.Matrix.invert(o),h=YFM.Math.Matrix.mulVec(a,e);return{floor:this.touchFloorIndex,x:h[0],y:this.region.getFloorAspect(this.touchFloorIndex).h-h[1]}}return null},_updateEventLayerPos:function(t){var i,e;t.layerX&&t.pageX?(i=t.layerX-t.pageX,e=t.layerY-t.pageY):(i=-t.target.offsetLeft,e=-t.target.offsetTop),t.touches&&t.touches.length>=1?(this.touchRec.layer0x=(t.touches[0].pageX+i)/this.uiScaleRate,this.touchRec.layer0y=(t.touches[0].pageY+e)/this.uiScaleRate,t.touches.length>=2?(this.touchRec.layer1x=(t.touches[1].pageX+i)/this.uiScaleRate,this.touchRec.layer1y=(t.touches[1].pageY+e)/this.uiScaleRate):(this.touchRec.layer1x=0,this.touchRec.layer1y=0)):(this.touchRec.layer0x=t.layerX/this.uiScaleRate,this.touchRec.layer0y=t.layerY/this.uiScaleRate)},_mapConstraint:function(t,i){var e,r,s,o,a,h,n,u,l=YFM.Math.Matrix,c=YFM.Math.Vector;e=c.pos(0,0,-1),r=c.pos(0,0,1),a=l.mul(t,this.region.matRegion),h=l.invert(a),s=l.mulVec(h,e),o=l.mulVec(h,r),s[0]/=s[3],s[1]/=s[3],s[2]/=s[3],s[3]/=s[3],o[0]/=o[3],o[1]/=o[3],o[2]/=o[3],o[3]/=o[3],n=YFM.Math.Line.linePP(s,o),a=l.mul(this.camera.getPVMat(),i),h=l.invert(a),s=l.mulVec(h,e),o=l.mulVec(h,r),s[0]/=s[3],s[1]/=s[3],s[2]/=s[3],s[3]/=s[3],o[0]/=o[3],o[1]/=o[3],o[2]/=o[3],o[3]/=o[3],u=YFM.Math.Line.linePP(s,o);var M;M=this.touchFloorIndex<0?this.region.displayFloorIndex:this.touchFloorIndex;var g=this.region.floors[M],d=g.intersectionLine(n);return g.intersectionLine(u)<d},_isMobileBrowser:function(){var t=navigator.userAgent.toLowerCase(),i="ipad"==t.match(/ipad/i),e="iphone os"==t.match(/iphone os/i),r="midp"==t.match(/midp/i),s="rv:1.2.3.4"==t.match(/rv:1.2.3.4/i),o="ucweb"==t.match(/ucweb/i),a="android"==t.match(/android/i),h="windows ce"==t.match(/windows ce/i),n="windows mobile"==t.match(/windows mobile/i);return i||e||r||s||o||a||h||n}},SSRoute.prototype={constructor:SSRoute,setDisplayFloor:function(t){this.displayFloor=t,this.dataLoad&&this._buildVBOFromSeglist()},getNaviStatus:function(){return this.naviStatus.validate?{validate:this.naviStatus.validate,projDist:this.naviStatus.projDist,goalDist:this.naviStatus.goalDist,globalDist:this.naviStatus.globalDist,serialDist:this.naviStatus.serialDist,nextSerialDist:this.naviStatus.nextSerialDist,azimuth:this.naviStatus.azimuth,sug:this.naviStatus.sug,nextSug:this.naviStatus.nextSug}:{validate:!1}},getRouteCenter:function(t){return t>=0?this.floorRouteList[t].box?YFM.Math.Vector.vecClone(this.floorRouteList[t].box.center):null:this.obb?YFM.Math.Vector.vecClone(this.obb.center):null},getRouteRAxis:function(t){return t>=0?this.floorRouteList[t].box?YFM.Math.Vector.vecClone(this.floorRouteList[t].box.r):null:this.obb?YFM.Math.Vector.vecClone(this.obb.r):null},getRouteOBBLength:function(t){if(t>=0){if(this.floorRouteList[t].box){var i=this.floorRouteList[t].box.hr,e=this.floorRouteList[t].box.hs;return 2*Math.sqrt(i*i+e*e)}return 0}if(this.obb){var i=this.obb.hr,e=this.obb.hs,r=this.obb.ht;return 2*Math.sqrt(i*i+e*e+r*r)}return 0},setRoute:function(t){this.routeData=t,this.cleanRoute();var i,e,r,s,o,a,h,n,u,l,c=[];for(a=this.region.getFloorCount(),this.floorRouteList=[],this.globalSegList=[],u=0;u<a;u++)this.floorRouteList.push(new FloorRoute(u,this.region,this));for(h=t.length,u=0;u<h;u++)s=t[u],(r=this.region.floorPos2RegionPos(s.floor,s.x,s.y))[2]+=this.routeHeight,c.push(r);for(this.obb=new OBB(c),l=t[0].floor,u=0;u<h-1;u++)s=t[u],(o=t[u+1]).floor===l?this.floorRouteList[l].addSeg(c[u],c[u+1]):l=o.floor;for(u=0;u<a;++u)this.floorRouteList[u].makeBox();n=0;var M;for(u=this.globalSegList.length-1;u>=0;--u)(M=this.globalSegList[u]).updateFolowLen(n),n+=M.len;this._buildVBOFromSeglist(),-1!=(i=this.region.getFloorLoc()).floor&&(e=this.region.getRegionLoc(),this.updateNaviStatus(i,e)),this.dataLoad=!0},cleanRoute:function(){this.floorRouteList=null,this.globalSegList=null,this._clean(),this.dataLoad=!1},addGlobalSeg:function(t,i){i&&this.globalSegList.pop(),this.globalSegList.push(t)},setUpdateNSFlag:function(t){var i=!this.updateNSFlag&&t,e=this.updateNSFlag&&!t;if(i){this.updateNSFlag=!0;var r=this.region.getFloorLoc();if(-1!==r.floor){var s=this.region.getRegionLoc();this.updateNaviStatus(r,s)}}else e&&(this.updateNSFlag=!1,this.naviStatus.validate=!1)},updateNaviStatus:function(t,i){this.updateNSFlag&&(this.floorRouteList?-1===t.floor?this.naviStatus.validate=!1:this.floorRouteList[t.floor].makeNaviStatus(this.naviStatus,i):this.naviStatus.validate=!1)},render:function(){if(this.polylineZ){this._update();var t=this.region.gl,i=this.region.ssrShader,e=this.region.texturePool;i.useProgram(),i.setTime(this.time);var r=0,s=e.getTexture("route_tex"),o=!0;null!=s&&(i.bindTexture(s.tex),t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),-1!==this.displayFloor&&this.displayFloor!==this.region.getFloorLoc().floor&&(o=!1),this.naviStatus.validate&&this.updateNSFlag&&o&&(r=6*this.naviStatus.miniOffset),i.setTranFlag(1),i.drawTriangleStrip(this.polylineZ,r),t.enable(t.DEPTH_TEST),t.depthFunc(t.LEQUAL),i.setTranFlag(0),i.drawTriangleStrip(this.polylineZ,r),this.naviStatus.validate&&o&&this._renderTail(),t.disable(t.DEPTH_TEST),t.disable(t.BLEND),this.time-=.01)}},_initTail:function(){this.tailMesh=new IcosahedronMesh(this.region.gl,4)},_renderTail:function(){var t=this.region.regionPhongShader;t.useProgram(),t.setProjectionMatrix(this.region.renderParam.projMat),t.setViewMatrix(this.region.renderParam.viewMat),t.setRegionMatrix(this.region.matRegion),t.setColor(this.tailColor);var i=YFM.Math.Matrix.transpose(this.region.renderParam.vrMat),e=YFM.Math.Matrix.invert(i);t.setLightPos(this.light),t.setNormalMatrix(e);var r,s,o,a,h,n,u;for(o=this.naviStatus.projection,a=YFM.Math.Vector.normalize(YFM.Math.Vector.sub(this.region.getRegionLoc(),o)),h=this.naviStatus.projDist,n=4*this.tailSize,u=0,r=YFM.Math.Matrix.scale(this.tailSize,0,0,0);u<h;)s=YFM.Math.Vector.add(o,YFM.Math.Vector.scale(a,u)),t.setModelMatrix(YFM.Math.Matrix.postTranslate(r,s[0],s[1],s[2]+this.tailSize)),t.drawTriangles(this.tailMesh.getMeshVBO(),this.tailMesh.getMeshBufSize(),0),u+=n},_buildVBOFromSeglist:function(){var t,e,r,s=[];if(-1===this.displayFloor){for(r=this.globalSegList.length,currentFloor=this.globalSegList[0].floor,i=0;i<r;i++)t=this.globalSegList[i],i<r-1?(e=this.globalSegList[i+1]).floor===currentFloor?s.push(t.start):(currentFloor=e.floor,s.push(t.start),s.push(t.end)):(s.push(t.start),s.push(t.end));this._build(s)}else{var o=this.floorRouteList[this.displayFloor].segList;if(o.length<=0)this._clean();else{for(r=o.length,i=0;i<r;i++)t=o[i],i<r-1?s.push(t.start):(s.push(t.start),s.push(t.end));this._build(s)}}},_build:function(t){if(t.length>=2){var i=[];for(a=0,h=t.length;a<h;a++)this._radiusPointPlus(t,i,a);this.handledPts=i,this.polylineZ&&(this.polylineZ.recycle(),this.polylineZ=null);var e=YFM.Math.Matrix,r=YFM.Math.Vector;this.vArrayL=[],this.tArrayL=[],this.vArrayR=[],this.tArrayR=[],this.vArrayZ=[],this.tArrayZ=[];var s,o,a,h,n,u,l,c=r.pos(0),M=r.pos(0),g=(r.pos(0),r.pos(0)),d=r.vec(0),p=r.vec(0),f=r.vec(0),m=this.region.renderParam.pvrMat;for(s=0,lineDist=0,a=0,h=this.handledPts.length;a<h-1;a++)this._pos2ScreenTo(c,this.handledPts[a],m,this.region.hw,this.region.hh),this._pos2ScreenTo(g,this.handledPts[a+1],m,this.region.hw,this.region.hh),r.midTo(M,c,g),r.subTo(d,g,c),o=r.norm3(d),r.normalizeTo(d),e.mulVecTo(this.rotateLeft,d,p),r.scaleTo(p,this.width),e.mulVecTo(this.rotateRight,d,f),r.scaleTo(f,this.width),n=s/this.stepLen,u=(s+o/2)/this.stepLen,l=(s+o)/this.stepLen,s+=o,this.vArrayL.push(r.add(c,p)),this.tArrayL.push(r.pos(0,n)),this.vArrayR.push(r.add(c,f)),this.tArrayR.push(r.pos(1,n)),this.vArrayL.push(r.add(M,p)),this.tArrayL.push(r.pos(0,u)),this.vArrayR.push(r.add(M,f)),this.tArrayR.push(r.pos(1,u)),this.vArrayL.push(r.add(g,p)),this.tArrayL.push(r.pos(0,l)),this.vArrayR.push(r.add(g,f)),this.tArrayR.push(r.pos(1,l));for(h=this.vArrayL.length,a=0;a<h;a++)this.vArrayZ.push(this.vArrayR[a]),this.tArrayZ.push(this.tArrayR[a]),this.vArrayZ.push(this.vArrayL[a]),this.tArrayZ.push(this.tArrayL[a]);this.polylineZ=new VAttribs(this.region.gl),this.polylineZ.addAttribute("position",this.vArrayZ,3,!1),this.polylineZ.addAttribute("uv",this.tArrayZ,2,!1)}},_projection:function(t,i,e,r){var s=YFM.Math.Vector.sub(t,i),o=YFM.Math.Vector.sub(e,i),a=YFM.Math.Vector.dot3(o,o),h=YFM.Math.Vector.dot3(s,o)/a;h<=0?h=0:h>=1&&(h=1),r.pos=YFM.Math.Vector.add(i,YFM.Math.Vector.scale(o,h)),r.t=h},_update:function(){var t,i,e,r,s,o,a,h,n,u,l=YFM.Math.Matrix,c=YFM.Math.Vector,M=c.pos(0),g=c.pos(0),d=c.pos(0),p=c.vec(0),f=c.vec(0),m=c.vec(0),v=this.region.renderParam.pvrMat,F=this.region.getRegionLoc(),x={pos:null,t:0};n=Number.MAX_VALUE,t=0;var _=!0;if(-1!==this.displayFloor&&this.displayFloor!==this.region.getFloorLoc().floor&&(_=!1),this.naviStatus.validate&&_)for(e=0,r=this.handledPts.length;e<r-1;e++)this._projection(F,this.handledPts[e],this.handledPts[e+1],x),(h=YFM.Math.Vector.distanceSQ(F,x.pos))<=n&&(n=h,u=x.pos,this.naviStatus.miniOffset=e);else this.naviStatus.miniOffset=0;for(e=this.naviStatus.miniOffset,r=this.handledPts.length;e<r-1;e++)this.naviStatus.validate&&e==this.naviStatus.miniOffset&&_?this._pos2ScreenTo(M,u,v,this.region.hw,this.region.hh):this._pos2ScreenTo(M,this.handledPts[e],v,this.region.hw,this.region.hh),this._pos2ScreenTo(d,this.handledPts[e+1],v,this.region.hw,this.region.hh),c.midTo(g,M,d),c.subTo(p,d,M),i=c.norm3(p),c.normalizeTo(p),l.mulVecTo(this.rotateLeft,p,f),c.scaleTo(f,this.width),l.mulVecTo(this.rotateRight,p,m),c.scaleTo(m,this.width),s=t/this.stepLen,o=(t+i/2)/this.stepLen,a=(t+i)/this.stepLen,t+=i,c.addTo(this.vArrayL[3*e+0],M,f),this.tArrayL[3*e+0][1]=s,c.addTo(this.vArrayR[3*e+0],M,m),this.tArrayR[3*e+0][1]=s,c.addTo(this.vArrayL[3*e+1],g,f),this.tArrayL[3*e+1][1]=o,c.addTo(this.vArrayR[3*e+1],g,m),this.tArrayR[3*e+1][1]=o,c.addTo(this.vArrayL[3*e+2],d,f),this.tArrayL[3*e+2][1]=a,c.addTo(this.vArrayR[3*e+2],d,m),this.tArrayR[3*e+2][1]=a;this.polylineZ.updateAttribute("position",this.vArrayZ),this.polylineZ.updateAttribute("uv",this.tArrayZ)},_clean:function(){this.polylineZ&&(this.polylineZ.recycle(),this.polylineZ=null),this.handledPts=null},_pos2Screen:function(t,i,e,r){var s=YFM.Math.Matrix.mulVec(i,t);return s[0]/=s[3],s[1]/=s[3],s[2]/=s[3],s[3]/=s[3],s[0]=s[0]*e,s[1]=s[1]*r,s},_pos2ScreenTo:function(t,i,e,r,s){YFM.Math.Matrix.mulVecTo(e,i,t),t[3]>0?(t[0]/=t[3],t[1]/=t[3],t[2]/=t[3],t[3]/=t[3]):t[3]<0&&(t[0]/=-t[3],t[1]/=-t[3],t[2]/=-t[3],t[3]/=-t[3]),t[0]=t[0]*r,t[1]=t[1]*s},_radiusPointPlus:function(t,i,e){var r=t.length;if(e<=0||e>=r-1)i.push(t[e]);else{var s,o,a,h,n,u,l,c,M,g,d,p,f,m,v,F=YFM.Math.Matrix,x=YFM.Math.Vector;i[i.length-1];if(a=t[e-1],s=t[e],o=t[e+1],Math.abs(s[2]-a[2])>1||Math.abs(s[2]-o[2])>1)i.push(s);else{h=x.normalize(x.sub(a,s)),n=x.normalize(x.sub(o,s)),u=x.normalize(x.add(h,n)),l=x.scale(u,-1*this.width),c=x.sub(s,a),M=x.sub(o,s),m=x.cross(c,M),d=1.5708463-(g=Math.acos(x.dot3(u,n))),p=this.width/Math.sin(g),f=this.width/Math.tan(g),v=x.add(s,x.scale(u,p));var _=[],Y=F.rotateXY(-d,v[0],v[1],!0),R=d/3,y=F.rotateXY(R,v[0],v[1],!0);l=F.mulVec(Y,l),_.push(x.add(s,x.scale(h,f))),l=F.mulVec(y,l),_.push(x.add(v,l)),l=F.mulVec(y,l),_.push(x.add(v,l)),l=F.mulVec(y,l),_.push(x.add(v,l)),l=F.mulVec(y,l),_.push(x.add(v,l)),l=F.mulVec(y,l),_.push(x.add(v,l)),l=F.mulVec(y,l),_.push(x.add(s,x.scale(n,f))),m[2]>0?(i.push(_[0]),i.push(_[1]),i.push(_[2]),i.push(_[3]),i.push(_[4]),i.push(_[5]),i.push(_[6])):(i.push(_[0]),i.push(_[5]),i.push(_[4]),i.push(_[3]),i.push(_[2]),i.push(_[1]),i.push(_[6]))}}}},RouteSeg.prototype={constructor:RouteSeg,updateFolowLen:function(t){this.followLen=t},updateEnd:function(t){this.end=t,this.segVec=YFM.Math.Vector.sub(this.end,this.start),this.lenSQ=YFM.Math.Vector.dot3(this.segVec,this.segVec),this.len=Math.sqrt(this.lenSQ),this.azimuth=this._makeAzimuth()},getPoint:function(t){return YFM.Math.Vector.add(this.start,YFM.Math.Vector.scale(this.segVec,t))},projection:function(t){var i=YFM.Math.Vector.sub(t,this.start),e=YFM.Math.Vector.dot3(i,this.segVec)/this.lenSQ;return e<=0?0:e>=1?1:e},_makeAzimuth:function(){var t=YFM.Math.Vector.vec(0,1,0),i=YFM.Math.Vector.normalize(this.segVec),e=YFM.Math.Vector.dot3(i,t),r=Math.acos(e);return i[0]>0&&(r=2*Math.PI-r),r}},FloorRoute.prototype={constructor:FloorRoute,makeBox:function(){this.lastPos&&(this.posList.push(this.lastPos),this.box=new OBB(this.posList))},addSeg:function(t,i){this.posList.push(t),this.lastPos=i;var e,r,s=new RouteSeg(t,i,this.floor),o=YFM.Math.Vector.normalize(s.segVec);null!=this.lastSegVec?(e=YFM.Math.Vector.dot3(o,this.lastSegVec),Math.abs(e-1)<1e-5?((r=this.segList.pop()).updateEnd(i),this.segList.push(r),this.route.addGlobalSeg(r,!0)):(this.segList.push(s),this.route.addGlobalSeg(s,!1))):(this.segList.push(s),this.route.addGlobalSeg(s,!1)),this.lastSegVec=o},makeNaviStatus:function(t,i){var e,r,s,o,a,h,n,u,l=this.segList.length;if(l<=0)t.validate=!1;else{t.validate=!0,a=Number.MAX_VALUE;var c=l;if(c<=0)return void(t.validate=!1);for(h=0;h<c;h++)e=this.segList[h].projection(i),r=this.segList[h].getPoint(e),(o=YFM.Math.Vector.distanceSQ(i,r))<=a&&(a=o,s=r,n=h,e);for(t.projection=s,YFM.Math.Vector.distance(t.projection,this.segList[n].start),t.projDist=YFM.Math.Vector.distance(t.projection,i),t.serialDist=YFM.Math.Vector.distance(t.projection,this.segList[n].end),n+1<l?(t.nextSerialDist=this.segList[n+1].len,(u=this.segList[n+1].azimuth-this.segList[n].azimuth)<0&&(u+=2*Math.PI),u<=.175||u>=6.11?t.nextSug=YFM.Map.Navigate.NextSuggestion.FRONT:u<Math.PI?t.nextSug=YFM.Map.Navigate.NextSuggestion.LEFT:t.nextSug=YFM.Map.Navigate.NextSuggestion.RIGHT):(t.nextSerialDist=0,t.nextSug=YFM.Map.Navigate.NextSuggestion.ARRIVE),t.goalDist=t.serialDist,h=n+1;h<l;h++)t.goalDist+=this.segList[h].len;t.globalDist=t.goalDist+this.segList[l-1].followLen,t.azimuth=this.segList[n].azimuth,t.sug=this.makeCurrentSug(this.region.azimuth,t.azimuth)}},makeCurrentSug:function(t,i){var e;return(e=i-t)<0&&(e=360+e),e>337.5&&e<=0||e>0&&e<=22.5?YFM.Map.Navigate.Suggestion.FRONT:e>22.5&&e<=67.5?YFM.Map.Navigate.Suggestion.FRONT:e>67.5&&e<=112.5?YFM.Map.Navigate.Suggestion.RIGHT:e>112.5&&e<=157.5?YFM.Map.Navigate.Suggestion.BACKWARD:e>157.5&&e<=202.5?YFM.Map.Navigate.Suggestion.BACKWARD:e>202.5&&e<=247.5?YFM.Map.Navigate.Suggestion.BACKWARD:e>247.5&&e<=292.5?YFM.Map.Navigate.Suggestion.LEFT:YFM.Map.Navigate.Suggestion.FRONT},getLength:function(){return this.segList.length},getSeg:function(t){return this.segList[t]}},Euler.RotationOrders=["XYZ","YZX","ZXY","XZY","YXZ","ZYX"],Euler.DefaultOrder="ZXY",Euler.prototype={constructor:Euler,setFromMatrix:function(t,i,e){var r=YFM.Math.clamp,s=t[0],o=t[4],a=t[8],h=t[1],n=t[5],u=t[9],l=t[2],c=t[6],M=t[10];return"XYZ"===(i=i||this.order)?(this.y=Math.asin(r(a,-1,1)),Math.abs(a)<.99999?(this.x=Math.atan2(-u,M),this.z=Math.atan2(-o,s)):(this.x=Math.atan2(c,n),this.z=0)):"YXZ"===i?(this.x=Math.asin(-r(u,-1,1)),Math.abs(u)<.99999?(this.y=Math.atan2(a,M),this.z=Math.atan2(h,n)):(this.y=Math.atan2(-l,s),this.z=0)):"ZXY"===i?(this.x=Math.asin(r(c,-1,1)),Math.abs(c)<.99999?(this.y=Math.atan2(-l,M),this.z=Math.atan2(-o,n)):(this.y=0,this.z=Math.atan2(h,s))):"ZYX"===i?(this.y=Math.asin(-r(l,-1,1)),Math.abs(l)<.99999?(this.x=Math.atan2(c,M),this.z=Math.atan2(h,s)):(this.x=0,this.z=Math.atan2(-o,n))):"YZX"===i?(this.z=Math.asin(r(h,-1,1)),Math.abs(h)<.99999?(this.x=Math.atan2(-u,n),this.y=Math.atan2(-l,s)):(this.x=0,this.y=Math.atan2(a,M))):"XZY"===i?(this.z=Math.asin(-r(o,-1,1)),Math.abs(o)<.99999?(this.x=Math.atan2(c,n),this.y=Math.atan2(a,s)):(this.x=Math.atan2(-u,M),this.y=0)):console.warn("setFromRotationMatrix() given unsupported order: "+i),this.order=i,this}},LDS=function(){var t=[2,3,5,7,11,13,17,19,23,29,31,37,41,43,57];return{halton:function(i,e){return function(t,i){var e,r,s;for(e=r=1/t,s=0;i>0;)s+=e*(i%t),e*=r,i=Math.floor(i/t);return s}(function(i){if(i<0||i>t.length)throw new Error("nthPrimeNumber index out of range");return t[i]}(i),e)}}}(),YFM.Math.Line=function(){var t=function(t,i){var e=[];return e.push(t[0]),e.push(t[1]),e.push(t[2]),e.push(1),e.push(i[0]),e.push(i[1]),e.push(i[2]),e.push(0),e},i=function(t,i){return YFM.Math.Vector.pos(t[0]+t[4]*i,t[1]+t[5]*i,t[2]+t[6]*i)},e=function(t,i,e,r){var s,o,a,h,n,u;return o=YFM.Math.Vector.pos(i,e,r),a=YFM.Math.Vector.sub(o,t),s=YFM.Math.Vector.vec(t[4],t[5],t[6]),n=YFM.Math.Vector.dot3(a,s),n*=n,h=YFM.Math.Vector.norm3SQ(a),u=YFM.Math.Vector.norm3SQ(s),h-n/u},r=function(t,i,r,s){return Math.sqrt(e(t,i,r,s))},s=function(t,i){var e,r,s,o,a,h,n,u,l,c,M=[],g=[],d=[];return l=YFM.Math.Vector.vec(t[4],t[5],t[6]),c=YFM.Math.Vector.vec(i[4],i[5],i[6]),s=YFM.Math.Vector.dot3(l,c),h=YFM.Math.Vector.norm3SQ(l),n=YFM.Math.Vector.norm3SQ(c),r=s*s-h*n,0==(e=YFM.Math.floatEquals(r,0))&&(u=YFM.Math.Vector.sub(i,t),o=YFM.Math.Vector.dot3(u,l),a=YFM.Math.Vector.dot3(u,c),g.push(o),g.push(a),M.push(-YFM.Math.Vector.norm3SQ(c)),M.push(-s),M.push(s),M.push(YFM.Math.Vector.norm3SQ(l)),d.push(g[0]*M[0]+g[1]*M[2]),d.push(g[0]*M[1]+g[1]*M[3]),d[0]/=r,d[1]/=r),{parallel:e,t:d}};return{line:function(t,i,e,r,s,o){var a=[];return a.push(t),a.push(i),a.push(e),a.push(1),a.push(r),a.push(s),a.push(o),a.push(0),a},lineSV:t,linePP:function(t,i){var e=[];return e.push(t[0]),e.push(t[1]),e.push(t[2]),e.push(1),e.push(i[0]-t[0]),e.push(i[1]-t[1]),e.push(i[2]-t[2]),e.push(0),e},getPoint:i,projection:function(t,i){var e=YFM.Math.Vector.pos(t[0],t[1],t[2]),r=YFM.Math.Vector.vec(t[4],t[5],t[6]),s=YFM.Math.Vector.sub(i,e),o=YFM.Math.Vector.dot3(s,r)/YFM.Math.Vector.dot3(r,r);return o<=0?e:o>=1?YFM.Math.Vector.add(e,r):YFM.Math.Vector.pos(t[0]+t[4]*o,t[1]+t[5]*o,t[2]+t[6]*o)},distancePointSQ:e,distancePoint:r,distanceLinesRaw:s,distanceLines:function(t,e){var o,a,h,n;return(a=s(t,e)).parallel?o=r(t,e[0],e[1],e[2]):(h=i(t,a.t[0]),n=i(e,a.t[1]),o=YFM.Math.Vector.distance(h,n)),{parallel:void 0,distance:o}},transform:function(i,e){var r=YFM.Math.Vector.pos(i[0],i[1],i[2]),s=YFM.Math.Vector.vec(i[4],i[5],i[6]);return t(YFM.Math.Matrix.mul(e,r),YFM.Math.Matrix.mul(e,s))}}}(),YFM.Math.Matrix=function(){var t=function(){var t=[];return t.push(1),t.push(0),t.push(0),t.push(0),t.push(0),t.push(1),t.push(0),t.push(0),t.push(0),t.push(0),t.push(1),t.push(0),t.push(0),t.push(0),t.push(0),t.push(1),t},i=function(i,e,r,s,o){var a,h,n,u=t();if(a=o?i:YFM.Math.deg2Radian(i),h=Math.cos(a),n=Math.sin(a),u[3]=0,u[7]=0,u[11]=0,u[12]=0,u[13]=0,u[14]=0,u[15]=1,1==e&&0==r&&0==s)u[5]=h,u[10]=h,u[6]=n,u[9]=-n,u[1]=0,u[2]=0,u[4]=0,u[8]=0,u[0]=1;else if(0==e&&1==r&&0==s)u[0]=h,u[10]=h,u[8]=n,u[2]=-n,u[1]=0,u[4]=0,u[6]=0,u[9]=0,u[5]=1;else if(0==e&&0==r&&1==s)u[0]=h,u[5]=h,u[1]=n,u[4]=-n,u[2]=0,u[6]=0,u[8]=0,u[9]=0,u[10]=1;else{var l=Math.sqrt(e*e+r*r+s*s);if(1!=l){var c=1/l;e*=c,r*=c,s*=c}var M=1-h,g=e*r,d=r*s,p=s*e,f=e*n,m=r*n,v=s*n;u[0]=e*e*M+h,u[4]=g*M-v,u[8]=p*M+m,u[1]=g*M+v,u[5]=r*r*M+h,u[9]=d*M-f,u[2]=p*M-m,u[6]=d*M+f,u[10]=s*s*M+h}return u},e=function(t,i,e,r){var s,o,a,h=[];return s=r?t:YFM.Math.deg2Radian(t),o=Math.cos(s),a=Math.sin(s),h.push(o),h.push(a),h.push(0),h.push(0),h.push(-a),h.push(o),h.push(0),h.push(0),h.push(0),h.push(0),h.push(1),h.push(0),h.push(i*(1-o)+e*a),h.push(e*(1-o)-i*a),h.push(0),h.push(1),h},r=function(t,i,e){var r=[];return r.push(1),r.push(0),r.push(0),r.push(0),r.push(0),r.push(1),r.push(0),r.push(0),r.push(0),r.push(0),r.push(1),r.push(0),r.push(t),r.push(i),r.push(e),r.push(1),r},s=function(t,i,e,r){var s=[];return s.push(t),s.push(0),s.push(0),s.push(0),s.push(0),s.push(t),s.push(0),s.push(0),s.push(0),s.push(0),s.push(t),s.push(0),s.push(i*(1-t)),s.push(e*(1-t)),s.push(r*(1-t)),s.push(1),s},o=function(t,i){var e,r,s,o,a,h,n,u=[];for(h=t.slice(0),n=i.slice(0),a=0;a<4;a++)e=n[4*a+0],r=n[4*a+1],s=n[4*a+2],o=n[4*a+3],u.push(e*h[0]+r*h[4]+s*h[8]+o*h[12]),u.push(e*h[1]+r*h[5]+s*h[9]+o*h[13]),u.push(e*h[2]+r*h[6]+s*h[10]+o*h[14]),u.push(e*h[3]+r*h[7]+s*h[11]+o*h[15]);return u};return{mat:t,matClone:function(t){return t.slice(0)},rotate3d:i,rotateXY:e,translate:r,rotateAxis:function(t,i,e){var r,s,o,a,h,n,u,l=[];return r=e?t:YFM.Math.deg2Radian(t),s=Math.cos(r),o=Math.sin(r),a=1-s,l.push(NaN*a+s),l.push(NaN*a+u*o),l.push(NaN*a-n*o),l.push(0),l.push(NaN*a-u*o),l.push(NaN*a+s),l.push(NaN*a+h*o),l.push(0),l.push(NaN*a+n*o),l.push(NaN*a-h*o),l.push(NaN*a+s),l.push(0),l.push(0),l.push(0),l.push(0),l.push(1),l},scale:s,scaleXYZ:function(t,i,e,r){var s=[];return s.push(t[0]),s.push(0),s.push(0),s.push(0),s.push(0),s.push(t[1]),s.push(0),s.push(0),s.push(0),s.push(0),s.push(t[2]),s.push(0),s.push(i*(1-t[0])),s.push(e*(1-t[1])),s.push(r*(1-t[2])),s.push(1),s},mul:o,mulVec:function(t,i){var e,r,s,o,a=[];return e=i[0],r=i[1],s=i[2],o=i[3],a.push(e*t[0]+r*t[4]+s*t[8]+o*t[12]),a.push(e*t[1]+r*t[5]+s*t[9]+o*t[13]),a.push(e*t[2]+r*t[6]+s*t[10]+o*t[14]),a.push(e*t[3]+r*t[7]+s*t[11]+o*t[15]),a},mulVecTo:function(t,i,e){e[0]=i[0]*t[0]+i[1]*t[4]+i[2]*t[8]+i[3]*t[12],e[1]=i[0]*t[1]+i[1]*t[5]+i[2]*t[9]+i[3]*t[13],e[2]=i[0]*t[2]+i[1]*t[6]+i[2]*t[10]+i[3]*t[14],e[3]=i[0]*t[3]+i[1]*t[7]+i[2]*t[11]+i[3]*t[15]},postTranslate:function(t,i,e,s){var a=r(i,e,s);return o(a,t)},postRotateXY:function(t,i,r,s,a){var h=e(i,r,s,a);return o(h,t)},postRotate3d:function(t,e,r,s,a,h){var n=i(e,r,s,a,h);return o(n,t)},postScale:function(t,i,e,r,a){var h=s(i,e,r,a);return o(h,t)},preTranslate:function(t,i,e,s){var a=r(i,e,s);return o(t,a)},preRotateXY:function(t,i,r,s,a){var h=e(i,r,s,a);return o(t,h)},preRotate3d:function(t,e,r,s,a,h){var n=i(e,r,s,a,h);return o(t,n)},preScale:function(t,i,e,r,a){var h=s(i,e,r,a);return o(t,h)},transpose:function(t){var i=[];return i.push(t[0]),i.push(t[4]),i.push(t[8]),i.push(t[12]),i.push(t[1]),i.push(t[5]),i.push(t[9]),i.push(t[13]),i.push(t[2]),i.push(t[6]),i.push(t[10]),i.push(t[14]),i.push(t[3]),i.push(t[7]),i.push(t[11]),i.push(t[15]),i},invert:function(t){var i=t[0],e=t[1],r=t[2],s=t[3],o=t[4],a=t[5],h=t[6],n=t[7],u=t[8],l=t[9],c=t[10],M=t[11],g=t[12],d=t[13],p=t[14],f=t[15],m=i*a-e*o,v=i*h-r*o,F=i*n-s*o,x=e*h-r*a,_=e*n-s*a,Y=r*n-s*h,R=u*d-l*g,y=u*p-c*g,T=u*f-M*g,A=l*p-c*d,b=l*f-M*d,P=c*f-M*p,V=m*P-v*b+F*A+x*T-_*y+Y*R;if(0!=V){var L=[];return L.push((a*P-h*b+n*A)/V),L.push((r*b-e*P-s*A)/V),L.push((d*Y-p*_+f*x)/V),L.push((c*_-l*Y-M*x)/V),L.push((h*T-o*P-n*y)/V),L.push((i*P-r*T+s*y)/V),L.push((p*F-g*Y-f*v)/V),L.push((u*Y-c*F+M*v)/V),L.push((o*b-a*T+n*R)/V),L.push((e*T-i*b-s*R)/V),L.push((g*_-d*F+f*m)/V),L.push((l*F-u*_-M*m)/V),L.push((a*y-o*A-h*R)/V),L.push((i*A-e*y+r*R)/V),L.push((d*v-g*x-p*m)/V),L.push((u*x-l*v+c*m)/V),L}return null},orthographic:function(i,e,r,s,o,a){var h=t(),n=1/(e-i),u=1/(s-r),l=1/(a-o),c=2*n,M=2*u,g=-2*l,d=-(e+i)*n,p=-(s+r)*u,f=-(a+o)*l;return h[0]=c,h[5]=M,h[10]=g,h[12]=d,h[13]=p,h[14]=f,h[15]=1,h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[6]=0,h[7]=0,h[8]=0,h[9]=0,h[11]=0,h},perspective:function(t,i,e,r){var s=[],o=1/Math.tan(t*(Math.PI/360)),a=1/(e-r);return s.push(o/i),s.push(0),s.push(0),s.push(0),s.push(0),s.push(o),s.push(0),s.push(0),s.push(0),s.push(0),s.push((r+e)*a),s.push(-1),s.push(0),s.push(0),s.push(2*r*e*a),s.push(0),s},setTranslateZ:function(t,i){t[14]=i},covariance3x3:function(t){var i,e,r,s,o,a,h,n,u,l,c,M,g,d,p=[];for(n=t.length,s=0,o=0,a=0,h=0;h<n;h++)s+=t[h][0],o+=t[h][1],a+=t[h][2];for(s/=n,o/=n,a/=n,u=0,l=0,c=0,M=0,g=0,d=0,h=0;h<n;h++)u+=((i=t[h][0])-s)*(i-s),l+=((e=t[h][1])-o)*(e-o),c+=((r=t[h][2])-a)*(r-a),M+=(i-s)*(e-o),g+=(i-s)*(r-a),d+=(e-o)*(r-a);return u/=n,l/=n,c/=n,M/=n,g/=n,d/=n,p.push(u),p.push(M),p.push(g),p.push(M),p.push(l),p.push(d),p.push(g),p.push(d),p.push(c),p},eig3x3:function(t){var i,e,r,s=[],o=[];if(t[3]!=t[1]||t[6]!=t[2]||t[7]!=t[5])throw new Error("matrix is not symmetric");return(i=[]).push(new Array(t[0],t[3],t[6])),i.push(new Array(t[1],t[4],t[7])),i.push(new Array(t[2],t[5],t[8])),e=new Array(0,0,0),r=new Array(0,0,0),function(t,i,e,r){var s,o,a;for(o=0;o<t;o++)i[o]=r[t-1][o];for(s=t-1;s>0;s--){var h=0,n=0;for(a=0;a<s;a++)h+=Math.abs(i[a]);if(0==h)for(e[s]=i[s-1],o=0;o<s;o++)i[o]=r[s-1][o],r[s][o]=0,r[o][s]=0;else{for(a=0;a<s;a++)i[a]/=h,n+=i[a]*i[a];var u=i[s-1],l=Math.sqrt(n);for(u>0&&(l=-l),e[s]=h*l,n-=u*l,i[s-1]=u-l,o=0;o<s;o++)e[o]=0;for(o=0;o<s;o++){for(u=i[o],r[o][s]=u,l=e[o]+r[o][o]*u,a=o+1;a<=s-1;a++)l+=r[a][o]*i[a],e[a]+=r[a][o]*u;e[o]=l}for(u=0,o=0;o<s;o++)e[o]/=n,u+=e[o]*i[o];var c=u/(n+n);for(o=0;o<s;o++)e[o]-=c*i[o];for(o=0;o<s;o++){for(u=i[o],l=e[o],a=o;a<=s-1;a++)r[a][o]-=u*e[a]+l*i[a];i[o]=r[s-1][o],r[s][o]=0}}i[s]=n}for(s=0;s<t-1;s++){if(r[t-1][s]=r[s][s],r[s][s]=1,0!=(n=i[s+1])){for(a=0;a<=s;a++)i[a]=r[a][s+1]/n;for(o=0;o<=s;o++){for(l=0,a=0;a<=s;a++)l+=r[a][s+1]*r[a][o];for(a=0;a<=s;a++)r[a][o]-=l*i[a]}}for(a=0;a<=s;a++)r[a][s+1]=0}for(o=0;o<t;o++)i[o]=r[t-1][o],r[t-1][o]=0;r[t-1][t-1]=1,e[0]=0}(3,e,r,i),function(t,i,e,r){var s,o,a,h,n,u;for(s=1;s<t;s++)e[s-1]=e[s];e[t-1]=0;var l=0,c=0,M=Math.pow(2,-52);for(h=0;h<t;h++){for(c=Math.max(c,Math.abs(i[h])+Math.abs(e[h])),n=h;n<t&&!(Math.abs(e[n])<=M*c);)n++;if(n>h){u=0;do{if((u+=1)>=7)break;var g=i[h],d=(i[h+1]-g)/(2*e[h]),p=Math.hypot(d,1);d<0&&(p=-p),i[h]=e[h]/(d+p),i[h+1]=e[h]*(d+p);var f=i[h+1],m=g-i[h];for(s=h+2;s<t;s++)i[s]-=m;l+=m,d=i[n];var v=1,F=v,x=v,_=e[h+1],Y=0,R=0;for(s=n-1;s>=h;s--)for(x=F,F=v,R=Y,g=v*e[s],m=v*d,p=Math.hypot(d,e[s]),e[s+1]=Y*p,Y=e[s]/p,d=(v=d/p)*i[s]-Y*g,i[s+1]=m+Y*(v*g+Y*i[s]),a=0;a<t;a++)m=r[a][s+1],r[a][s+1]=Y*r[a][s]+v*m,r[a][s]=v*r[a][s]-Y*m;d=-Y*R*x*_*e[h]/f,e[h]=Y*d,i[h]=v*d}while(Math.abs(e[h])>M*c)}i[h]=i[h]+l,e[h]=0}for(s=0;s<t-1;s++){for(a=s,d=i[s],o=s+1;o<t;o++)i[o]<d&&(a=o,d=i[o]);if(a!=s)for(i[a]=i[s],i[s]=d,o=0;o<t;o++)d=r[o][s],r[o][s]=r[o][a],r[o][a]=d}}(3,e,r,i),s.push(e[0]),s.push(e[1]),s.push(e[2]),o.push(i[0][0]),o.push(i[1][0]),o.push(i[2][0]),o.push(i[0][1]),o.push(i[1][1]),o.push(i[2][1]),o.push(i[0][2]),o.push(i[1][2]),o.push(i[2][2]),{value:s,vec:o}},eulerParamExtract:function(t){var i,e,r;return i=Math.atan2(-t[2],t[10]),e=Math.asin(t[6]),r=Math.atan2(-t[4],t[5]),new Euler(e,i,r)},eulerParamExtractX:function(t){return Math.asin(t[6])},eulerParamExtractY:function(t){return Math.atan2(-t[2],t[10])},eulerParamExtractZ:function(t){return Math.atan2(-t[4],t[5])},rotationFromQuaternion:function(i){var e=t(),r=i.x,s=i.y,o=i.z,a=i.w,h=r+r,n=s+s,u=o+o,l=r*h,c=r*n,M=r*u,g=s*n,d=s*u,p=o*u,f=a*h,m=a*n,v=a*u;return e[0]=1-(g+p),e[1]=c-v,e[2]=M+m,e[3]=0,e[4]=c+v,e[5]=1-(l+p),e[6]=d-f,e[7]=0,e[8]=M-m,e[9]=d+f,e[10]=1-(l+g),e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}}}(),YFM.Math.Plane=function(){var t=function(t,i,e,r,s,o){var a=YFM.Math.Vector.pos(t,i,e),h=YFM.Math.Vector.normalize(YFM.Math.Vector.vec(r,s,o)),n=-YFM.Math.Vector.dot3(h,a);return h[3]=n,h};return{plane:t,planePN:function(i,e){return t(i[0],i[1],i[2],e[0],e[1],e[2])},planeRaw:function(t,i,e,r){return YFM.Math.Vector.vec(t,i,e,r)},transform:function(t,i){var e,r=YFM.Math.Matrix.invert(i);if(null==r)throw new Error("transform a plane with a singular matrix");return e=YFM.Math.Matrix.transpose(r),YFM.Math.Matrix.mulVec(e,t)},distance:function(t,i,e,r){var s=YFM.Math.Vector.pos(i,e,r);return YFM.Math.Vector.dot4(t,s)},intersectionLine:function(t,i){var e,r,s=YFM.Math.Vector.pos(i[0],i[1],i[2]),o=YFM.Math.Vector.vec(i[4],i[5],i[6]);if(e=YFM.Math.Vector.dot4(t,s),r=YFM.Math.Vector.dot4(t,o),YFM.Math.floatEquals(r,0))throw new Error("Calc intersection of a line parallel to a plane");return-e/r},intersectionPlane:function(t,i){var e,r,s,o,a;if(o=YFM.Math.Vector.cross(t,i),e=Math.floatEquals(0,YFM.Math.Vector.norm3(o)))return{parallel:e};if((r=[]).push(t[0]),r.push(i[0]),r.push(o[0]),r.push(0),r.push(t[1]),r.push(i[1]),r.push(o[1]),r.push(0),r.push(t[2]),r.push(i[2]),r.push(o[2]),r.push(0),r.push(0),r.push(0),r.push(0),r.push(1),null==(s=YFM.Math.Matrix.invert(r)))throw new Error("nv matrix is singular");return a=YFM.Math.Matrix.mulVec(s,YFM.Math.Vector.pos(-t[3],-i[3],0)),{parallel:e,line:YFM.Math.Line.lineSV(a,o)}},intersectionTriplePlane:function(t,i,e){var r,s,o;return(r=[]).push(t[0]),r.push(i[0]),r.push(e[0]),r.push(0),r.push(t[1]),r.push(i[1]),r.push(e[1]),r.push(0),r.push(t[2]),r.push(i[2]),r.push(e[2]),r.push(0),r.push(0),r.push(0),r.push(0),r.push(1),null==(s=YFM.Math.Matrix.invert(r))?{atAPoint:!1}:(o=YFM.Math.Matrix.mulVec(s,YFM.Math.Vector.pos(-t[3],-i[3],-e[3])),{atAPoint:!0,point:o})}}}(),Quaternion.prototype={constructor:Quaternion,toString:function(t){var i="(";return i=i+this.x.toFixed(t)+", ",i=i+this.y.toFixed(t)+", ",i=i+this.z.toFixed(t)+", ",i=i+this.w.toFixed(t)+")"},clone:function(){return new this.constructor(this.x,this.y,this.z,this.w)},copy:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this},setFromEuler:function(t){var i=t.x,e=t.y,r=t.z,s=t.order,o=Math.cos,a=Math.sin,h=o(i/2),n=o(e/2),u=o(r/2),l=a(i/2),c=a(e/2),M=a(r/2);return"XYZ"===s?(this.x=l*n*u+h*c*M,this.y=h*c*u-l*n*M,this.z=h*n*M+l*c*u,this.w=h*n*u-l*c*M):"YXZ"===s?(this.x=l*n*u+h*c*M,this.y=h*c*u-l*n*M,this.z=h*n*M-l*c*u,this.w=h*n*u+l*c*M):"ZXY"===s?(this.x=l*n*u-h*c*M,this.y=h*c*u+l*n*M,this.z=h*n*M+l*c*u,this.w=h*n*u-l*c*M):"ZYX"===s?(this.x=l*n*u-h*c*M,this.y=h*c*u+l*n*M,this.z=h*n*M-l*c*u,this.w=h*n*u+l*c*M):"YZX"===s?(this.x=l*n*u+h*c*M,this.y=h*c*u+l*n*M,this.z=h*n*M-l*c*u,this.w=h*n*u-l*c*M):"XZY"===s&&(this.x=l*n*u-h*c*M,this.y=h*c*u-l*n*M,this.z=h*n*M+l*c*u,this.w=h*n*u+l*c*M),this},setFromAxisAngle:function(t,i){var e=i/2,r=Math.sin(e);return this.x=t[0]*r,this.y=t[1]*r,this.z=t[2]*r,this.w=Math.cos(e),this},setFromRotationMatrix:function(t){var i,e=t[0],r=t[4],s=t[8],o=t[1],a=t[5],h=t[9],n=t[2],u=t[6],l=t[10],c=e+a+l;return c>0?(i=.5/Math.sqrt(c+1),this.w=.25/i,this.x=(u-h)*i,this.y=(s-n)*i,this.z=(o-r)*i):e>a&&e>l?(i=2*Math.sqrt(1+e-a-l),this.w=(u-h)/i,this.x=.25*i,this.y=(r+o)/i,this.z=(s+n)/i):a>l?(i=2*Math.sqrt(1+a-e-l),this.w=(s-n)/i,this.x=(r+o)/i,this.y=.25*i,this.z=(h+u)/i):(i=2*Math.sqrt(1+l-e-a),this.w=(o-r)/i,this.x=(s+n)/i,this.y=(h+u)/i,this.z=.25*i),this},inverse:function(){return this.conjugate().normalize()},conjugate:function(){return this.x*=-1,this.y*=-1,this.z*=-1,this},dot:function(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},normalize:function(){var t=this.length();return 0===t?(this.x=0,this.y=0,this.z=0,this.w=1):(t=1/t,this.x=this.x*t,this.y=this.y*t,this.z=this.z*t,this.w=this.w*t),this},multiply:function(t){return this.multiplyQuaternions(this,t)},premultiply:function(t){return this.multiplyQuaternions(t,this)},multiplyQuaternions:function(t,i){var e=t.x,r=t.y,s=t.z,o=t.w,a=i.x,h=i.y,n=i.z,u=i.w;return this.x=e*u+o*a+r*n-s*h,this.y=r*u+o*h+s*a-e*n,this.z=s*u+o*n+e*h-r*a,this.w=o*u-e*a-r*h-s*n,this},slerp:function(t,i){if(0===i)return this;if(1===i)return this.copy(t);var e=this.x,r=this.y,s=this.z,o=this.w,a=o*t.w+e*t.x+r*t.y+s*t.z;if(a<0?(this.w=-t.w,this.x=-t.x,this.y=-t.y,this.z=-t.z,a=-a):this.copy(t),a>=1)return this.w=o,this.x=e,this.y=r,this.z=s,this;var h=Math.sqrt(1-a*a);if(Math.abs(h)<.001)return this.w=.5*(o+this.w),this.x=.5*(e+this.x),this.y=.5*(r+this.y),this.z=.5*(s+this.z),this;var n=Math.atan2(h,a),u=Math.sin((1-i)*n)/h,l=Math.sin(i*n)/h;return this.w=o*u+this.w*l,this.x=e*u+this.x*l,this.y=r*u+this.y*l,this.z=s*u+this.z*l,this}},YFM.Math.Vector=function(){var t=function(t,i){var e=[];return e.push(t[0]-i[0]),e.push(t[1]-i[1]),e.push(t[2]-i[2]),e.push(t[3]-i[3]),e},i=function(t,i){return t[0]*i[0]+t[1]*i[1]+t[2]*i[2]},e=function(t,i){return t[0]*i[0]+t[1]*i[1]+t[2]*i[2]+t[3]*i[3]};return{pos:function(){var t=YFM.Math.argumentsToArray(arguments);switch(t.length){case 0:t.push(0);case 1:t.push(0);case 2:t.push(0);case 3:t.push(1)}return t.splice(0,4)},vec:function(){var t=YFM.Math.argumentsToArray(arguments);switch(t.length){case 0:t.push(0);case 1:t.push(0);case 2:t.push(0);case 3:t.push(0)}return t.splice(0,4)},vecClone:function(t){return t.slice(0)},add:function(t,i){var e=[];return e.push(t[0]+i[0]),e.push(t[1]+i[1]),e.push(t[2]+i[2]),e.push(t[3]+i[3]),e},addTo:function(t,i,e){t[0]=i[0]+e[0],t[1]=i[1]+e[1],t[2]=i[2]+e[2],t[3]=i[3]+e[3]},sub:t,subTo:function(t,i,e){t[0]=i[0]-e[0],t[1]=i[1]-e[1],t[2]=i[2]-e[2],t[3]=i[3]-e[3]},scale:function(t,i){var e=[];return e.push(i*t[0]),e.push(i*t[1]),e.push(i*t[2]),e.push(i*t[3]),e},scaleTo:function(t,i){t[0]*=i,t[1]*=i,t[2]*=i,t[3]*=i},dot3:i,dot4:e,cross:function(t,i){var e=[];return e.push(-i[1]*t[2]+i[2]*t[1]),e.push(i[0]*t[2]-i[2]*t[0]),e.push(-i[0]*t[1]+i[1]*t[0]),e.push(0),e},norm3:function(t){return Math.sqrt(i(t,t))},norm4:function(t){return Math.sqrt(e(t,t))},norm3SQ:function(t){return i(t,t)},norm4SQ:function(t){return e(t,t)},normalize:function(t){var i=[],e=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);return e>0?(i.push(t[0]/e),i.push(t[1]/e),i.push(t[2]/e),i.push(t[3])):(i.push(0),i.push(0),i.push(0),i.push(t[3])),i},normalizeTo:function(t){var i=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);i>0?(t[0]=t[0]/i,t[1]=t[1]/i,t[2]=t[2]/i):(t[0]=0,t[1]=0,t[2]=0)},limitTo:function(t,e){var r=i(t,t);if(r>e*e){var s=Math.sqrt(r);t[0]/=s,t[1]/=s,t[2]/=s,t[0]*=e,t[1]*=e,t[2]*=e}},limitToRange:function(t,e,r){var s,o=i(t,t);o>r*r?(s=Math.sqrt(o),t[0]/=s,t[1]/=s,t[2]/=s,t[0]*=r,t[1]*=r,t[2]*=r):o<e*e&&(s=Math.sqrt(o),t[0]/=s,t[1]/=s,t[2]/=s,t[0]*=r,t[1]*=r,t[2]*=r)},mix:function(t,i,e){var r=[];return r.push((1-e)*t[0]+e*i[0]),r.push((1-e)*t[1]+e*i[1]),r.push((1-e)*t[2]+e*i[2]),r.push((1-e)*t[3]+e*i[3]),r},mid:function(t,i){var e=[];return e.push((t[0]+i[0])/2),e.push((t[1]+i[1])/2),e.push((t[2]+i[2])/2),e.push(1),e},midTo:function(t,i,e){t[0]=(i[0]+e[0])/2,t[1]=(i[1]+e[1])/2,t[2]=(i[2]+e[2])/2,t[3]=1},distanceSQ:function(e,r){var s=t(r,e);return i(s,s)},distance:function(e,r){var s=t(r,e);return Math.sqrt(i(s,s))}}}(),PlanePolygon.prototype={constructor:PlanePolygon,intersectionLine:function(t,i){var e,r,s,o,a,h,n;do{if(o=0,(a=YFM.Math.Plane.intersectionLine(this.plane,t))<0){o=1024;break}for(h=YFM.Math.Line.getPoint(t,a),n=YFM.Math.Matrix.invert(i),h=YFM.Math.Matrix.mulVec(n,h),e=this.barrier.length,r=0;r<e;r++)(s=YFM.Math.Plane.distance(this.barrier[r],h[0],h[1],h[2]))<o&&(o=s)}while(!1);return o},_makePlanePts:function(t){var i,e,r,s,o,a;if((a=t.length)<3)throw new Error("polygon pts count < 3");o=0;do{if(e=YFM.Math.Vector.sub(t[(o+1)%a],t[o%a]),s=YFM.Math.Vector.sub(t[(o+2)%a],t[(o+1)%a]),i=YFM.Math.Vector.cross(e,s),!YFM.Math.floatEquals(YFM.Math.Vector.norm3SQ(i),0))break;o++}while(o<a);if(YFM.Math.floatEquals(YFM.Math.Vector.norm3SQ(i),0))throw new Error("polygon degenerate");i=YFM.Math.Vector.normalize(i),o=0;do{e=YFM.Math.Vector.sub(t[(o+1)%a],t[o%a]),r=YFM.Math.Vector.cross(i,e),r=YFM.Math.Vector.normalize(r),this.barrier.push(YFM.Math.Plane.planePN(t[o],r)),o++}while(o<a);return YFM.Math.Plane.planePN(t[0],i)}},Mover.prototype={constructor:Mover,DEFAULT_MASS:1,DEFAULT_MAX_FORCE:4,DEFAULT_MAX_SPEED:4,setMass:function(t){this.mass=t},setMaxForce:function(t){this.maxForce=t},setMaxSpeed:function(t){this.maxSpeed=t},setLocation:function(t,i,e){this.location[0]=t,this.location[1]=i,this.location[2]=e},getLocation:function(){return this.location},update:function(){YFM.Math.Vector.addTo(this.velocity,this.velocity,this.acceleration),YFM.Math.Vector.limitTo(this.velocity,this.maxSpeed),YFM.Math.Vector.addTo(this.location,this.location,this.velocity),this.acceleration[0]=0,this.acceleration[1]=0,this.acceleration[2]=0},applyForce:function(t){var i=YFM.Math.Vector.scale(t,1/this.mass);YFM.Math.Vector.addTo(this.acceleration,this.acceleration,i)},seek:function(t){var i,e;i=YFM.Math.Vector.normalize(YFM.Math.Vector.sub(t,this.location)),YFM.Math.Vector.scaleTo(this.maxSpeed),e=YFM.Math.Vector.limitTo(YFM.Math.Vector.sub(i,this.velocity),this.maxForce),this.applyForce(e)},flee:function(t){var i,e;i=YFM.Math.Vector.normalize(YFM.Math.Vector.sub(t,this.location)),YFM.Math.Vector.scaleTo(-this.maxSpeed),e=YFM.Math.Vector.limitTo(YFM.Math.Vector.sub(i,this.velocity),this.maxForce),this.applyForce(e)},arrive:function(t,i){var e,r,s,o;return e=YFM.Math.Vector.sub(t,this.location),(s=YFM.Math.Vector.norm3(e))<=i||(e=YFM.Math.Vector.normalize(e),s<100?(o=YFM.Math.map(s,0,100,0,this.maxSpeed),YFM.Math.Vector.scaleTo(e,o)):YFM.Math.Vector.scaleTo(e,this.maxSpeed),r=YFM.Math.Vector.sub(e,this.velocity),YFM.Math.Vector.limitTo(r,this.maxForce),this.applyForce(r),!1)}},FloorQuadTree.prototype={constructor:FloorQuadTree,cursor:0,shift:1e4,removeObject:function(t){var i=this.objMap[t.toString()];if(i){for(var e,r=i.node,s=[],o=0,a=r.objectList.length;o<a;o++)i!==(e=r.objectList[o])&&s.push(e);r.objectList=s,r.objectList.length<=0&&r.shrink()}return i},insertObject:function(t,i,e,r,s){var o=FloorQuadTree.prototype.cursor*FloorQuadTree.prototype.shift+this.floor.index;FloorQuadTree.prototype.cursor+=1;var a=this.floor.floorPos2Region(e,r);a[2]+=s;var h={id:o,obj:t,pos:a,floor:i,x:e,y:r,z:s};return this.objMap[o.toString()]=h,this.root.insertObject(h),o},insertObjectOBB:function(t,i){var e=FloorQuadTree.prototype.cursor*FloorQuadTree.prototype.shift+this.floor.index;FloorQuadTree.prototype.cursor+=1;var r={id:e,obj:t,pos:i};return this.objMap[e.toString()]=r,this.root.insertObject(r),e},insertObjectOBBCenter:function(t,i,e){var r=FloorQuadTree.prototype.cursor*FloorQuadTree.prototype.shift+this.floor.index,s=this.floor.floorPos2Region(e[0],e[1]);FloorQuadTree.prototype.cursor+=1;var o={id:r,obj:t,pos:i,center:s};return this.objMap[r.toString()]=o,this.root.insertObject(o),r},frustumCheck:function(t){return this.root.frustumCheck(t)},rayCheck:function(t,i,e){var r=[];return this.root.rayCheck(t,i*i,r,e),r},rayCheckOBB:function(t,i,e){var i=[],r=YFM.Math.Line.transform(t,YFM.Math.Matrix.invert(this.floor.floorMat));return this.root.rayCheckOBB(t,r,i,e),i},render:function(t,i,e,r){this.root.renderCheck(t,i,e,r)},getContainLevel:function(t){var i;return null!=(i=this.root.containCheck(t))?i.level:1024}},FloorQuadNode.prototype={constructor:FloorQuadNode,shrink:function(){this.isNodeEmpty()&&(this.children[0]=null,this.children[1]=null,this.children[2]=null,this.children[3]=null,this.splited=!1,null!==this.parentNode&&this.parentNode.shrink())},isNodeEmpty:function(){return!(this.objectList.length>0)&&(!(null!==this.children[0]&&!this.children[0].isNodeEmpty())&&(!(null!==this.children[1]&&!this.children[1].isNodeEmpty())&&(!(null!==this.children[2]&&!this.children[2].isNodeEmpty())&&!(null!==this.children[3]&&!this.children[3].isNodeEmpty()))))},rayCheckOBB:function(t,e,r,s){if(this.obb.lineCheck(t)){var o,a=this.objectList.length;for(i=0;i<a;i++)if((o=this.objectList[i].pos).isOBB&&o.lineCheck(t)&&(r.push(this.objectList[i]),s))return!0;if(null!==this.children[0]&&this.children[0].rayCheckOBB(t,e,r,s))return!0;if(null!==this.children[1]&&this.children[1].rayCheckOBB(t,e,r,s))return!0;if(null!==this.children[2]&&this.children[2].rayCheckOBB(t,e,r,s))return!0;if(null!==this.children[3]&&this.children[3].rayCheckOBB(t,e,r,s))return!0}return!1},rayCheck:function(t,e,r,s){if(this.obb.lineCheck(t)){var o,a,h=this.objectList.length;for(i=0;i<h;i++)if(a=this.objectList[i].pos,o=YFM.Math.Line.distancePointSQ(t,a[0],a[1],a[2]),0===e){if(o<=this.objectList[i].radiusSQ&&(r.push(this.objectList[i]),s))return!0}else if(o<=e&&(r.push(this.objectList[i]),s))return!0;if(null!==this.children[0]&&this.children[0].rayCheck(t,e,r,s))return!0;if(null!==this.children[1]&&this.children[1].rayCheck(t,e,r,s))return!0;if(null!==this.children[2]&&this.children[2].rayCheck(t,e,r,s))return!0;if(null!==this.children[3]&&this.children[3].rayCheck(t,e,r,s))return!0}return!1},containCheck:function(t){var e=this.obb.frustumCheck(t);if(-1==e)return null;if(1==e)return this;if(0==e&&null!==this.children[0]){var r=[];r.push(this.children[0].containCheck(t)),r.push(this.children[1].containCheck(t)),r.push(this.children[2].containCheck(t)),r.push(this.children[3].containCheck(t));var s=1024,o=null;for(i=0;i<4;i++)null!==r[i]&&r[i].level<s&&(o=r[i],s=r[i].level);return o}return null},renderEver:function(t,i,e){var r,s;if(0!=(s=this.level>e+1?0:this.level>e?1:1024)){for(r=0;r<4;r++)null!==this.children[r]&&this.children[r].renderEver(t,i,e);for(s>this.objectList.length&&(s=this.objectList.length),r=0;r<s;r++)t(this.objectList[r],i)}},renderCheck:function(t,i,e,r){var s,o;if(0!=(o=this.level>r+1?0:this.level>r?1:1024)){var a=this.obb.frustumCheck(t);if(-1!=a){if(1==a)for(s=0;s<4;s++)null!==this.children[s]&&this.children[s].renderEver(i,e,r);else if(0==a&&this.level<=r)for(s=0;s<4;s++)null!==this.children[s]&&this.children[s].renderCheck(t,i,e,r);for(o>this.objectList.length&&(o=this.objectList.length),s=0;s<o;s++)t.containCheckPoint(this.objectList[s].pos)&&i(this.objectList[s],e)}}},insertObject:function(t){!this.splited&&this.objectList.length<this.THRESHOLD?this._insert2ObjList(t):(this.splited||this._spliteSpace(),this._insertToSubSpace(t))},frustumCheck:function(t){return this.obb.frustumCheck(t)},_insert2ObjList:function(t){t.node=this,this.objectList.push(t)},_spliteSpace:function(){var t,i,e;if(this.splited=!0,!(this.level>=6)){for(this.children[this.NODE_0]=new FloorQuadNode(this,this.floor,this.xmin,(this.xmin+this.xmax)/2,this.ymin,(this.ymin+this.ymax)/2,this.height,this.mask+"0",this.level+1),this.children[this.NODE_1]=new FloorQuadNode(this,this.floor,(this.xmin+this.xmax)/2,this.xmax,this.ymin,(this.ymin+this.ymax)/2,this.height,this.mask+"1",this.level+1),this.children[this.NODE_2]=new FloorQuadNode(this,this.floor,(this.xmin+this.xmax)/2,this.xmax,(this.ymin+this.ymax)/2,this.ymax,this.height,this.mask+"2",this.level+1),this.children[this.NODE_3]=new FloorQuadNode(this,this.floor,this.xmin,(this.xmin+this.xmax)/2,(this.ymin+this.ymax)/2,this.ymax,this.height,this.mask+"3",this.level+1),e=[];this.objectList.length>0;){t=this.objectList.pop();var r=[];for(r.push(this.children[0].obb.pointCheck(t.pos)),r.push(this.children[1].obb.pointCheck(t.pos)),r.push(this.children[2].obb.pointCheck(t.pos)),r.push(this.children[3].obb.pointCheck(t.pos)),i=0;i<4;i++)if(1==r[i]){this.children[i].insertObject(t);break}4==i&&e.push(t)}this.objectList=e}},_insertToSubSpace:function(t){var i=[];if(null!==this.children[0]){i.push(this.children[0].obb.pointCheck(t.pos)),i.push(this.children[1].obb.pointCheck(t.pos)),i.push(this.children[2].obb.pointCheck(t.pos)),i.push(this.children[3].obb.pointCheck(t.pos));for(var e=0;e<4;e++)if(1==i[e])return void this.children[e].insertObject(t)}this._insert2ObjList(t)},THRESHOLD:4,NODE_0:0,NODE_1:1,NODE_2:2,NODE_3:3,LEVEL_COLOR:new Array(YFM.Math.Vector.pos(1,0,0),YFM.Math.Vector.pos(1,.5,0),YFM.Math.Vector.pos(1,1,0),YFM.Math.Vector.pos(0,1,0),YFM.Math.Vector.pos(0,1,1),YFM.Math.Vector.pos(0,0,1),YFM.Math.Vector.pos(.5,0,1),YFM.Math.Vector.pos(0,0,0))},FrustumWorldSpace.prototype={constructor:FrustumWorldSpace,update:function(t){this.left[0]=t[3]+t[0],this.left[1]=t[7]+t[4],this.left[2]=t[11]+t[8],this.left[3]=t[15]+t[12],this.right[0]=t[3]-t[0],this.right[1]=t[7]-t[4],this.right[2]=t[11]-t[8],this.right[3]=t[15]-t[12],this.bottom[0]=t[3]+t[1],this.bottom[1]=t[7]+t[5],this.bottom[2]=t[11]+t[9],this.bottom[3]=t[15]+t[13],this.top[0]=t[3]-t[1],this.top[1]=t[7]-t[5],this.top[2]=t[11]-t[9],this.top[3]=t[15]-t[13],this.near[0]=t[3]+t[2],this.near[1]=t[7]+t[6],this.near[2]=t[11]+t[10],this.near[3]=t[15]+t[14],this.far[0]=t[3]-t[2],this.far[1]=t[7]-t[6],this.far[2]=t[11]-t[10],this.far[3]=t[15]-t[14]},containCheckPoint:function(t){if(t.isOBB)return-1!==t.frustumCheck(this);var i=!1;do{if(YFM.Math.Vector.dot4(this.near,t)<0)break;if(YFM.Math.Vector.dot4(this.far,t)<0)break;if(YFM.Math.Vector.dot4(this.left,t)<0)break;if(YFM.Math.Vector.dot4(this.right,t)<0)break;if(YFM.Math.Vector.dot4(this.bottom,t)<0)break;if(YFM.Math.Vector.dot4(this.top,t)<0)break;i=!0}while(!1);return i}},OBB.prototype={constructor:OBB,transform:function(t){var i=YFM.Math.Matrix,e=YFM.Math.Vector,r=YFM.Math.Matrix.invert(t),s=YFM.Math.Matrix.transpose(r);this.center=i.mulVec(t,this.center),this.r=this._reserse3(i.mulVec(t,this.r)),this.s=this._reserse3(i.mulVec(t,this.s)),this.t=this._reserse3(i.mulVec(t,this.t)),this.R=this._reserse3(i.mulVec(t,this.R)),this.S=this._reserse3(i.mulVec(t,this.S)),this.T=this._reserse3(i.mulVec(t,this.T)),this.r_max=i.mulVec(s,this.r_min),this.r_min=i.mulVec(s,this.r_max),this.s_max=i.mulVec(s,this.s_min),this.s_min=i.mulVec(s,this.s_max),this.t_max=i.mulVec(s,this.t_min),this.t_min=i.mulVec(s,this.t_max),this.r_half=this._reserse4(i.mulVec(s,this.r_half)),this.s_half=this._reserse4(i.mulVec(s,this.s_half)),this.t_half=this._reserse4(i.mulVec(s,this.t_half)),this.hr=e.norm3(this.R)/2,this.hs=e.norm3(this.S)/2,this.ht=e.norm3(this.T)/2},pointCheck:function(t){if(t.isOBB)return this.obbCheck(t);var i,e,r;i=0,e=0;do{if((r=YFM.Math.Plane.distance(this.r_min,t))<0){i++;break}if(r>0?e++:0,(r=YFM.Math.Plane.distance(this.r_max,t))<0){i++;break}if(r>0?e++:0,(r=YFM.Math.Plane.distance(this.s_min,t))<0){i++;break}if(r>0?e++:0,(r=YFM.Math.Plane.distance(this.s_max,t))<0){i++;break}if(r>0?e++:0,(r=YFM.Math.Plane.distance(this.t_min,t))<0){i++;break}if(r>0?e++:0,(r=YFM.Math.Plane.distance(this.t_max,t))<0){i++;break}r>0?e++:0,ret=!0}while(!1);return 6==e?1:i>0?-1:0},lineCheck:function(t){var i,e,r,s,o,a,h,n,u,l;if(s=Number.MAX_VALUE,o=-Number.MAX_VALUE,i=YFM.Math.Vector.pos(t[0],t[1],t[2]),e=YFM.Math.Vector.normalize(YFM.Math.Vector.vec(t[4],t[5],t[6])),r=YFM.Math.Vector.sub(this.center,i),n=YFM.Math.Vector.dot3(this.r,r),u=YFM.Math.Vector.dot3(this.r,e),YFM.Math.floatNotZero(u)){if(a=(n+this.hr)/u,h=(n-this.hr)/u,a>h&&(l=h,h=a,a=l),a>o&&(o=a),h<s&&(s=h),o>s)return!1;if(s<0)return!1}else if(-n-this.hr>0||-n+this.hr<0)return!1;if(n=YFM.Math.Vector.dot3(this.s,r),u=YFM.Math.Vector.dot3(this.s,e),YFM.Math.floatNotZero(u)){if(a=(n+this.hs)/u,h=(n-this.hs)/u,a>h&&(l=h,h=a,a=l),a>o&&(o=a),h<s&&(s=h),o>s)return!1;if(s<0)return!1}else if(-n-this.hs>0||-n+this.hs<0)return!1;if(n=YFM.Math.Vector.dot3(this.t,r),u=YFM.Math.Vector.dot3(this.t,e),YFM.Math.floatNotZero(u)){if(a=(n+this.ht)/u,h=(n-this.ht)/u,a>h&&(l=h,h=a,a=l),a>o&&(o=a),h<s&&(s=h),o>s)return!1;if(s<0)return!1}else if(-n-this.ht>0||-n+this.ht<0)return!1;return!0},obbCheck:function(t){var i,e,r,s;i=0,e=0;do{if(r=t.effectiveRadius(this.r_min),(s=YFM.Math.Plane.distance(this.r_min,t.center))<-r){i++;break}if(s>r?e++:0,r=t.effectiveRadius(this.r_max),(s=YFM.Math.Plane.distance(this.r_max,t.center))<-r){i++;break}if(s>r?e++:0,r=t.effectiveRadius(this.s_min),(s=YFM.Math.Plane.distance(this.s_min,t.center))<-r){i++;break}if(s>r?e++:0,r=t.effectiveRadius(this.s_max),(s=YFM.Math.Plane.distance(this.s_max,t.center))<-r?i++:s>r?e++:0,r=t.effectiveRadius(this.t_min),(s=YFM.Math.Plane.distance(this.t_min,t.center))<-r){i++;break}if(s>r?e++:0,r=t.effectiveRadius(this.t_max),(s=YFM.Math.Plane.distance(this.t_max,t.center))<-r){i++;break}s>r?e++:0}while(!1);return 6==e?1:i>0?-1:0},frustumCheck:function(t){var i,e,r,s;i=0,e=0;do{if(r=this.effectiveRadius(t.near),(s=YFM.Math.Plane.distance(t.near,this.center))<-r){i++;break}if(s>r?e++:0,r=this.effectiveRadius(t.far),(s=YFM.Math.Plane.distance(t.far,this.center))<-r){i++;break}if(s>r?e++:0,r=this.effectiveRadius(t.left),(s=YFM.Math.Plane.distance(t.left,this.center))<-r){i++;break}if(s>r?e++:0,r=this.effectiveRadius(t.right),(s=YFM.Math.Plane.distance(t.right,this.center))<-r?i++:s>r?e++:0,r=this.effectiveRadius(t.bottom),(s=YFM.Math.Plane.distance(t.bottom,this.center))<-r){i++;break}if(s>r?e++:0,r=this.effectiveRadius(t.top),(s=YFM.Math.Plane.distance(t.top,this.center))<-r){i++;break}s>r?e++:0}while(!1);return 6==e?1:i>0?-1:0},effectiveRadius:function(t){return(Math.abs(YFM.Math.Vector.dot3(this.R,t))+Math.abs(YFM.Math.Vector.dot3(this.S,t))+Math.abs(YFM.Math.Vector.dot3(this.T,t)))/2},_reserse3:function(t){return t[0]=-t[0],t[1]=-t[1],t[2]=-t[2],t},_reserse4:function(t){return t[0]=-t[0],t[1]=-t[1],t[2]=-t[2],t[3]=-t[3],t},_calc_bounding:function(t){var i,e,r,s,o,a,h,n,u,l,c,M,g,d,p,f;for(a=Number.MAX_VALUE,h=-Number.MAX_VALUE,n=Number.MAX_VALUE,u=-Number.MAX_VALUE,l=Number.MAX_VALUE,c=-Number.MAX_VALUE,e=t.length,i=0;i<e;i++)p=t[i],r=YFM.Math.Vector.dot3(p,this.r),s=YFM.Math.Vector.dot3(p,this.s),o=YFM.Math.Vector.dot3(p,this.t),r>h&&(h=r),r<a&&(a=r),s>u&&(u=s),s<n&&(n=s),o>c&&(c=o),o<l&&(l=o);if(this.r_min=YFM.Math.Plane.planeRaw(this.r[0],this.r[1],this.r[2],-a),this.r_max=YFM.Math.Plane.planeRaw(-this.r[0],-this.r[1],-this.r[2],h),this.s_min=YFM.Math.Plane.planeRaw(this.s[0],this.s[1],this.s[2],-n),this.s_max=YFM.Math.Plane.planeRaw(-this.s[0],-this.s[1],-this.s[2],u),this.t_min=YFM.Math.Plane.planeRaw(this.t[0],this.t[1],this.t[2],-l),this.t_max=YFM.Math.Plane.planeRaw(-this.t[0],-this.t[1],-this.t[2],c),M=(a+h)/2,g=(n+u)/2,d=(l+c)/2,this.r_half=YFM.Math.Plane.planeRaw(this.r[0],this.r[1],this.r[2],-M),this.s_half=YFM.Math.Plane.planeRaw(this.s[0],this.s[1],this.s[2],-g),this.t_half=YFM.Math.Plane.planeRaw(this.t[0],this.t[1],this.t[2],-d),this.hr=(h-a)/2,this.hs=(u-n)/2,this.ht=(c-l)/2,this.R=YFM.Math.Vector.scale(this.r,h-a),this.S=YFM.Math.Vector.scale(this.s,u-n),this.T=YFM.Math.Vector.scale(this.t,c-l),!(f=YFM.Math.Plane.intersectionTriplePlane(this.r_half,this.s_half,this.t_half)).atAPoint)throw new Error("obb calc center failed");this.center=f.point}},TextBlockQuickCheckTree.prototype={constructor:TextBlockQuickCheckTree,reset:function(){this.blockPool=this.blockList,this.blockList=[],this.root.reset()},check:function(t,i,e,r){var s=this.root.check(t,i,e,r);return s||this.root.insert(t,i,e,r),s}},AABBNode.prototype={constructor:AABBNode,reset:function(){this.objList=[],this.children&&(this.children[0].reset(),this.children[1].reset(),this.children[2].reset(),this.children[3].reset())},insert:function(t,i,e,r){if(this._containBox(this.rect,t,i,e,r)){if(this.children){var s=!1;do{if(this.children[0].insert(t,i,e,r))break;if(this.children[1].insert(t,i,e,r))break;if(this.children[2].insert(t,i,e,r))break;if(this.children[3].insert(t,i,e,r))break;s=!0}while(!1);s&&this._insertBlock(t,i,e,r)}else this._insertBlock(t,i,e,r);return!0}return!1},check:function(t,i,e,r){if(!this._intersectBox(this.rect,t,i,e,r))return!1;for(var s=0,o=this.objList.length;s<o;s++)if(this._intersectBox(this.objList[s],t,i,e,r))return!0;if(this.children){if(this.children[0].check(t,i,e,r))return!0;if(this.children[1].check(t,i,e,r))return!0;if(this.children[2].check(t,i,e,r))return!0;if(this.children[3].check(t,i,e,r))return!0}return!1},_insertBlock:function(t,i,e,r){var s;this.tree.blockPool.length>0?((s=this.tree.blockPool.pop())[0]=t,s[1]=i,s[2]=e,s[3]=r):s=new Array(t,i,e,r),this.objList.push(s),this.tree.blockList.push(s)},_intersectBox:function(t,i,e,r,s){return!(i>t[2]||r<t[0]||e>t[3]||s<t[1])},_containBox:function(t,i,e,r,s){return i>=t[0]&&e>=t[1]&&r<=t[2]&&s<=t[3]},_splite:function(){this.children=new Array(4);var t=(this.rect[0]+this.rect[2])/2,i=(this.rect[1]+this.rect[3])/2;this.children[0]=new AABBNode(this.tree,this.mask+"0",this.rect[0],this.rect[1],t,i),this.children[1]=new AABBNode(this.tree,this.mask+"1",t,this.rect[1],this.rect[2],i),this.children[2]=new AABBNode(this.tree,this.mask+"2",t,i,this.rect[2],this.rect[3]),this.children[3]=new AABBNode(this.tree,this.mask+"3",this.rect[0],i,t,this.rect[3])}},MtlItem.prototype={constructor:MtlItem,setNs:function(t){this.Ns=t},setKa:function(t,i,e){this.Ka[0]=t,this.Ka[1]=i,this.Ka[2]=e},setKd:function(t,i,e){this.Kd[0]=t,this.Kd[1]=i,this.Kd[2]=e},setKs:function(t,i,e){this.Ks[0]=t,this.Ks[1]=i,this.Ks[2]=e},setMapKd:function(t){this.mapKd=t},getNs:function(){return this.Ns},getKa:function(){return this.Ka},getKd:function(){return this.Kd},getKs:function(){return this.Ks},getMapKd:function(){return this.mapKd}},YFM.Mesh.ObjModel={},YFM.Mesh.ObjModel.VPattern=/v( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/,YFM.Mesh.ObjModel.NPattern=/vn( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/,YFM.Mesh.ObjModel.UVPattern=/vt( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/,YFM.Mesh.ObjModel.FacePattern1=/f( +-?\d+)( +-?\d+)( +-?\d+)( +-?\d+)?/,YFM.Mesh.ObjModel.FacePattern2=/f( +(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+))?/,YFM.Mesh.ObjModel.FacePattern3=/f( +(-?\d+)\/(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+)\/(-?\d+))?/,YFM.Mesh.ObjModel.FacePattern4=/f( +(-?\d+)\/\/(-?\d+))( +(-?\d+)\/\/(-?\d+))( +(-?\d+)\/\/(-?\d+))( +(-?\d+)\/\/(-?\d+))?/,YFM.Mesh.ObjModel.NsPattern=/Ns( +[\d|\.|\+|\-|e|E]+)/,YFM.Mesh.ObjModel.KaPattern=/Ka( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/,YFM.Mesh.ObjModel.KdPattern=/Kd( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/,YFM.Mesh.ObjModel.KsPattern=/Ks( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/,ObjModel.prototype={constructor:ObjModel,setFloor:function(t){this.floor=t},setModelMatrix:function(t){this.modelMatrix=t;var i=YFM.Math.Matrix.mul(this.floor.getFloorMat(),this.modelMatrix);this.obb.transform(i)},render:function(t,i){var e=YFM.Math.Matrix.mul(i,this.modelMatrix),r=YFM.Math.Matrix.transpose(e),s=YFM.Math.Matrix.invert(r);t.setNormalMatrix(s),t.setModelMatrix(this.modelMatrix);for(var o=0,a=this.objects.length;o<a;o++)this.hasMaterials&&this.objects[o].material.mtl?t.setMTL(this.objects[o].material.mtl,this.texturePool):t.setDefaultMTL(),t.drawTriangles(this.objects[o].mesh)},loadURLDir:function(t,i,e,r){this.baseUrl=t;var s,o,a=this;s=t+"/"+i+".mtl",o=t+"/"+i+".obj";var h=new XMLHttpRequest;h.open("GET",s,!0),h.responseType="text",h.onload=function(t){if(200==this.status){a._parseMtl(this.response);var i=new XMLHttpRequest;i.open("GET",o,!0),i.responseType="text",i.onload=function(t){200==this.status?(a._parseObj(this.response),e&&e(a),a.hasMaterials=!0):r&&r(this.status)},i.send()}else r&&r(this.status)},h.send()},loadURLWithMtl:function(t,i,e,r){this.baseUrl=i.substr(0,i.lastIndexOf("/")+1);var s=this,o=new XMLHttpRequest;o.open("GET",i,!0),o.responseType="text",o.onload=function(i){if(200==this.status){s._parseMtl(this.response);var o=new XMLHttpRequest;o.open("GET",t,!0),o.responseType="text",o.onload=function(t){200==this.status?(s._parseObj(this.response),e&&e(s),s.hasMaterials=!0):r&&r(this.status)},o.send()}else r&&r(this.status)},o.send()},loadURL:function(t,i,e){this.baseUrl=t.substr(0,t.lastIndexOf("/")+1);var r=this,s=new XMLHttpRequest;s.open("GET",t,!0),s.responseType="text",s.onload=function(t){200==this.status?(r._parseObj(this.response),i&&i(r)):e&&e(this.status)},s.send()},_parseMtl:function(t){for(var i,e=t.split("\n"),r=0;r<e.length;r++){var s,o=e[r];if(0!==(o=o.trim()).length&&"#"!==o.charAt(0))if(/^newmtl /.test(o)){var a=o.substring(7).trim();i=new MtlItem,this.materials[a]=i}else if(/^map_Kd /.test(o)){var h=o.substring(7).trim();i.setMapKd(h),this.texturePool.addTexture(h,this.baseUrl+"/"+h)}else null!==(s=YFM.Mesh.ObjModel.NsPattern.exec(o))?i.setNs(parseFloat(s[1])):null!==(s=YFM.Mesh.ObjModel.KaPattern.exec(o))?i.setKa(parseFloat(s[1]),parseFloat(s[2]),parseFloat(s[3])):null!==(s=YFM.Mesh.ObjModel.KdPattern.exec(o))?i.setKd(parseFloat(s[1]),parseFloat(s[2]),parseFloat(s[3])):null!==(s=YFM.Mesh.ObjModel.KsPattern.exec(o))&&i.setKs(parseFloat(s[1]),parseFloat(s[2]),parseFloat(s[3]))}},_parseObj:function(t){function i(t){var i=parseInt(t);return 3*(i>=0?i-1:i+c.length/3)}function e(t){var i=parseInt(t);return 3*(i>=0?i-1:i+M.length/3)}function r(t){var i=parseInt(t);return 2*(i>=0?i-1:i+g.length/2)}function s(t,i,e){u.vertices.push(c[t],c[t+1],c[t+2],c[i],c[i+1],c[i+2],c[e],c[e+1],c[e+2])}function o(t,i,e){u.normals.push(M[t],M[t+1],M[t+2],M[i],M[i+1],M[i+2],M[e],M[e+1],M[e+2])}function a(t,i,e){u.uvs.push(g[t],g[t+1],g[i],g[i+1],g[e],g[e+1])}function h(t,h,n,u,l,c,M,g,d,p,f,m){var v=i(t),F=i(h),x=i(n);if(void 0===u?s(v,F,x):(s(v,F,_=i(u)),s(F,x,_)),void 0!==l){var v=r(l),F=r(c),x=r(M);void 0===u?a(v,F,x):(a(v,F,_=r(g)),a(F,x,_))}if(void 0!==d){var v=e(d),F=e(p),x=e(f);if(void 0===u)o(v,F,x);else{var _=e(m);o(v,F,_),o(F,x,_)}}}var n,u,l,c=[],M=[],g=[];!1===/^o /gm.test(t)&&(n={name:"",geometry:u={vertices:[],normals:[],uvs:[]},material:l={name:""}},this.objects.push(n));for(var d=t.split("\n"),p=0;p<d.length;p++){var f,m=d[p];0!==(m=m.trim()).length&&"#"!==m.charAt(0)&&(null!==(f=YFM.Mesh.ObjModel.VPattern.exec(m))?c.push(parseFloat(f[1]),parseFloat(f[2]),parseFloat(f[3])):null!==(f=YFM.Mesh.ObjModel.NPattern.exec(m))?M.push(parseFloat(f[1]),parseFloat(f[2]),parseFloat(f[3])):null!==(f=YFM.Mesh.ObjModel.UVPattern.exec(m))?g.push(parseFloat(f[1]),parseFloat(f[2])):null!==(f=YFM.Mesh.ObjModel.FacePattern1.exec(m))?h(f[1],f[2],f[3],f[4]):null!==(f=YFM.Mesh.ObjModel.FacePattern2.exec(m))?h(f[2],f[5],f[8],f[11],f[3],f[6],f[9],f[12]):null!==(f=YFM.Mesh.ObjModel.FacePattern3.exec(m))?h(f[2],f[6],f[10],f[14],f[3],f[7],f[11],f[15],f[4],f[8],f[12],f[16]):null!==(f=YFM.Mesh.ObjModel.FacePattern4.exec(m))?h(f[2],f[5],f[8],f[11],void 0,void 0,void 0,void 0,f[3],f[6],f[9],f[12]):/^o /.test(m)?(u={vertices:[],normals:[],uvs:[]},l={name:""},n={name:m.substring(2).trim(),geometry:u,material:l},this.objects.push(n)):/^g /.test(m)||(/^usemtl /.test(m)?(l.name=m.substring(7).trim(),l.mtl=this.materials[l.name]):/^mtllib /.test(m)||/^s /.test(m)))}for(var p=0,v=this.objects.length;p<v;p++){var F=this.objects[p],x=F.geometry,_=new MeshBuffer(this.gl);_.addAttribute("position",x.vertices,3),x.normals.length>0&&_.addAttribute("normal",x.normals,3),x.uvs.length>0&&_.addAttribute("uv",x.uvs,2),F.mesh=_}for(var Y=[],p=0,v=this.objects.length;p<v;p++){for(var R=0,y=(c=this.objects[p].geometry.vertices).length/3;R<y;R++)Y.push(YFM.Math.Vector.pos(c[3*R+0],c[3*R+1],c[3*R+2]));delete this.objects[p].geometry}this.obb=new OBB(Y)}},CameraRaw.prototype={constructor:CameraRaw,setPerspective:function(t,i,e,r){this.mat_projection=YFM.Math.Matrix.perspective(t,i,e,r),this.dirty=!0},setOrthographic:function(t,i,e,r,s,o){this.mat_projection=YFM.Math.Matrix.orthographic(t,i,e,r,s,o),this.dirty=!0},getProjectionMat:function(){return this.mat_projection},getPVMat:function(){return this.dirty&&(this.updateViewMat(),this.dirty=!1),this.mat_pv},getIPVMat:function(){return this.dirty&&(this.updateViewMat(),this.dirty=!1),this.mat_ipv},getViewMat:function(){return this.dirty&&(this.updateViewMat(),this.dirty=!1),this.mat_view},getIViewMat:function(){return this.dirty&&(this.updateViewMat(),this.dirty=!1),this.mat_iv},setViewOffset:function(t,i,e){this.mat_t_view=YFM.Math.Matrix.translate(t,i,e),this.dirty=!0},setViewBaseTranslate:function(t,i,e,r){var s=YFM.Math.Vector.vec(i,e,r),o=YFM.Math.Matrix.rotate3d(t,0,0,1);s=YFM.Math.Matrix.mulVec(o,s),this.mat_base_view=YFM.Math.Matrix.postTranslate(o,-s[0],-s[1],-s[2]),this.dirty=!0},setViewBaseTranslateQu:function(t,i,e,r){var s=YFM.Math.Vector.vec(i,e,r),o=YFM.Math.Matrix.rotationFromQuaternion(t);s=YFM.Math.Matrix.mulVec(o,s),this.mat_base_view=YFM.Math.Matrix.postTranslate(o,-s[0],-s[1],-s[2]),this.dirty=!0},postViewTranslate:function(t,i,e){this.mat_t_view=YFM.Math.Matrix.postTranslate(this.mat_t_view,t,i,e),this.dirty=!0},postViewRotate:function(t,i,e,r){this.mat_r_view=YFM.Math.Matrix.postRotate3d(this.mat_r_view,t,i,e,r),this.dirty=!0},postViewPitch:function(t,i){var e=YFM.Math.Matrix.postTranslate(YFM.Math.Matrix.postRotate3d(YFM.Math.Matrix.translate(-i[0],-i[1],-i[2]),t,1,0,0),i[0],i[1],i[2]);this.mat_r_view=YFM.Math.Matrix.mul(this.mat_r_view,e),this.dirty=!0},updateViewMat:function(){this.mat_view=YFM.Math.Matrix.mul(this.mat_t_view,YFM.Math.Matrix.mul(this.mat_r_view,this.mat_base_view)),this.mat_pv=YFM.Math.Matrix.mul(this.mat_projection,this.mat_view),this.mat_ipv=YFM.Math.Matrix.invert(this.mat_pv),this.mat_iv=YFM.Math.Matrix.invert(this.mat_view),this.mat_iv[12]=0,this.mat_iv[13]=0,this.mat_iv[14]=0,this.dirty=!1}},DeviceOrientationCamera.prototype={constructor:DeviceOrientationCamera,DEFAULT_PITCH:-30,setPerspective:function(t,i,e,r){this.mat_projection=YFM.Math.Matrix.perspective(t,i,e,r),this.dirty=!0},setOrthographic:function(t,i,e,r,s,o){this.mat_projection=YFM.Math.Matrix.orthographic(t,i,e,r,s,o),this.dirty=!0},getProjectionMat:function(){return this.mat_projection},getProjectionMatWithLDS:function(t,i){var e=YFM.Math.Matrix.matClone(this.mat_projection),r=LDS.halton(2,this.ldsIndex),s=LDS.halton(3,this.ldsIndex);return e[8]+=(r-.5)/t,e[9]+=(s-.5)/i,this.ldsIndex+=1,this.ldsIndex>this.ldsN&&(this.ldsIndex=0),e},getProjectionMatWithRGSS:function(t,i,e){var r=YFM.Math.Matrix.matClone(this.mat_projection),s=this.rgss[t][0],o=this.rgss[t][1];return r[8]+=(2*s-1)/i,r[9]+=(2*o-1)/e,r},getPVMat:function(){return this.dirty&&this._updateViewMat(),this.mat_pv},getIPVMat:function(){return this.dirty&&this._updateViewMat(),this.mat_ipv},getViewMat:function(){return this.dirty&&this._updateViewMat(),this.mat_view},getRoll:function(){return this.roll},getPitch:function(){return this.pitch},setPitch:function(t){this.pitch=t,this.dirty=!0},getEyePos:function(){return this.eyePos},getLookAt:function(){return YFM.Math.Vector.vecClone(this.lookAt)},getAzimuth:function(){var t=YFM.Math.Matrix.rotationFromQuaternion(this.quaternion);return-YFM.Math.Matrix.eulerParamExtractZ(t)},setAzimuth:function(t){this.quaternion.setFromAxisAngle(this.zee,t),this.dirty=!0},setLookAtAzimuth:function(t,i,e,r){this.quaternion.setFromAxisAngle(this.zee,t),this.lookAt[0]=i,this.lookAt[1]=e,this.lookAt[2]=r,this.dirty=!0},setLookAt:function(t,i,e){this.lookAt[0]=t,this.lookAt[1]=i,this.lookAt[2]=e,this.dirty=!0},getLookAt:function(){return YFM.Math.Vector.vecClone(this.lookAt)},getLookOffset:function(){return YFM.Math.Vector.vecClone(this.lookOffset)},getLookOffsetNormal:function(){return this.lookOffset[2]},setLookOffset:function(t,i,e){this.lookOffset[0]=t,this.lookOffset[1]=i,this.lookOffset[2]=e,this.dirty=!0},resetLookOffsetTan:function(){this.lookOffset[0]=0,this.lookOffset[1]=0,this.dirty=!0},_updaeQuaternion:function(){if(!1!==this.enabled&&null!=this.deviceOrientation){var t=YFM.Math.deg2Radian,i=this.deviceOrientation.alpha?t(this.deviceOrientation.alpha)+this.alphaOffsetAngle:0,e=this.deviceOrientation.beta?t(this.deviceOrientation.beta):0,r=this.deviceOrientation.gamma?t(this.deviceOrientation.gamma):0,s=this.screenOrientation?t(this.screenOrientation):0,o=new Euler(e,i,-r,"YXZ");this.q2.setFromAxisAngle(this.zee,-s),this.quaternion.setFromEuler(o),this.quaternion.premultiply(this.q0),this.quaternion.multiply(this.q1),this.quaternion.multiply(this.q2),this.roll=this.deviceOrientation.gamma?this.deviceOrientation.gamma:0}},_updateViewMat:function(){this._updaeQuaternion();var t=YFM.Math.Matrix.rotationFromQuaternion(this.quaternion),i=YFM.Math.Matrix.mulVec(t,this.lookAt);t=YFM.Math.Matrix.postTranslate(t,-i[0],-i[1],-i[2]);var e=YFM.Math.Matrix.translate(this.lookOffset[0],this.lookOffset[1],this.lookOffset[2]);if(this.pitchEnable){var r=YFM.Math.Matrix.rotate3d(this.pitch,1,0,0);this.mat_view=YFM.Math.Matrix.mul(e,YFM.Math.Matrix.mul(r,t))}else this.mat_view=YFM.Math.Matrix.mul(e,t);this.mat_pv=YFM.Math.Matrix.mul(this.mat_projection,this.mat_view),this.mat_ipv=YFM.Math.Matrix.invert(this.mat_pv),this.dirty=!1}},BaseColorProgram.prototype={constructor:BaseColorProgram,useProgram:function(){this.gl.useProgram(this.program)},drawTriangles:function(t,i){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!1,24,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.vertexAttribPointer(this.aColor,3,this.gl.FLOAT,!1,24,12),this.gl.enableVertexAttribArray(this.aColor),this.gl.drawArrays(this.gl.TRIANGLES,0,i)},drawLines:function(t,i,e){null!=e&&this.gl.lineWidth(e),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!1,24,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.vertexAttribPointer(this.aColor,3,this.gl.FLOAT,!1,24,12),this.gl.enableVertexAttribArray(this.aColor),this.gl.drawArrays(this.gl.LINES,0,i),null!=e&&this.gl.lineWidth(1)},getProgram:function(){return this.program},setMapHeight:function(t){this.gl.uniform1f(this.uMapHeight,t)},setProjectionMatrix:function(t){this.gl.uniformMatrix4fv(this.uProjectionMat,!1,YFM.Math.flatten(t))},setViewMatrix:function(t){this.gl.uniformMatrix4fv(this.uViewMat,!1,YFM.Math.flatten(t))},setRegionMatrix:function(t){this.gl.uniformMatrix4fv(this.uRegionMat,!1,YFM.Math.flatten(t))},setFloorMatrix:function(t){this.gl.uniformMatrix4fv(this.uFloorMat,!1,YFM.Math.flatten(t))},setModelMatrix:function(t){this.gl.uniformMatrix4fv(this.uModelMat,!1,YFM.Math.flatten(t))},vshader:"attribute  vec4 aPosition;\nattribute  vec4 aColor;\nuniform mat4 uModelMat;\nuniform mat4 uFloorMat;\nuniform mat4 uRegionMat;\nuniform mat4 uViewMat;\nuniform mat4 uProjectionMat;\nuniform float uMapHeight;\nvarying vec4 vColor;\nvoid main()\n{\n\tvec4 pos = vec4(aPosition.x, uMapHeight-aPosition.y, aPosition.z, 1.0);\n\tgl_Position = uProjectionMat*uViewMat*uRegionMat*uFloorMat*uModelMat*pos;\n\tvColor = aColor;\n}\n",fshader:"precision mediump float;\nvarying vec4 vColor;\nvoid main()\n{\n\tgl_FragColor = vColor;\n}\n"},BasePhongProgram.prototype={constructor:BasePhongProgram,useProgram:function(){this.gl.useProgram(this.program)},drawTriangles:function(t,i){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!1,36,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.vertexAttribPointer(this.aColor,3,this.gl.FLOAT,!1,36,12),this.gl.enableVertexAttribArray(this.aColor),this.gl.vertexAttribPointer(this.aNormal,3,this.gl.FLOAT,!1,36,24),this.gl.enableVertexAttribArray(this.aNormal),this.gl.drawArrays(this.gl.TRIANGLES,0,i)},drawLines:function(t,i,e){null!=e&&this.gl.lineWidth(e),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!0,36,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.vertexAttribPointer(this.aColor,3,this.gl.FLOAT,!1,36,12),this.gl.enableVertexAttribArray(this.aColor),this.gl.vertexAttribPointer(this.aNormal,3,this.gl.FLOAT,!1,36,24),this.gl.enableVertexAttribArray(this.aNormal),this.gl.drawArrays(this.gl.LINES,0,i),null!=e&&this.gl.lineWidth(1)},getProgram:function(){return this.program},setLightPos:function(t){this.gl.uniform4fv(this.uLightPos,t)},setLighting:function(t){this.gl.uniform1i(this.uLighting,t)},setMapHeight:function(t){this.gl.uniform1f(this.uMapHeight,t)},setNormalMatrix:function(t){this.gl.uniformMatrix4fv(this.uNormalMat,!1,YFM.Math.flatten(t))},setProjectionMatrix:function(t){this.gl.uniformMatrix4fv(this.uProjectionMat,!1,YFM.Math.flatten(t))},setViewMatrix:function(t){this.gl.uniformMatrix4fv(this.uViewMat,!1,YFM.Math.flatten(t))},setRegionMatrix:function(t){this.gl.uniformMatrix4fv(this.uRegionMat,!1,YFM.Math.flatten(t))},setFloorMatrix:function(t){this.gl.uniformMatrix4fv(this.uFloorMat,!1,YFM.Math.flatten(t))},setModelMatrix:function(t){this.gl.uniformMatrix4fv(this.uModelMat,!1,YFM.Math.flatten(t))},vshader:"attribute vec4 aPosition;  \nattribute vec4 aNormal;    \nattribute vec4 aColor;     \nuniform int    uLighting;  \nuniform float  uMapHeight; \nuniform mat4   uModelMat;  \nuniform mat4   uFloorMat;  \nuniform mat4   uRegionMat; \nuniform mat4   uViewMat;   \nuniform mat4   uProjMat;   \nuniform mat4   uNormalMat; \nuniform vec4   uLightPos;  \nvarying vec4   vColor;     \n                           \nvoid main(){               \n   vec4 tPos = vec4(aPosition.x, uMapHeight-aPosition.y, aPosition.z, 1.0);\n   mat4 modelViewMatrix = uViewMat*uRegionMat*uFloorMat*uModelMat;\n   if(1 == uLighting){\n       float shininess = 320.0;                                 \n       vec4 ambient, diffuse, specular;                        \n       vec4 ambientProduct = vec4(0.3, 0.3, 0.3, 1.0 );        \n       vec4 diffuseProduct = vec4(1.0, 1.0, 1.0, 1.0 );        \n       vec4 specularProduct= vec4(0.1, 0.1, 0.1, 1.0 );        \n                                                               \n       vec3 pos = (modelViewMatrix * tPos).xyz;                \n       vec3 L = normalize((uViewMat*uLightPos).xyz);           \n       vec3 E = -normalize(pos );                              \n       vec3 H = normalize(L + E );                             \n       vec3 N = normalize((uNormalMat*aNormal).xyz);           \n       ambient = ambientProduct;                               \n       float Kd = max( dot(L, N), 0.0 );                       \n       diffuse = Kd*diffuseProduct;                            \n       float Ks = pow(max(dot(N, H), 0.0), shininess);         \n       specular = Ks * specularProduct;                        \n       if(dot(L, N) < 0.0) {                                   \n           specular = vec4(0.0, 0.0, 0.0, 1.0);                \n       }                                                       \n       vColor = aColor*ambient+aColor*diffuse + aColor*specular;\n   }else{                                                  \n       vColor = aColor;                                    \n   }                                                       \n   gl_Position = uProjMat * modelViewMatrix * tPos;        \n}\n",fshader:"precision mediump float;                                   \nvarying vec4                   vColor;                     \nvoid main() {                                              \n       gl_FragColor = vColor;                              \n}\n"},BillboardIconProgram.prototype={constructor:BillboardIconProgram,useProgram:function(){this.gl.useProgram(this.program)},bindTexture:function(t){this.gl.activeTexture(this.gl.TEXTURE0),this.gl.uniform1i(this.uTex,0),this.gl.bindTexture(this.gl.TEXTURE_2D,t)},drawTriangles:function(t,i,e){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!0,24,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.vertexAttribPointer(this.aTexCoord,3,this.gl.FLOAT,!1,24,12),this.gl.enableVertexAttribArray(this.aTexCoord),this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.drawArrays(this.gl.TRIANGLES,e,i),this.gl.disable(this.gl.BLEND)},setProjectionMatrix:function(t){this.gl.uniformMatrix4fv(this.uProjectionMat,!1,YFM.Math.flatten(t))},setViewMatrix:function(t){this.gl.uniformMatrix4fv(this.uViewMat,!1,YFM.Math.flatten(t))},setIViewMatrix:function(t){this.gl.uniformMatrix4fv(this.uiViewMat,!1,YFM.Math.flatten(t))},setRegionMatrix:function(t){this.gl.uniformMatrix4fv(this.uRegionMat,!1,YFM.Math.flatten(t))},setModelMatrix:function(t){this.gl.uniformMatrix4fv(this.uModelMat,!1,YFM.Math.flatten(t))},vshader:"attribute vec4  aPosition; \nattribute vec3  aTexCoord; \nvarying vec3 vTexCoord;    \nuniform mat4   uModelMat;  \nuniform mat4   uRegionMat; \nuniform mat4   uiViewMat;  \nuniform mat4   uViewMat;   \nuniform mat4   uProjMat;   \nvoid main( void ) {                            \n    vTexCoord = aTexCoord;                     \n    gl_Position = uProjMat*uViewMat*uRegionMat*uModelMat*uiViewMat*aPosition;\n}\n",fshader:"precision mediump float;                       \nvarying vec3 vTexCoord;                        \nuniform sampler2D uTex;                        \nvoid main() {                                  \n   gl_FragColor = texture2D(uTex, vTexCoord.xy);  \n}\n"},Color2DProgram.prototype={constructor:Color2DProgram,useProgram:function(){this.gl.useProgram(this.program)},drawTriangles:function(t,i,e,r){this.gl.uniform4fv(this.uColor,YFM.Math.flatten(i)),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!1,12,e),this.gl.enableVertexAttribArray(this.aPosition),this.gl.drawArrays(this.gl.TRIANGLES,0,r)},setProjectionMatrix:function(t){this.gl.uniformMatrix4fv(this.uProjectionMat,!1,YFM.Math.flatten(t))},setModelMatrix:function(t){this.gl.uniformMatrix4fv(this.uModelMat,!1,YFM.Math.flatten(t))},vshader:"attribute vec4 aPosition;\nuniform mat4   uModelMat;\nuniform mat4   uProjMat;\nuniform vec4   uColor;\nvarying vec4   vColor;\nvoid main( void ) {                            \n    gl_Position = uProjMat*uModelMat*aPosition;\n    vColor = uColor;                           \n}\n",fshader:"precision mediump float;                       \nvarying vec4   vColor;                         \nvoid main() {                                  \n   gl_FragColor = vColor;                      \n}\n"},Marker2DProgram.prototype={constructor:Marker2DProgram,useProgram:function(){this.gl.useProgram(this.program)},bindTexture:function(t){this.gl.activeTexture(this.gl.TEXTURE0),this.gl.uniform1i(this.uTex,0),this.gl.bindTexture(this.gl.TEXTURE_2D,t)},drawTriangles:function(t,i,e){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!1,24,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.vertexAttribPointer(this.aTexCoord,3,this.gl.FLOAT,!1,24,12),this.gl.enableVertexAttribArray(this.aTexCoord),this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.drawArrays(this.gl.TRIANGLES,e,i),this.gl.disable(this.gl.BLEND)},setProjectionMatrix:function(t){this.gl.uniformMatrix4fv(this.uProjectionMat,!1,YFM.Math.flatten(t))},setModelMatrix:function(t){this.gl.uniformMatrix4fv(this.uModelMat,!1,YFM.Math.flatten(t))},vshader:"attribute vec4  aPosition; \nattribute vec3  aTexCoord; \nuniform mat4   uModelMat;  \nuniform mat4   uProjMat;   \nvarying vec3   vTexCoord;  \nvoid main( void ) {                            \n    vTexCoord = aTexCoord;                     \n    gl_Position = uProjMat*uModelMat*aPosition;\n}\n",fshader:"precision mediump float;                       \nvarying vec3 vTexCoord;                        \nuniform sampler2D uTex;                        \nvoid main() {                                  \n   gl_FragColor = texture2D(uTex, vTexCoord.xy);  \n}\n"},ModelPhongProgram.prototype={constructor:ModelPhongProgram,useProgram:function(){this.gl.useProgram(this.program)},drawLines:function(t,i,e,r){this.gl.uniform1f(this.uNs,this.defaultNs),this.gl.uniform4fv(this.uKa,this.defaultKa),this.gl.uniform4fv(this.uKd,this.defaultKd),this.gl.uniform4fv(this.uKs,this.defaultKs),this.gl.uniform1i(this.uTexFlag,0),this.gl.uniform1i(this.uColorFlag,1),this.gl.uniform4fv(this.uColor,i),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!0,12,e),this.gl.enableVertexAttribArray(this.aPosition),this.gl.drawArrays(this.gl.LINES,0,r)},drawTriangles:function(t){var i,e,r;i=t.getAttribute("position"),e=t.getAttribute("normal"),r=t.getAttribute("uv"),null!==i?(this.gl.bindBuffer(this.gl.ARRAY_BUFFER,i.vbo),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!1,12,0),this.gl.enableVertexAttribArray(this.aPosition)):this.gl.disableVertexAttribArray(this.aPosition),null!=e?(this.gl.bindBuffer(this.gl.ARRAY_BUFFER,e.vbo),this.gl.vertexAttribPointer(this.aNormal,3,this.gl.FLOAT,!1,12,0),this.gl.enableVertexAttribArray(this.aNormal)):this.gl.disableVertexAttribArray(this.aNormal),null!=r?(this.gl.bindBuffer(this.gl.ARRAY_BUFFER,r.vbo),this.gl.vertexAttribPointer(this.aTexCoord,2,this.gl.FLOAT,!1,8,0),this.gl.enableVertexAttribArray(this.aTexCoord)):this.gl.disableVertexAttribArray(this.aTexCoord),this.gl.drawArrays(this.gl.TRIANGLES,0,i.length)},setTexFlag:function(t){this.gl.uniform1i(this.uTexFlag,t)},bindTexture:function(t){this.gl.activeTexture(this.gl.TEXTURE0),this.gl.uniform1i(this.uTex,0),this.gl.bindTexture(this.gl.TEXTURE_2D,t)},setMTL:function(t,i){if(this.gl.uniform1f(this.uNs,t.getNs()),this.gl.uniform4fv(this.uKa,YFM.Math.flatten(t.getKa())),this.gl.uniform4fv(this.uKd,YFM.Math.flatten(t.getKd())),this.gl.uniform4fv(this.uKs,YFM.Math.flatten(t.getKs())),null!==t.getMapKd()){var e=i.getTexture(t.getMapKd());if(null!=e)return this.gl.uniform1i(this.uTexFlag,1),this.gl.uniform1i(this.uColorFlag,0),void this.bindTexture(e.tex)}this.gl.uniform1i(this.uTexFlag,0),this.gl.uniform1i(this.uColorFlag,1),this.gl.uniform4fv(this.uColor,this.defaultColor)},setDefaultMTL:function(){this.gl.uniform1f(this.uNs,this.defaultNs),this.gl.uniform4fv(this.uKa,this.defaultKa),this.gl.uniform4fv(this.uKd,this.defaultKd),this.gl.uniform4fv(this.uKs,this.defaultKs),this.gl.uniform1i(this.uTexFlag,0),this.gl.uniform1i(this.uColorFlag,1),this.gl.uniform4fv(this.uColor,this.defaultColor)},setColorFlag:function(t){this.gl.uniform1i(this.uColorFlag,t)},setColor:function(t){this.gl.uniform4fv(this.uColor,t)},setLightPos:function(t){this.gl.uniform4fv(this.uLightPos,t)},setNormalMatrix:function(t){this.gl.uniformMatrix4fv(this.uNormalMat,!1,YFM.Math.flatten(t))},setProjectionMatrix:function(t){this.gl.uniformMatrix4fv(this.uProjectionMat,!1,YFM.Math.flatten(t))},setViewMatrix:function(t){this.gl.uniformMatrix4fv(this.uViewMat,!1,YFM.Math.flatten(t))},setRegionMatrix:function(t){this.gl.uniformMatrix4fv(this.uRegionMat,!1,YFM.Math.flatten(t))},setFloorMatrix:function(t){this.gl.uniformMatrix4fv(this.uFloorMat,!1,YFM.Math.flatten(t))},setModelMatrix:function(t){this.gl.uniformMatrix4fv(this.uModelMat,!1,YFM.Math.flatten(t))},vshader:"attribute vec4 aPosition;  \nattribute vec4 aNormal;    \nattribute vec3 aTexCoord;  \nuniform int    uTexFlag;   \nuniform float  uNs;        \nuniform vec4   uKa;        \nuniform vec4   uKd;        \nuniform vec4   uKs;        \nuniform mat4   uModelMat;  \nuniform mat4   uFloorMat;  \nuniform mat4   uRegionMat; \nuniform mat4   uViewMat;   \nuniform mat4   uProjMat;   \nuniform mat4   uNormalMat; \nuniform vec4   uLightPos;  \nvarying vec3   vTexCoord;  \nvarying vec4   vAmbient;   \nvarying vec4   vDiffuse;   \nvarying vec4   vSpecular;  \n                           \nvoid main(){               \n   mat4 modelViewMatrix = uViewMat*uRegionMat*uFloorMat*uModelMat;\n   vec3 pos = (modelViewMatrix * aPosition).xyz;           \n   vec3 L = normalize((uViewMat*uLightPos).xyz);           \n   vec3 E = -normalize(pos );                              \n   vec3 H = normalize(L + E );                             \n   vec3 N = normalize((uNormalMat*aNormal).xyz);           \n   vAmbient = uKa;                                         \n   vDiffuse = max(dot(L,N), 0.0)*uKd;                      \n   vec4 specular = pow(max(dot(N, H), 0.0), uNs)*uKs;      \n   if(dot(L, N) < 0.0) {                                   \n       specular = vec4(0.0, 0.0, 0.0, 1.0);                \n   }                                                       \n   vSpecular = specular;                                   \n   if(1 == uTexFlag)                                       \n       vTexCoord = aTexCoord;                              \n   else                                                    \n       vTexCoord = vec3(0.0, 0.0, 0.0);                    \n   gl_Position = uProjMat * modelViewMatrix * aPosition;   \n}\n",fshader:"precision mediump float;       \nuniform int        uColorFlag; \nuniform vec4       uColor;     \nuniform sampler2D  uTex;       \nvarying vec3       vTexCoord;  \nvarying vec4       vAmbient;   \nvarying vec4       vDiffuse;   \nvarying vec4       vSpecular;  \nvoid main() {                  \n       vec4 color;                                                     \n       if(1 == uColorFlag)                                             \n           color = uColor;                                             \n       else                                                            \n           color = texture2D(uTex, vTexCoord.xy);                      \n       gl_FragColor = color*vAmbient+color*vDiffuse+color*vSpecular;   \n}\n"},PointSpiritProgram.prototype={constructor:PointSpiritProgram,useProgram:function(){this.gl.useProgram(this.program)},bindTexture:function(t){this.gl.activeTexture(this.gl.TEXTURE0),this.gl.uniform1i(this.uTex,0),this.gl.bindTexture(this.gl.TEXTURE_2D,t)},drawPoints:function(t,i){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.drawArrays(this.gl.POINTS,0,i),this.gl.disable(this.gl.BLEND)},setProjectionMatrix:function(t){this.gl.uniformMatrix4fv(this.uProjectionMat,!1,YFM.Math.flatten(t))},setViewMatrix:function(t){this.gl.uniformMatrix4fv(this.uViewMat,!1,YFM.Math.flatten(t))},setRegionMatrix:function(t){this.gl.uniformMatrix4fv(this.uRegionMat,!1,YFM.Math.flatten(t))},vshader:"attribute vec4  aPosition; \nuniform mat4   uRegionMat; \nuniform mat4   uViewMat;   \nuniform mat4   uProjMat;   \nvoid main( void ) {                            \n    gl_Position = uProjMat*uViewMat*uRegionMat*aPosition;\n    gl_PointSize = 24.0;                        \n}\n",fshader:"precision mediump float;                       \nuniform sampler2D uTex;                        \nvoid main() {                                  \n   gl_FragColor = texture2D(uTex, gl_PointCoord);\n}\n"},RawPanoramaProgram.prototype={constructor:RawPanoramaProgram,useProgram:function(){this.gl.useProgram(this.program)},drawTriangles:function(t,i){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!1,12,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.drawArrays(this.gl.TRIANGLES,0,i)},getProgram:function(){return this.program},bindTexture:function(t){this.gl.activeTexture(this.gl.TEXTURE0),this.gl.uniform1i(this.uTexMap,0),this.gl.bindTexture(this.gl.TEXTURE_CUBE_MAP,t)},setProjectionMatrix:function(t){this.gl.uniformMatrix4fv(this.uProjectionMat,!1,YFM.Math.flatten(t))},setViewMatrix:function(t){this.gl.uniformMatrix4fv(this.uViewMat,!1,YFM.Math.flatten(t))},setModelMatrix:function(t){this.gl.uniformMatrix4fv(this.uModelMat,!1,YFM.Math.flatten(t))},vshader:"attribute  vec4 aPosition;\nuniform mat4 uModelMat;\nuniform mat4 uViewMat;\nuniform mat4 uProjectionMat;\nvarying vec3 V;\nvoid main()\n{\n\tgl_Position = uProjectionMat*uViewMat*uModelMat*aPosition;\n   V = normalize(vec3(aPosition.x, aPosition.y, aPosition.z));\n}\n",fshader:"precision mediump float;\nuniform samplerCube uTexMap;\nvarying vec3 V;\nvoid main()\n{\n\tgl_FragColor = textureCube(uTexMap, V);\n}\n"},RegionPhongProgram.prototype={constructor:RegionPhongProgram,useProgram:function(){this.gl.useProgram(this.program)},drawTriangles:function(t,i,e){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!1,24,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.vertexAttribPointer(this.aNormal,3,this.gl.FLOAT,!1,24,12),this.gl.enableVertexAttribArray(this.aNormal),this.gl.drawArrays(this.gl.TRIANGLES,e,i-e)},drawTrianglesPlus:function(t,i,e){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!1,24,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.vertexAttribPointer(this.aNormal,3,this.gl.FLOAT,!1,24,12),this.gl.enableVertexAttribArray(this.aNormal),this.gl.drawArrays(this.gl.TRIANGLES,i,e-i)},drawLines:function(t,i,e){null!=e&&this.gl.lineWidth(e),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!0,24,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.vertexAttribPointer(this.aNormal,3,this.gl.FLOAT,!1,24,12),this.gl.enableVertexAttribArray(this.aNormal),this.gl.drawArrays(this.gl.LINES,0,i),null!=e&&this.gl.lineWidth(1)},setColor:function(t){this.gl.uniform4fv(this.uColor,t)},setLightPos:function(t){this.gl.uniform4fv(this.uLightPos,t)},setNormalMatrix:function(t){this.gl.uniformMatrix4fv(this.uNormalMat,!1,YFM.Math.flatten(t))},setProjectionMatrix:function(t){this.gl.uniformMatrix4fv(this.uProjectionMat,!1,YFM.Math.flatten(t))},setViewMatrix:function(t){this.gl.uniformMatrix4fv(this.uViewMat,!1,YFM.Math.flatten(t))},setRegionMatrix:function(t){this.gl.uniformMatrix4fv(this.uRegionMat,!1,YFM.Math.flatten(t))},setModelMatrix:function(t){this.gl.uniformMatrix4fv(this.uModelMat,!1,YFM.Math.flatten(t))},vshader:"attribute vec4 aPosition;  \nattribute vec4 aNormal;    \nuniform vec4   uColor;     \nuniform mat4   uModelMat;  \nuniform mat4   uRegionMat; \nuniform mat4   uViewMat;   \nuniform mat4   uProjMat;   \nuniform mat4   uNormalMat; \nuniform vec4   uLightPos;  \nvarying vec4   vColor;     \n                           \nvoid main(){               \n   float shininess = 320.0;                                \n   vec4 ambient, diffuse, specular;                        \n   vec4 ambientProduct = vec4(0.5, 0.5, 0.5, 1.0 );        \n   vec4 diffuseProduct = vec4(1.0, 1.0, 1.0, 1.0 );        \n   vec4 specularProduct= vec4(0.2, 0.2, 0.2, 1.0 );        \n                                                           \n   mat4 modelViewMatrix = uViewMat*uRegionMat*uModelMat;   \n   vec3 pos = (modelViewMatrix * aPosition).xyz;           \n   vec3 L = normalize((uViewMat*uLightPos).xyz);           \n   vec3 E = -normalize(pos );                              \n   vec3 H = normalize(L + E );                             \n   vec3 N = normalize((uNormalMat*aNormal).xyz);           \n   ambient = ambientProduct;                               \n   float Kd = max( dot(L, N), 0.0 );                       \n   diffuse = Kd*diffuseProduct;                            \n   float Ks = pow(max(dot(N, H), 0.0), shininess);         \n   specular = Ks * specularProduct;                        \n   if(dot(L, N) < 0.0) {                                   \n       specular = vec4(0.0, 0.0, 0.0, 1.0);                \n   }                                                       \n   gl_Position = uProjMat * modelViewMatrix * aPosition;   \n   vColor = uColor*ambient+uColor*diffuse+uColor*specular; \n}\n",fshader:"precision mediump float;                                   \nvarying vec4                   vColor;                     \nvoid main() {                                              \n       gl_FragColor = vColor;                              \n}\n"},SSRProgram.prototype={constructor:SSRProgram,useProgram:function(){this.gl.useProgram(this.program)},bindTexture:function(t){this.gl.activeTexture(this.gl.TEXTURE0),this.gl.uniform1i(this.uTex,0),this.gl.bindTexture(this.gl.TEXTURE_2D,t)},drawTriangleStrip:function(t,i,e){var r=t.getAttribute("position"),s=t.getAttribute("uv");if(null!==r){if(r.length<=0)return;if(this.gl.bindBuffer(this.gl.ARRAY_BUFFER,r.vbo),this.gl.vertexAttribPointer(this.aPosition,r.size,this.gl.FLOAT,!1,4*r.size,0),this.gl.enableVertexAttribArray(this.aPosition),null!==s){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,s.vbo),this.gl.vertexAttribPointer(this.aTexCoord,2,this.gl.FLOAT,!1,8,0),this.gl.enableVertexAttribArray(this.aTexCoord);var o=e||r.length-i;this.gl.drawArrays(this.gl.TRIANGLE_STRIP,i,o)}}},setTime:function(t){this.gl.uniform1f(this.uTime,t)},setHH:function(t){this.gl.uniform1f(this.uHH,t)},setHW:function(t){this.gl.uniform1f(this.uHW,t)},setTranFlag:function(t){this.gl.uniform1i(this.uTranFlag,t)},vshader:"attribute  vec4 aPosition; \nattribute vec3  aTexCoord; \nuniform float uTime;       \nuniform float uHH;         \nuniform float uHW;         \nvarying vec3   vTexCoord;  \nvoid main(){               \n   gl_Position = vec4(aPosition.x/uHW, aPosition.y/uHH, aPosition.z, 1.0);\n   vTexCoord = vec3(aTexCoord.x, aTexCoord.y + uTime, 0.0);\n}\n",fshader:"precision mediump float;   \nvarying vec3 vTexCoord;    \nuniform int   uTranFlag;   \nuniform sampler2D uTex;    \nvoid main(){\n   vec4 c = texture2D(uTex, vTexCoord.xy);     \n   if(1 == uTranFlag)                          \n       gl_FragColor = c*vec4(0.3,0.3,0.3,0.3); \n   else                                        \n       gl_FragColor = c;                       \n}\n"},SelectColorProgram.prototype={constructor:SelectColorProgram,useProgram:function(){this.gl.useProgram(this.program)},drawTriangles:function(t,i,e,r){this.gl.uniform4fv(this.uColor,YFM.Math.flatten(i)),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!1,12,e),this.gl.enableVertexAttribArray(this.aPosition),this.gl.drawArrays(this.gl.TRIANGLES,0,r)},drawLines:function(t,i,e,r){this.gl.uniform4fv(this.uColor,YFM.Math.flatten(i)),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!0,12,e),this.gl.enableVertexAttribArray(this.aPosition),this.gl.drawArrays(this.gl.LINES,0,r)},getProgram:function(){return this.program},setProjectionMatrix:function(t){this.gl.uniformMatrix4fv(this.uProjectionMat,!1,YFM.Math.flatten(t))},setViewMatrix:function(t){this.gl.uniformMatrix4fv(this.uViewMat,!1,YFM.Math.flatten(t))},setRegionMatrix:function(t){this.gl.uniformMatrix4fv(this.uRegionMat,!1,YFM.Math.flatten(t))},setModelMatrix:function(t){this.gl.uniformMatrix4fv(this.uModelMat,!1,YFM.Math.flatten(t))},vshader:"attribute  vec4 aPosition;\nuniform vec4 uColor;\nuniform mat4 uModelMat;\nuniform mat4 uRegionMat;\nuniform mat4 uViewMat;\nuniform mat4 uProjectionMat;\nvarying vec4 vColor;\nvoid main()\n{\n\tgl_Position = uProjectionMat*uViewMat*uRegionMat*uModelMat*aPosition;\n\tvColor = uColor;\n}\n",fshader:"precision mediump float;\nvarying vec4 vColor;\nvoid main()\n{\n\tgl_FragColor = vColor;\n}\n"},TexturePool.prototype={constructor:TexturePool,addTexture:function(t,i){if(null!=this.pool[t])return!1;var e=new Image,r=new TextureWrap(t,i,e),s=this;e.crossOrigin="Anonymous",e.onload=function(){s._handleTextureLoaded(r)},e.src=i},addTextureMip:function(t,i){if(null!=this.pool[t])return!1;var e=new Image,r=new TextureWrap(t,i,e),s=this;e.crossOrigin="Anonymous",e.onload=function(){s._handleTextureLoadedMip(r)},e.src=i},getTexture:function(t){var i=this.pool[t];return null!=i?{tex:i.tex,w:i.w,h:i.h}:null},_handleTextureLoaded:function(t){this.pool[t.name]=t;var i=this.gl.createTexture();this.gl.bindTexture(this.gl.TEXTURE_2D,i),this.gl.pixelStorei(this.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,t.img),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.bindTexture(this.gl.TEXTURE_2D,null),t.tex=i,t.w=t.img.width,t.h=t.img.height,delete t.img},_handleTextureLoadedMip:function(t){this.pool[t.name]=t;var i=this.gl.createTexture();this.gl.bindTexture(this.gl.TEXTURE_2D,i),this.gl.pixelStorei(this.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,t.img),this.gl.generateMipmap(this.gl.TEXTURE_2D),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR_MIPMAP_LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.REPEAT),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.REPEAT),this.gl.bindTexture(this.gl.TEXTURE_2D,null),t.tex=i,t.w=t.img.width,t.h=t.img.height,delete t.img}},VAttribs.prototype={constructor:VAttribs,persistence:function(){var t={};for(var i in this.attributes){var e=this.attributes[i];t[i]={rawArray:e.rawArray,size:e.size,length:e.length,normalized:e.normalized}}return t},addAttributeFlat:function(t,i,e,r){var s=this.gl,o=r||!1,a=new Float32Array(i),h=s.createBuffer();s.bindBuffer(s.ARRAY_BUFFER,h),s.bufferData(s.ARRAY_BUFFER,a,s.STATIC_DRAW),s.bindBuffer(s.ARRAY_BUFFER,null),this.attributes[t]={vbo:h,flatArray:i,size:e,length:i.length/e,normalized:o}},addAttribute:function(t,i,e,r){var s=this.gl,o=r||!1,a=s.createBuffer(),h=YFM.Math.flatten(i,e);s.bindBuffer(s.ARRAY_BUFFER,a),s.bufferData(s.ARRAY_BUFFER,h,s.STATIC_DRAW),s.bindBuffer(s.ARRAY_BUFFER,null),this.attributes[t]={vbo:a,size:e,length:i.length,normalized:o}},updateAttribute:function(t,i){var e=this.gl,r=this.attributes[t];if(r){var s=YFM.Math.flatten(i,r.size);e.bindBuffer(e.ARRAY_BUFFER,r.vbo),e.bufferData(e.ARRAY_BUFFER,s,e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,null)}},getAttribute:function(t){return this.attributes[t]},recycle:function(){for(var t in this.attributes){var i=this.attributes[t].vbo,e=this.gl;setTimeout(function(){e.deleteBuffer(i)},2e3)}}};